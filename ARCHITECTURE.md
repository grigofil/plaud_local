# Новая архитектура Plaud Local

## Обзор

После полного рефакторинга кодовой базы была создана новая модульная структура проекта, следующая принципам SOLID и обеспечивающая низкую связность и высокую связанность компонентов.

## Структура проекта

```
plaud_local/
├── src/                    # Основной исходный код
│   ├── __init__.py        # Корневой пакет
│   ├── api/               # API слой
│   │   ├── __init__.py
│   │   ├── main.py        # Основное API приложение
│   │   └── dependencies.py # Зависимости авторизации
│   ├── config/            # Конфигурация
│   │   ├── __init__.py
│   │   └── settings.py    # Настройки приложения
│   ├── core/              # Основное ядро приложения
│   │   ├── __init__.py
│   │   └── main.py        # Основное приложение
│   ├── models/            # Модели данных
│   │   ├── __init__.py
│   │   └── user.py        # Модель пользователя
│   ├── services/          # Бизнес-логика
│   │   ├── __init__.py
│   │   ├── transcription_service.py # Сервис транскрипции
│   │   └── user_service.py          # Сервис пользователей
│   ├── tasks/             # Фоновые задачи
│   │   ├── __init__.py
│   │   ├── transcribe.py  # Задача транскрипции
│   │   └── summarize.py   # Задача суммаризации
│   ├── utils/             # Вспомогательные утилиты
│   │   ├── __init__.py
│   │   ├── auth.py        # Аутентификация
│   │   └── database.py    # Работа с базой данных
│   └── workers/           # Воркеры
│       ├── __init__.py
│       └── transcribe_server.py # Сервер транскрипции
├── api/                   # Статические файлы API
│   └── static/            # Веб-клиент
│       ├── index.html
│       └── register.html
├── android-app/           # Android приложение
├── main.py               # Точка входа основного приложения
├── api_main.py           # Точка входа API
├── transcribe_server.py  # Точка входа сервера транскрипции
├── start.py              # Скрипт быстрого запуска
├── docker-compose.yml    # Docker компоновка
├── Dockerfile            # Docker образ
├── requirements.txt      # Зависимости Python
├── README.md             # Основная документация
└── .env                  # Переменные окружения
```

## Удаленные компоненты

В ходе рефакторинга были удалены следующие файлы:

### Временные и тестовые файлы:
- `test_main.py`, `test_simple_main.py`, `test_simple_server.py`
- `test_curl.py`, `test_login.py`, `test_server.py`
- `test_auth_direct.py`, `test_auth.html`, `test_auth.py`
- `debug_auth.html`, `debug_server.py`

### Дублирующие скрипты:
- `add_user_db.py`, `add_user_docker.py`, `add_user.py`
- `delete_user_db.py`, `delete_user.py`
- `generate_token.py`, `get_token.py`, `make_admin.py`
- `manage_jobs.py`, `migrate_db.py`, `optimize_settings.py`

### Временная документация:
- `AUTH_FIX.md`, `QUICK_FIX_TIMEOUT.md`, `SESSION_FIX.md`
- `USER_DELETION_GUIDE.md`, `USER_MANAGEMENT.md`, `ARCHITECTURE_CHANGES.md`

## Модульная архитектура

### 1. Слой конфигурации (`src/config/`)
- **settings.py**: Централизованное управление настройками приложения
- Изолирует конфигурацию от бизнес-логики
- Поддерживает переменные окружения и значения по умолчанию

### 2. Модели данных (`src/models/`)
- **user.py**: Модель пользователя с SQLAlchemy
- Чистые модели данных без бизнес-логики
- Легко расширяемы для новых сущностей

### 3. Утилиты (`src/utils/`)
- **auth.py**: Аутентификация и JWT токены
- **database.py**: Работа с базой данных и сессиями
- Переиспользуемые компоненты без состояния

### 4. Сервисы (`src/services/`)
- **user_service.py**: Бизнес-логика пользователей
- **transcription_service.py**: Управление задачами транскрипции
- Содержат основную бизнес-логику приложения
- Независимы от фреймворков и протоколов

### 5. API слой (`src/api/`)
- **main.py**: Основное FastAPI приложение
- **dependencies.py**: Зависимости для авторизации
- Тонкий слой для обработки HTTP запросов
- Делегирует бизнес-логику сервисам

### 6. Фоновые задачи (`src/tasks/`)
- **transcribe.py**: Задача транскрипции аудио
- **summarize.py**: Задача суммаризации текста
- Изолированная обработка длительных операций
- Интеграция с Redis Queue

### 7. Воркеры (`src/workers/`)
- **transcribe_server.py**: HTTP сервер для транскрипции
- Альтернативный способ обработки через HTTP API
- Поддерживает как RQ workers, так и HTTP endpoints

## Принципы проектирования

### 1. Принцип единственной ответственности (Single Responsibility)
Каждый модуль отвечает за одну конкретную задачу:
- Модели - только данные
- Сервисы - только бизнес-логика  
- API - только обработка HTTP
- Утилиты - только вспомогательные функции

### 2. Принцип открытости/закрытости (Open/Closed)
Модули открыты для расширения, но закрыты для модификации:
- Добавление новых моделей не затрагивает существующие
- Новые сервисы можно добавлять без изменения API
- Расширение функциональности через композицию

### 3. Принцип подстановки Барбары Лисков (Liskov Substitution)
Интерфейсы модулей согласованы и взаимозаменяемы

### 4. Принцип разделения интерфейса (Interface Segregation)
Клиенты зависят только от необходимых им интерфейсов

### 5. Принцип инверсии зависимостей (Dependency Inversion)
Модули высокого уровня не зависят от модулей низкого уровня:
- Сервисы не зависят от конкретной реализации базы данных
- API зависит от абстракций сервисов, а не от их реализации

## Преимущества новой архитектуры

### 1. Улучшенная поддерживаемость
- Четкое разделение ответственности
- Легкое понимание структуры проекта
- Простое добавление нового функционала

### 2. Тестируемость
- Изолированные модули легко тестировать
- Mock-зависимости для unit-тестов
- Интеграционные тесты для API

### 3. Масштабируемость
- Независимое масштабирование компонентов
- Микросервисная готовность
- Горизонтальное масштабирование воркеров

### 4. Безопасность
- Централизованное управление аутентификацией
- Изоляция чувствительной логики
- Валидация на всех уровнях

## Миграция с старой структуры

### Изменения в импортах:
```python
# Было:
from database import get_db
from models import User
from auth import verify_password

# Стало:
from src.utils.database import get_db
from src.models.user import User  
from src.utils.auth import verify_password
```

### Изменения в запуске:
```bash
# Было:
python main.py
python api/main.py

# Стало:
python main.py          # Основное приложение
python api_main.py      # API сервер
python transcribe_server.py  # Сервер транскрипции
```

## Рекомендации по разработке

1. **Новые модели** добавлять в `src/models/`
2. **Новые сервисы** создавать в `src/services/`
3. **API endpoints** добавлять в `src/api/main.py`
4. **Фоновые задачи** размещать в `src/tasks/`
5. **Конфигурацию** изменять в `src/config/settings.py`

## Будущие улучшения

1. Добавление модульных тестов
2. Внедрение мониторинга и логирования
3. Поддержка дополнительных моделей AI
4. Интеграция с системами очередей (RabbitMQ, Kafka)
5. Поддержка кластеризации и репликации

Эта архитектура обеспечивает прочный фундамент для дальнейшего развития проекта и легко адаптируется под changing requirements.