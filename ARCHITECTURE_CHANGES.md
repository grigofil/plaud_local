# Изменения в архитектуре: Постоянный сервер транскрибации

## Что изменилось

Раньше модель Whisper запускалась каждый раз заново при обработке каждого аудио-файла через RQ (Redis Queue) воркер. Теперь модель загружается один раз при запуске контейнера и остается в памяти, ожидая новые аудио-файлы.

## Новая архитектура

### 1. Сервер транскрибации (workers/transcribe/server.py)
- **Постоянно запущенный HTTP сервер** на порту 8002
- **Модель Whisper загружается один раз** при запуске
- **Ожидает HTTP POST запросы** с аудио-файлами
- **Обрабатывает файлы асинхронно** в фоновом режиме
- **Автоматически добавляет задачи в очередь суммаризации**

### 2. Основной API (api/main.py)
- **Отправляет аудио-файлы** в HTTP сервер транскрибации
- **Проверяет статус** через HTTP API сервера транскрибации
- **Больше не использует RQ очередь** для транскрибации

### 3. Docker конфигурация
- **worker_transcribe** теперь запускает HTTP сервер вместо RQ worker
- **Порт 8002** открыт для внешних подключений
- **Модель остается в памяти** между запросами

## Преимущества новой архитектуры

1. **Быстрее обработка** - нет времени на загрузку модели
2. **Экономия ресурсов** - модель не перезагружается
3. **Лучшая масштабируемость** - можно добавить несколько серверов транскрибации
4. **Простота отладки** - HTTP API легче тестировать
5. **Мониторинг** - `/health` и `/status` эндпоинты для проверки состояния

## API эндпоинты сервера транскрибации

### POST /transcribe
Принимает аудио-файл и запускает транскрипцию:
```bash
curl -X POST "http://localhost:8002/transcribe" \
  -F "file=@audio.wav" \
  -F "job_id=123" \
  -F "language=ru"
```

### GET /status/{job_id}
Проверяет статус транскрибации:
```bash
curl "http://localhost:8002/status/123"
```

### GET /health
Проверка состояния сервера:
```bash
curl "http://localhost:8002/health"
```

## Переменные окружения

```bash
# URL сервера транскрибации
TRANSCRIBE_SERVER_URL=http://worker_transcribe:8002

# Порт сервера транскрибации
TRANSCRIBE_SERVER_PORT=8002

# Настройки Whisper (как раньше)
WHISPER_MODEL=medium
WHISPER_DEVICE=cpu
WHISPER_COMPUTE_TYPE=int8
WHISPER_FAST_MODE=false
```

## Запуск

```bash
# Остановить старые контейнеры
docker-compose down

# Пересобрать и запустить
docker-compose up --build

# Проверить статус сервера транскрибации
curl "http://localhost:8002/health"
```

## Обратная совместимость

- **Старые RQ задачи** больше не создаются
- **Файлы результатов** сохраняются в том же формате
- **API эндпоинты** работают как раньше
- **Очередь суммаризации** остается без изменений

## Мониторинг

Сервер транскрибации логирует:
- Загрузку модели при запуске
- Получение аудио-файлов
- Процесс транскрибации
- Ошибки и успешные завершения

## Возможные проблемы

1. **Если сервер транскрибации упадет** - нужно перезапустить контейнер
2. **Больше памяти** - модель постоянно в памяти
3. **Нет очереди** - если сервер перегружен, запросы могут отклоняться

## Планы на будущее

- [ ] Добавить health checks в docker-compose
- [ ] Реализовать автоматический перезапуск при падении
- [ ] Добавить метрики производительности
- [ ] Реализовать балансировку нагрузки между несколькими серверами
