<!doctype html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="color-scheme" content="light dark"/>
  <title>Аудио → Транскрипция + Саммари</title>
  <style>
    /* =============================
       Modern theme with variables
       ============================= */
    :root {
      --bg: #0b0f14;
      --panel: rgba(255, 255, 255, 0.7);
      --card: rgba(255, 255, 255, 0.65);
      --text: #0f172a;
      --muted: #6b7280;
      --border: rgba(15,23,42,.08);
      --ring: rgba(99,102,241,.25);
      --primary: #6366f1; /* indigo-500 */
      --primary-600: #4f46e5;
      --primary-700: #4338ca;
      --success: #16a34a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(2,6,23,.15);
      --radius: 14px;
      --radius-sm: 10px;
      --radius-xl: 22px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Segoe UI Variable", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    [data-theme="dark"] {
      --bg: #0b0f14;
      --panel: rgba(17, 24, 39, 0.6);
      --card: rgba(17, 24, 39, 0.55);
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: rgba(255,255,255,.06);
      --ring: rgba(99,102,241,.35);
      --shadow: 0 14px 40px rgba(0,0,0,.45);
    }

    /* Background candy */
    body {
      margin: 0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1000px 600px at 0% 10%, rgba(99,102,241,.15), transparent 60%),
        radial-gradient(1000px 600px at 100% 0%, rgba(56,189,248,.12), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.6));
      min-height: 100dvh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    [data-theme="dark"] body { background:
        radial-gradient(1000px 600px at 0% 10%, rgba(99,102,241,.25), transparent 60%),
        radial-gradient(1000px 600px at 100% 0%, rgba(56,189,248,.2), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,.85), rgba(2,6,23,.85)); }

    .container { max-width: 1100px; margin: 24px auto 80px; padding: 0 18px; }

    /* Top navbar */
    .nav {
      position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(140%) blur(12px);
      background: var(--panel); border-bottom: 1px solid var(--border);
    }
    .nav-inner { display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 12px 18px; max-width: 1100px; margin: 0 auto; }
    .brand { display:flex; align-items:center; gap:12px; font-weight: 700; letter-spacing:.3px; }
    .brand .logo { width: 32px; height: 32px; border-radius: 10px; background: linear-gradient(135deg, var(--primary), #22d3ee); display:grid; place-items:center; color:white; box-shadow: var(--shadow);}
    .brand small { font-weight: 500; opacity:.75; }

    .toolbar { display:flex; gap:8px; align-items:center; }

    /* Buttons */
    button, .btn { appearance: none; border: 1px solid var(--border); background: rgba(255,255,255,.6); color: var(--text);
      padding: 10px 14px; border-radius: var(--radius-sm); cursor: pointer; transition: .2s ease; box-shadow: 0 1px 0 rgba(2,6,23,.04);
      backdrop-filter: blur(6px); }
    [data-theme="dark"] button { background: rgba(15,23,42,.55); }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(2,6,23,.12); }
    button:active { transform: translateY(0); box-shadow: 0 2px 10px rgba(2,6,23,.08); }

    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-700)); color: #fff; border-color: transparent; box-shadow: 0 10px 20px rgba(79,70,229,.35); }
    .btn-primary:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .btn-danger { background: linear-gradient(135deg, #ef4444, #b91c1c); color:#fff; border-color: transparent; }
    .btn-ghost { background: transparent; }
    .btn-icon { width: 40px; height: 40px; display:grid; place-items:center; border-radius: 12px; }

    /* Cards / glass */
    .card { border:1px solid var(--border); border-radius: var(--radius); padding: 16px; margin: 14px 0; box-shadow: var(--shadow);
            background: var(--card); }

    h1 { font-size: clamp(1.25rem, 1.2rem + 1vw, 1.9rem); margin: 14px 0; }
    h3 { margin: 0 0 8px; font-size: 1.05rem; }
    .muted { color: var(--muted); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center }
    .mono { font-family: var(--mono); }

    input, select { border:1px solid var(--border); border-radius: 10px; padding: 10px 12px; background: rgba(255,255,255,.7); color: var(--text);
                    transition: .2s ease; }
    [data-theme="dark"] input, [data-theme="dark"] select { background: rgba(15,23,42,.55); }
    input:focus, select:focus { outline: none; box-shadow: 0 0 0 6px var(--ring); border-color: var(--primary); }

    /* Pills & badges */
    .pill { display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius: 999px; padding: 6px 10px; background: rgba(255,255,255,.55); }
    .ok { color: var(--success); } .warn { color: #b45309; }

    /* Progress */
    .progress-container { width: 100%; background: rgba(2,6,23,.06); border-radius: 999px; overflow: hidden; border: 1px solid var(--border); }
    .progress-bar { height: 18px; background: linear-gradient(90deg, var(--primary), #22d3ee); transition: width .35s ease; display:flex; align-items:center; justify-content:center; color:white; font-size: 12px; font-weight: 700; letter-spacing: .2px; }
    .progress-bar.processing { background: linear-gradient(90deg, #22d3ee, var(--primary)); }
    .progress-bar.transcribing { background: linear-gradient(90deg, #f59e0b, #fb923c); }
    .progress-bar.summarizing { background: linear-gradient(90deg, #a855f7, #7c3aed); }
    .progress-bar.done { background: linear-gradient(90deg, #22c55e, #16a34a); }
    .progress-bar.error { background: linear-gradient(90deg, #ef4444, #dc2626); }

    /* Status chips */
    .status-badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing:.6px; }
    .status-queued { background: #e0e7ff; color:#3730a3; }
    .status-processing { background: #cffafe; color:#0e7490; }
    .status-transcribing { background: #fef3c7; color:#b45309; }
    .status-summarizing { background: #f3e8ff; color:#6d28d9; }
    .status-done { background: #dcfce7; color:#166534; }
    .status-error { background: #fee2e2; color:#991b1b; }

    /* Result blocks */
    .result-card { border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin: 16px 0; background: var(--card); transition: .25s ease; }
    .result-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); border-color: rgba(99,102,241,.35); }
    .result-header { display:flex; justify-content:space-between; align-items:center; gap:14px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px dashed var(--border); }
    .result-title { font-size: 18px; font-weight: 800; }
    .result-meta { font-size: 12px; color: var(--muted); }
    .result-content { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 900px) { .result-content { grid-template-columns: 1fr; } }
    .result-section { background: rgba(255,255,255,.55); padding: 14px; border: 1px solid var(--border); border-radius: 12px; }
    [data-theme="dark"] .result-section { background: rgba(15,23,42,.45); }
    .result-section h4 { margin: 0 0 10px; font-size: 13px; font-weight: 800; letter-spacing: .6px; text-transform: uppercase; }

    .action-item { background: rgba(2,6,23,.05); padding: 8px 10px; margin: 6px 0; border-radius: 8px; border-left: 3px solid var(--primary); }
    .key-point { background: #fff7ed; padding: 8px 10px; margin: 6px 0; border-radius: 8px; border-left: 3px solid #fb923c; }
    .risk-item { background: #fef2f2; padding: 8px 10px; margin: 6px 0; border-radius: 8px; border-left: 3px solid #ef4444; }

    pre { white-space: pre-wrap; background: rgba(2,6,23,.05); border-radius: 10px; padding: 12px; overflow:auto; }

    /* Upload Dropzone */
    .dropzone { margin-top: 10px; border: 2px dashed var(--border); border-radius: var(--radius); padding: 18px; display:grid; place-items:center; text-align:center; transition: .2s ease; background: rgba(255,255,255,.4); }
    [data-theme="dark"] .dropzone { background: rgba(15,23,42,.4); }
    .dropzone.dragover { border-color: var(--primary); box-shadow: 0 0 0 6px var(--ring); transform: translateY(-1px); }

    /* Level Meter */
    .level-wrap { display:flex; align-items:center; gap:10px; margin-top:8px; }
    .level-bar { flex:1; height: 10px; border-radius: 999px; background: rgba(2,6,23,.08); overflow:hidden; border: 1px solid var(--border); }
    .level-inner { height: 100%; width: 0%; background: linear-gradient(90deg, #22d3ee, var(--primary)); transition: width .08s linear; }
    .level-num { font-variant-numeric: tabular-nums; width: 54px; text-align: right; }

    /* Modal (for job details) */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 60; display:flex; align-items:center; justify-content:center; padding: 20px; }
    .modal-card { width:min(900px, 94vw); max-height: 90vh; overflow:auto; background: var(--card); border:1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); padding: 20px; }

    /* Inline help */
    .kbd { font-family: var(--mono); font-size: 12px; padding: 2px 6px; border-radius: 6px; border: 1px solid var(--border); background: rgba(255,255,255,.6); }

    /* Footer */
    .footer { text-align:center; color: var(--muted); font-size: 12px; margin: 24px 0; }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo">🎧</div>
        <div>
          Audio → Whisper → DeepSeek<br/>
          <small class="muted">Запись, транскрипция, саммари — быстро и удобно</small>
        </div>
      </div>
      <div class="toolbar">
        <button id="loginBtn" class="btn btn-ghost">🔑 Войти</button>
        <button id="usersBtn" class="btn btn-ghost" style="display:none">👥 Пользователи</button>
        <button id="helpBtn" class="btn btn-ghost">❓ Подсказки</button>
        <button id="themeToggle" class="btn btn-icon" title="Сменить тему" aria-label="Сменить тему">🌞</button>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="modal-overlay" style="display:none">
    <div class="modal-card" style="max-width:400px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;border-bottom:1px dashed var(--border);padding-bottom:12px">
        <h2 style="margin:0">🔑 Вход в систему</h2>
        <button class="btn btn-icon" id="closeLoginModalBtn">✖</button>
      </div>
      <form id="loginForm">
        <div style="margin-bottom:12px">
          <label for="loginUsername" style="display:block;margin-bottom:4px;font-weight:600">Имя пользователя</label>
          <input id="loginUsername" type="text" required style="width:100%;box-sizing:border-box" placeholder="Введите имя пользователя">
        </div>
        <div style="margin-bottom:16px">
          <label for="loginPassword" style="display:block;margin-bottom:4px;font-weight:600">Пароль</label>
          <input id="loginPassword" type="password" required style="width:100%;box-sizing:border-box" placeholder="Введите пароль">
        </div>
        <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
          <button type="submit" class="btn btn-primary" style="flex:1">Войти</button>
          <button type="button" class="btn btn-ghost" id="cancelLoginBtn">Отмена</button>
        </div>
      </form>
      <div id="loginError" style="color:var(--danger);margin-top:12px;display:none;font-size:14px"></div>
    </div>
  </div>

  <!-- USERS MANAGEMENT MODAL -->
  <div id="usersModal" class="modal-overlay" style="display:none">
    <div class="modal-card" style="max-width:800px;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;border-bottom:1px dashed var(--border);padding-bottom:12px">
        <h2 style="margin:0">👥 Управление пользователями</h2>
        <button class="btn btn-icon" id="closeUsersModalBtn">✖</button>
      </div>
      <div id="usersList" style="margin-bottom:16px">
        <div style="text-align:center;padding:20px;color:var(--muted)">
          Загрузка списка пользователей...
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-ghost" id="refreshUsersBtn">🔄 Обновить</button>
        <button class="btn btn-ghost" id="cancelUsersBtn">Закрыть</button>
      </div>
    </div>
  </div>

  <div class="container">
    <h1>Запись/загрузка аудио → Whisper → DeepSeek</h1>

    <!-- OVERALL PROGRESS -->
    <div id="overallProgress" style="display:none" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px;">
        <strong>📈 Общий прогресс обработки</strong>
        <span id="progressStats">0/0 завершено</span>
      </div>
      <div class="progress-container"><div id="overallProgressBar" class="progress-bar" style="width:0%">0%</div></div>
    </div>

    <!-- SETTINGS -->
    <div class="card">
      <h3>⚙️ Настройки</h3>
      <div class="row">
        <label>API base:</label>
        <input id="apiBase" class="mono" style="min-width:320px" value="" placeholder="http://localhost:8000">
        <label>Язык:</label>
        <select id="lang"><option value="ru" selected>ru</option><option value="en">en</option></select>
      </div>
      <div class="row" style="margin-top:8px">
        <span id="keyStatus" class="muted">Войдите в систему для доступа к API</span>
      </div>
      <div class="muted" style="margin-top:6px">
        По умолчанию берётся текущий origin. Если API на другом хосте/порту — укажи: <span class="mono">http://localhost:8000</span>
      </div>
    </div>

    <!-- RECORD -->
    <div class="card">
      <h3>🎙️ Запись с микрофона (браузер)</h3>
      <div class="row">
        <label>Микрофон:</label>
        <select id="micSelect" style="min-width:240px"><option value="">Автоматический выбор</option></select>
        <button id="btnRefreshMics" class="btn" title="Обновить устройства">🔄 Обновить</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnStart" class="btn-primary">▶️ Начать запись</button>
        <button id="btnStop" class="btn" disabled>⏹ Остановить</button>
        <button id="btnTestMic" class="btn">🎤 Тест микрофона</button>
        <span id="recStatus" class="pill muted">не записывается</span>
      </div>
      <div id="recTime" class="muted" style="margin-top:8px"></div>
      <div class="level-wrap" id="levelWrap" style="display:none">
        <div class="level-bar"><div class="level-inner" id="levelInner"></div></div>
        <div class="level-num" id="levelNum">0%</div>
      </div>
      <div id="micInfo" class="muted" style="margin-top:8px;font-size:12px"></div>
      <audio id="player" controls style="display:none;margin-top:8px"></audio>
      <div class="muted" style="margin-top:8px">Горячие клавиши: <span class="kbd">R</span> — старт/стоп записи, <span class="kbd">U</span> — выбрать файл, <span class="kbd">H</span> — загрузить историю.</div>
    </div>

    <!-- UPLOAD -->
    <div class="card">
      <h3>📤 Загрузка готового файла</h3>
      <div class="row">
        <input id="fileInput" type="file" accept="audio/*,video/webm"/>
        <button id="btnUpload" class="btn">⬆️ Загрузить</button>
      </div>
      <div id="dropzone" class="dropzone">
        <div>Перетащите файл сюда или нажмите <span class="kbd">U</span> для выбора</div>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h3>📚 История обработки</h3>
        <div class="row">
          <button id="btnLoadHistory" class="btn-primary">🔄 Загрузить историю</button>
          <button id="btnClearHistory" class="btn btn-danger">🗑️ Очистить</button>
        </div>
      </div>
      <div id="historyContainer" style="display:none"><div id="historyList"></div></div>
    </div>

    <!-- JOB CARDS -->
    <div id="jobs"></div>

    <!-- RESULTS -->
    <div id="results" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin: 18px 0">
        <h2>📊 Результаты обработки</h2>
        <button onclick="clearResults()" class="btn btn-danger">🗑️ Очистить все</button>
      </div>
      <div id="resultsList"></div>
    </div>

    <div class="footer">Сделано с любовью к UX • Поддерживает светлую/тёмную тему • Быстрые уведомления и drag&drop</div>
  </div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const apiBaseInput = $('#apiBase');
  const langSel = $('#lang');
  const btnStart = $('#btnStart');
  const btnStop = $('#btnStop');
  const statusSpan = $('#recStatus');
  const recTimeEl = $('#recTime');
  const fileInput = $('#fileInput');
  const btnUpload = $('#btnUpload');
  const player = $('#player');
  const jobs = $('#jobs');
  const micSelect = $('#micSelect');
  const btnRefreshMics = $('#btnRefreshMics');
  const dropzone = $('#dropzone');
  const themeToggle = $('#themeToggle');
  const helpBtn = $('#helpBtn');

  // ===== Theme =====
  const THEME_KEY = 'plaud_theme';
  function setTheme(theme){ 
    console.log(`setTheme: ${theme}`); 
    document.documentElement.setAttribute('data-theme', theme); 
    localStorage.setItem(THEME_KEY, theme); 
    themeToggle.textContent = theme==='dark' ? '🌙' : '🌞'; 
  }
  const savedTheme = localStorage.getItem(THEME_KEY) || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  setTheme(savedTheme);
  themeToggle.onclick = () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme==='dark' ? 'light' : 'dark';
    console.log(`Theme toggle: ${currentTheme} -> ${newTheme}`);
    setTheme(newTheme);
  };

  // Login button handler
  $('#loginBtn').onclick = () => {
    console.log(`Login button clicked`);
    openLoginModal();
  };

  // Login form handler
  $('#loginForm').addEventListener('submit', handleLogin);
  
  // Close modal handlers
  $('#closeLoginModalBtn').onclick = closeLoginModal;
  $('#cancelLoginBtn').onclick = closeLoginModal;

  // Users management button handler
  $('#usersBtn').onclick = () => {
    console.log(`Users button clicked`);
    openUsersModal();
  };

  // Users modal handlers
  $('#closeUsersModalBtn').onclick = closeUsersModal;
  $('#cancelUsersBtn').onclick = closeUsersModal;
  $('#refreshUsersBtn').onclick = loadUsersList;

  helpBtn.onclick = () => {
    console.log(`Help button clicked`);
    showNotification('Сочетания клавиш: R — запись, U — выбрать файл, H — история. Можно перетащить файл в область загрузки.', 'info');
  };

  // Login modal functions
  function openLoginModal() {
    console.log(`Opening login modal`);
    $('#loginModal').style.display = 'flex';
    $('#loginUsername').focus();
  }

  function closeLoginModal() {
    console.log(`Closing login modal`);
    $('#loginModal').style.display = 'none';
    $('#loginError').style.display = 'none';
    $('#loginError').textContent = '';
    $('#loginForm').reset();
  }

  // Helper function to get API base URL
  function getApiBase() {
    return apiBaseInput.value || `${location.protocol}//${location.host}`;
  }

  // Users management modal functions
  function openUsersModal() {
    console.log(`Opening users modal`);
    $('#usersModal').style.display = 'flex';
    loadUsersList();
  }

  function closeUsersModal() {
    console.log(`Closing users modal`);
    $('#usersModal').style.display = 'none';
  }

  async function loadUsersList() {
    const usersList = $('#usersList');
    usersList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">Загрузка списка пользователей...</div>';
    
    try {
      const token = localStorage.getItem('plaud_jwt_token');
      if (!token) {
        usersList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger)">❌ Необходима авторизация</div>';
        return;
      }

      const response = await fetch(`${getApiBase()}/users`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      const users = data.users || [];

      if (users.length === 0) {
        usersList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">👥 Пользователи не найдены</div>';
        return;
      }

      // Создаем HTML для списка пользователей
      let usersHTML = '<div style="display:grid;gap:12px">';
      
      users.forEach(user => {
        const statusClass = user.is_active ? 'success' : 'warn';
        const statusText = user.is_active ? 'Активен' : 'Заблокирован';
        const adminClass = user.is_admin ? 'success' : 'muted';
        const adminText = user.is_admin ? '👑 Админ' : '👤 Пользователь';
        const createdDate = new Date(user.created_at).toLocaleDateString('ru-RU');
        
        usersHTML += `
          <div class="card" style="padding:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div>
                <strong>👤 ${user.username}</strong>
                <span class="pill ${statusClass}" style="margin-left:8px">${statusText}</span>
                <span class="pill ${adminClass}" style="margin-left:8px">${adminText}</span>
              </div>
              <div style="display:flex;gap:8px">
                ${user.is_active ? 
                  `<button onclick="deactivateUser(${user.id})" class="btn btn-danger">🚫 Заблокировать</button>` :
                  `<button onclick="activateUser(${user.id})" class="btn btn-primary">✅ Активировать</button>`
                }
                ${user.is_admin ? 
                  `<button onclick="removeAdmin(${user.id})" class="btn btn-warn">👤 Убрать админа</button>` :
                  `<button onclick="makeAdmin(${user.id})" class="btn btn-primary">👑 Сделать админом</button>`
                }
                <button onclick="deleteUser(${user.id}, '${user.username}')" class="btn btn-danger">
                  🗑️ Удалить
                </button>
              </div>
            </div>
            <div style="color:var(--muted);font-size:14px">
              📧 ${user.email} • 🆔 ID: ${user.id} • 📅 Создан: ${createdDate}
            </div>
          </div>
        `;
      });
      
      usersHTML += '</div>';
      usersList.innerHTML = usersHTML;
      
    } catch (error) {
      console.error('Error loading users:', error);
      usersList.innerHTML = `<div style="text-align:center;padding:20px;color:var(--danger)">❌ Ошибка загрузки: ${error.message}</div>`;
    }
  }

  async function deleteUser(userId, username) {
    if (!confirm(`Вы уверены, что хотите удалить пользователя "${username}"?\n\nЭто действие нельзя отменить!`)) {
      return;
    }

    try {
      const token = localStorage.getItem('plaud_jwt_token');
      if (!token) {
        showNotification('❌ Необходима авторизация', 'error');
        return;
      }

      const response = await fetch(`${getApiBase()}/users/${userId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || `HTTP ${response.status}`);
      }

      const result = await response.json();
      showNotification(`✅ Пользователь "${username}" успешно удален`, 'success');
      loadUsersList(); // Обновляем список
      
    } catch (error) {
      console.error('Error deleting user:', error);
      showNotification(`❌ Ошибка удаления: ${error.message}`, 'error');
    }
  }

  async function deactivateUser(userId) {
    try {
      const token = localStorage.getItem('plaud_jwt_token');
      if (!token) {
        showNotification('❌ Необходима авторизация', 'error');
        return;
      }

      const response = await fetch(`${getApiBase()}/users/${userId}/deactivate`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || `HTTP ${response.status}`);
      }

      const result = await response.json();
      showNotification(`✅ Пользователь "${result.user.username}" заблокирован`, 'success');
      loadUsersList(); // Обновляем список
      
    } catch (error) {
      console.error('Error deactivating user:', error);
      showNotification(`❌ Ошибка блокировки: ${error.message}`, 'error');
    }
  }

  async function activateUser(userId) {
    try {
      const token = localStorage.getItem('plaud_jwt_token');
      if (!token) {
        showNotification('❌ Необходима авторизация', 'error');
        return;
      }

      const response = await fetch(`${getApiBase()}/users/${userId}/activate`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || `HTTP ${response.status}`);
      }

      const result = await response.json();
      showNotification(`✅ Пользователь "${result.user.username}" активирован`, 'success');
      loadUsersList(); // Обновляем список
      
    } catch (error) {
      console.error('Error activating user:', error);
      showNotification(`❌ Ошибка активации: ${error.message}`, 'error');
    }
  }

  async function makeAdmin(userId) {
    try {
      const token = localStorage.getItem('plaud_jwt_token');
      if (!token) {
        showNotification('❌ Необходима авторизация', 'error');
        return;
      }

      const response = await fetch(`${getApiBase()}/users/${userId}/make-admin`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || `HTTP ${response.status}`);
      }

      const result = await response.json();
      showNotification(`✅ Пользователь "${result.user.username}" назначен администратором`, 'success');
      loadUsersList(); // Обновляем список
      
    } catch (error) {
      console.error('Error making admin:', error);
      showNotification(`❌ Ошибка назначения администратора: ${error.message}`, 'error');
    }
  }

  async function removeAdmin(userId) {
    try {
      const token = localStorage.getItem('plaud_jwt_token');
      if (!token) {
        showNotification('❌ Необходима авторизация', 'error');
        return;
      }

      const response = await fetch(`${getApiBase()}/users/${userId}/remove-admin`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || `HTTP ${response.status}`);
      }

      const result = await response.json();
      showNotification(`✅ Права администратора сняты с пользователя "${result.user.username}"`, 'success');
      loadUsersList(); // Обновляем список
      
    } catch (error) {
      console.error('Error removing admin:', error);
      showNotification(`❌ Ошибка снятия прав администратора: ${error.message}`, 'error');
    }
  }

  // Make functions globally available
  window.openLoginModal = openLoginModal;
  window.closeLoginModal = closeLoginModal;
  window.openUsersModal = openUsersModal;
  window.closeUsersModal = closeUsersModal;
  window.deleteUser = deleteUser;
  window.deactivateUser = deactivateUser;
  window.activateUser = activateUser;
  window.makeAdmin = makeAdmin;
  window.removeAdmin = removeAdmin;

  async function handleLogin(event) {
    event.preventDefault();
    console.log(`Handling login form submission`);
    
    const username = $('#loginUsername').value.trim();
    const password = $('#loginPassword').value;
    
    console.log(`Login attempt: username="${username}", passwordLength=${password.length}`);
    
    if (!username || !password) {
      console.log(`Login failed: empty fields`);
      showNotification('⚠️ Заполните все поля', 'warn');
      return false;
    }
    
    const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
    console.log(`API Base: ${apiBase}`);
    
    const formData = new FormData();
    formData.append('username', username);
    formData.append('password', password);
    
    try {
      showNotification('🔐 Выполняется вход...', 'info');
      console.log(`Sending login request to: ${apiBase}/auth/login`);
      
      const response = await fetch(`${apiBase}/auth/login`, {
        method: 'POST',
        body: formData
      });
      
      console.log(`Login response: status=${response.status}, statusText=${response.statusText}`);
      
      if (response.ok) {
        const data = await response.json();
        console.log('Login successful:', data);
        
        // Save the JWT token
        localStorage.setItem('plaud_jwt_token', data.access_token);
        localStorage.setItem('plaud_username', data.username);
        
        console.log('Token saved to localStorage:', {
          token: data.access_token.substring(0, 20) + '...',
          username: data.username
        });
        
        // Get user info including admin status
        try {
          const userInfoResponse = await fetch(`${apiBase}/auth/me`, {
            headers: {
              'Authorization': `Bearer ${data.access_token}`
            }
          });
          
          if (userInfoResponse.ok) {
            const userInfo = await userInfoResponse.json();
            localStorage.setItem('plaud_is_admin', userInfo.is_admin ? 'true' : 'false');
            console.log('User info saved:', { is_admin: userInfo.is_admin });
          }
        } catch (error) {
          console.warn('Failed to get user info:', error);
          localStorage.setItem('plaud_is_admin', 'false');
        }
        
        updateKeyStatus('Вход выполнен', 'ok');
        
        closeLoginModal();
        showNotification(`✅ Добро пожаловать, ${data.username}!`, 'success');
        
        // Update UI immediately
        console.log('Updating UI after login...');
        updateAuthUI();
        
        // Check auth to verify token works (but don't update UI again)
        console.log('Verifying token with server...');
        const isValid = await checkAuthSilent();
        console.log('Token verification result:', isValid);
        
        return true;
      } else {
        console.log(`Login failed: HTTP ${response.status}`);
        const errorData = await response.json().catch(() => ({ detail: 'Ошибка сервера' }));
        console.log(`Login error data:`, errorData);
        
        $('#loginError').textContent = errorData.detail || 'Ошибка входа';
        $('#loginError').style.display = 'block';
        showNotification('❌ Ошибка входа: ' + (errorData.detail || 'Неверные данные'), 'error');
        return false;
      }
    } catch (error) {
      console.error('Login error:', error);
      console.error('Error details:', {
        name: error.name,
        message: error.message,
        stack: error.stack
      });
      
      $('#loginError').textContent = 'Ошибка соединения: ' + error.message;
      $('#loginError').style.display = 'block';
      showNotification('🌐 Ошибка соединения с сервером: ' + error.message, 'error');
      return false;
    }
  }

  // API base default current origin
  apiBaseInput.value = `${location.protocol}//${location.host}`;
  apiBaseInput.onchange = () => {
    console.log(`API base changed to: ${apiBaseInput.value}`);
    showNotification(`🔗 API base: ${apiBaseInput.value}`, 'info');
  };

  // Check if user is already logged in
  const savedToken = localStorage.getItem('plaud_jwt_token');
  const savedUsername = localStorage.getItem('plaud_username');
  const savedIsAdmin = localStorage.getItem('plaud_is_admin');
  
  console.log(`Page load check: token=${!!savedToken}, username=${savedUsername}, isAdmin=${savedIsAdmin}`);
  
  if (savedToken && savedUsername) { 
    updateKeyStatus('Токен загружен', 'ok'); 
    updateAuthUI(); // Update UI to show logged in state
    showNotification('🔑 Токен загружен', 'success'); 
    
    // If we don't have admin status, try to get it
    if (savedIsAdmin === null) {
      console.log('Admin status not found, fetching user info...');
      checkAuth(); // This will fetch admin status
    }
  }

  // Saved mic
  const savedMicId = localStorage.getItem('plaud_selected_mic');
  if (savedMicId) window.savedMicId = savedMicId;

  // Auth check
  async function checkAuth(){
    console.log(`checkAuth called`);
    let token = localStorage.getItem('plaud_jwt_token');
    
    if (!token) {
      console.log(`No JWT token found`);
      updateKeyStatus('Войдите в систему', 'warn');
      updateAuthUI();
      return false;
    }
    
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      console.log(`Checking auth with API base: ${apiBase}`);
      
      // Try to check auth status
      const response = await fetch(`${apiBase}/auth/check`, { 
        headers: { 'Authorization': `Bearer ${token}` },
        method: 'GET'
      });
      
      if (response.ok) {
        const data = await response.json();
        console.log(`Auth successful for user: ${data.username}`);
        updateKeyStatus(`Авторизация успешна (${data.username})`, 'ok');
        
        // Update UI based on auth status only if it's not already updated
        const currentUsername = localStorage.getItem('plaud_username');
        if (currentUsername !== data.username) {
          console.log(`Username mismatch, updating UI: ${currentUsername} -> ${data.username}`);
          updateAuthUI();
        } else {
          // Even if username matches, we should check admin status
          console.log(`Username matches, checking admin status for: ${data.username}`);
          try {
            const userInfoResponse = await fetch(`${apiBase}/auth/me`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (userInfoResponse.ok) {
              const userInfo = await userInfoResponse.json();
              const currentIsAdmin = localStorage.getItem('plaud_is_admin') === 'true';
              const newIsAdmin = userInfo.is_admin;
              
              console.log(`Admin status check: current=${currentIsAdmin}, new=${newIsAdmin}`);
              
              if (currentIsAdmin !== newIsAdmin) {
                console.log(`Admin status changed, updating UI: ${currentIsAdmin} -> ${newIsAdmin}`);
                localStorage.setItem('plaud_is_admin', newIsAdmin ? 'true' : 'false');
                updateAuthUI();
              } else {
                console.log(`Admin status unchanged: ${newIsAdmin}`);
              }
            }
          } catch (error) {
            console.warn('Failed to check admin status:', error);
          }
        }
        
        return true;
      }
      
      console.log(`Auth failed: HTTP ${response.status}`);
      
      // If JWT token is invalid, clear it
      localStorage.removeItem('plaud_jwt_token');
      localStorage.removeItem('plaud_username');
      updateKeyStatus('Токен истек', 'warn');
      showNotification('🔑 Токен авторизации истек. Войдите снова.', 'warn');
      updateAuthUI();
      
      return false;
    } catch (e) {
      console.error(`Auth error:`, e);
      updateKeyStatus('Ошибка соединения','warn');
      
      // Don't clear token on connection errors, just show warning
      if (e.name === 'TypeError' && e.message.includes('fetch')) {
        showNotification('🌐 Нет соединения с сервером', 'warn');
      } else {
        showNotification('❌ Ошибка проверки авторизации', 'error');
      }
      
      return false;
    }
  }

  // Silent auth check (doesn't update UI)
  async function checkAuthSilent(){
    console.log(`checkAuthSilent called`);
    let token = localStorage.getItem('plaud_jwt_token');
    
    if (!token) {
      console.log(`No JWT token found in silent check`);
      return false;
    }
    
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      console.log(`Silent checking auth with API base: ${apiBase}`);
      
      // Try to check auth status
      const response = await fetch(`${apiBase}/auth/check`, { 
        headers: { 'Authorization': `Bearer ${token}` },
        method: 'GET'
      });
      
      if (response.ok) {
        const data = await response.json();
        console.log(`Silent auth successful for user: ${data.username}`);
        return true;
      }
      
      console.log(`Silent auth failed: HTTP ${response.status}`);
      
      // If JWT token is invalid, clear it but don't show notifications
      localStorage.removeItem('plaud_jwt_token');
      localStorage.removeItem('plaud_username');
      
      return false;
    } catch (e) {
      console.error(`Silent auth error:`, e);
      // Don't show notifications or update UI on connection errors
      return false;
    }
  }
  function updateKeyStatus(msg, type){
    console.log(`updateKeyStatus: ${msg} (${type})`);
    const el=$('#keyStatus');
    el.textContent=msg;
    el.className = type==='ok' ? 'ok' : 'warn';
  }

  // Update UI based on authentication status
  function updateAuthUI() {
    const token = localStorage.getItem('plaud_jwt_token');
    const username = localStorage.getItem('plaud_username');
    const isAdmin = localStorage.getItem('plaud_is_admin') === 'true';
    const loginBtn = $('#loginBtn');
    const usersBtn = $('#usersBtn');
    
    console.log(`updateAuthUI: token=${!!token}, username=${username}, isAdmin=${isAdmin}`);
    console.log(`Current button text: "${loginBtn.textContent}"`);
    console.log(`Users button current display: "${usersBtn.style.display}"`);
    
    if (token && username) {
      // User is logged in
      const newText = `👤 ${username}`;
      loginBtn.textContent = newText;
      loginBtn.title = 'Выйти из системы';
      loginBtn.onclick = handleLogout;
      
      // Показываем кнопку управления пользователями только администраторам
      const shouldShowUsersBtn = isAdmin;
      usersBtn.style.display = shouldShowUsersBtn ? 'block' : 'none';
      
      console.log(`UI updated: user logged in as ${username}, isAdmin=${isAdmin}, shouldShowUsersBtn=${shouldShowUsersBtn}, usersBtn.display="${usersBtn.style.display}"`);
    } else {
      // User is not logged in
      loginBtn.textContent = '🔑 Войти';
      loginBtn.title = 'Войти в систему';
      loginBtn.onclick = () => {
        console.log(`Login button clicked`);
        openLoginModal();
      };
      usersBtn.style.display = 'none';
      console.log(`UI updated: user not logged in, button text: "🔑 Войти"`);
    }
    
    // Force a re-render by triggering a small style change
    loginBtn.style.transform = 'scale(1)';
    
    // Additional verification
    setTimeout(() => {
      console.log(`UI verification after 100ms: button text="${loginBtn.textContent}", onclick=${typeof loginBtn.onclick}, usersBtn.display="${usersBtn.style.display}"`);
    }, 100);
  }

  // Logout function
  function handleLogout() {
    console.log(`Logout initiated`);
    localStorage.removeItem('plaud_jwt_token');
    localStorage.removeItem('plaud_username');
    localStorage.removeItem('plaud_is_admin');
    updateKeyStatus('Вы вышли из системы', 'warn');
    showNotification('👋 До свидания!', 'info');
    updateAuthUI();
  }

  // ========== Microphones ==========
  async function getAvailableMicrophones(){
    console.log(`getAvailableMicrophones called`);
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(t => t.stop());
      const devices = await navigator.mediaDevices.enumerateDevices();
      const audioInputs = devices.filter(d => d.kind==='audioinput');
      console.log(`Found ${audioInputs.length} audio input devices`);
      micSelect.innerHTML = '<option value="">Автоматический выбор</option>';
      audioInputs.forEach(device => { const o=document.createElement('option'); o.value=device.deviceId; o.textContent=device.label || `Микрофон ${device.deviceId.slice(0,8)}...`; micSelect.appendChild(o); });
      if (window.savedMicId) { const saved = micSelect.querySelector(`option[value="${window.savedMicId}"]`); if (saved) { micSelect.value=window.savedMicId; showNotification(`🎤 Восстановлен микрофон: ${saved.textContent}`, 'info'); } window.savedMicId=null; }
      if (audioInputs.length>0) { const micInfo=$('#micInfo'); micInfo.innerHTML = `<strong>📱 Доступные микрофоны:</strong><br>${audioInputs.map((d,i)=>`${i+1}. ${d.label || 'Неизвестно'} (${d.deviceId.slice(0,8)}...)`).join('<br>')}`; }
    } catch (err) {
      console.error(`getAvailableMicrophones error:`, err);
      if (err.name==='NotAllowedError') showNotification('🔒 Разрешите доступ к микрофону','warn'); else showNotification('❌ Ошибка списка микрофонов: '+err.message,'error');
    }
  }
  function refreshMicrophones(){ 
    console.log(`refreshMicrophones called`); 
    showNotification('🔄 Обновляю список микрофонов...','info'); 
    getAvailableMicrophones(); 
  }

  // ========== Recording ==========
  let mediaRecorder, chunks=[], startTs=null, tickTimer=null, recordedBlob=null, recordedName=null;
  let audioCtx=null, analyser=null, meterRAF=null, levelInner=$('#levelInner'), levelNum=$('#levelNum');

  function supports(mime){ 
    const result = (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(mime)); 
    console.log(`supports(${mime}): ${result}`); 
    return result; 
  }

  async function startRec(){
    console.log(`startRec called`);
    if (!await checkAuth()) { showNotification('❌ Войдите в систему','error'); return; }
    try {
      const audioConstraints = { echoCancellation:true, noiseSuppression:true, autoGainControl:true, sampleRate:48000, channelCount:1 };
      const selectedMicId = micSelect.value; if (selectedMicId) audioConstraints.deviceId = { exact: selectedMicId };
      console.log(`Audio constraints:`, audioConstraints);
      const stream = await navigator.mediaDevices.getUserMedia({ audio: audioConstraints });

      // MIME
      const mime = supports('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : supports('audio/ogg;codecs=opus') ? 'audio/ogg;codecs=opus' : supports('audio/webm') ? 'audio/webm' : 'audio/wav';
      console.log(`Using MIME type: ${mime}`);
      mediaRecorder = new MediaRecorder(stream, { mimeType: mime, audioBitsPerSecond: 128000 });

      chunks=[]; recordedBlob=null; recordedName=null;
      mediaRecorder.ondataavailable = e => { if (e.data && e.data.size>0) chunks.push(e.data); };
      mediaRecorder.onstart = () => { showNotification('🎙️ Запись началась','success'); };
      mediaRecorder.onerror = (event) => showNotification('❌ Ошибка записи: ' + event.error,'error');
      mediaRecorder.onstop = onStopRec;
      mediaRecorder.start(100);

      // Timer UI
      startTs = Date.now();
      tickTimer = setInterval(()=>{ const s=Math.floor((Date.now()-startTs)/1000); recTimeEl.textContent = `Идёт запись: ${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`; }, 500);
      btnStart.disabled = true; btnStop.disabled = false; statusSpan.textContent = 'запись…'; statusSpan.className='pill';

      // Audio level meter
      $('#levelWrap').style.display='flex';
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const src = audioCtx.createMediaStreamSource(stream); analyser = audioCtx.createAnalyser(); analyser.fftSize=256; src.connect(analyser);
      const buf = new Uint8Array(analyser.fftSize);
      const meter = () => {
        analyser.getByteTimeDomainData(buf);
        let sum=0; for (let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum+=v*v; }
        const rms = Math.sqrt(sum/buf.length); // 0..1
        const pct = Math.min(100, Math.max(0, Math.round(rms*160))); // scale
        levelInner.style.width = pct + '%'; levelNum.textContent = pct + '%';
        meterRAF = requestAnimationFrame(meter);
      };
      meter();

    } catch (err) {
      console.error(`startRec error:`, err);
      if (err.name==='NotAllowedError') showNotification('🔒 Разрешите доступ к микрофону','warn');
      else if (err.name==='NotFoundError') showNotification('🎤 Микрофон не найден','error');
      else if (err.name==='NotReadableError') showNotification('📱 Микрофон занят другим приложением','warn');
      else showNotification('❌ Ошибка записи: '+err.message,'error');
    }
  }

  function onStopRec(){
    console.log(`onStopRec called`);
    clearInterval(tickTimer); cancelAnimationFrame(meterRAF); $('#levelWrap').style.display='none';
    if (chunks.length===0) { showNotification('⚠️ Пустая запись','warn'); return; }
    const blob = new Blob(chunks, {type: mediaRecorder.mimeType || 'audio/webm'}); recordedBlob = blob;
    console.log(`Recording blob created: ${blob.size} bytes, type: ${blob.type}`);
    if (blob.size===0) { showNotification('⚠️ Запись пустая','warn'); return; }
    recordedName = `recording_${new Date().toISOString().replace(/[:.]/g,'-')}.${blob.type.startsWith('audio/ogg')?'ogg':'webm'}`;
    console.log(`Recording name: ${recordedName}`);
    player.src = URL.createObjectURL(blob); player.style.display='block';
    recTimeEl.textContent = `Запись завершена: ${(blob.size/1024/1024).toFixed(2)} MB`;
    statusSpan.textContent = 'готово к загрузке'; statusSpan.className='pill ok';
    showNotification(`✅ Запись завершена (${(blob.size/1024/1024).toFixed(2)} MB), отправляю...`,'success');
    console.log(`Calling uploadBlob with blob and name: ${recordedName}`);
    uploadBlob(blob, recordedName);
  }

  function stopRec(){
    console.log(`stopRec called`);
    if (mediaRecorder && mediaRecorder.state!=='inactive'){
      console.log(`Stopping media recorder`);
      mediaRecorder.stop(); mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    }
    if (audioCtx) { try { audioCtx.close(); } catch(_){} }
    btnStart.disabled=false; btnStop.disabled=true;
  }

  async function testMicrophone(){
    console.log(`testMicrophone called`);
    try{
      showNotification('🎤 Тест микрофона...','info');
      const audioConstraints = { echoCancellation:false, noiseSuppression:false, autoGainControl:false };
      const selectedMicId = micSelect.value; if (selectedMicId) audioConstraints.deviceId = { exact: selectedMicId };
      console.log(`Test audio constraints:`, audioConstraints);
      const stream = await navigator.mediaDevices.getUserMedia({ audio: audioConstraints });
      const track = stream.getAudioTracks()[0];
      console.log(`Test track:`, track);
      const micInfo = $('#micInfo');
      micInfo.innerHTML = `<strong>🎤 Микрофон:</strong> ${track.label || 'Неизвестно'}<br>Включен: ${track.enabled ? '✅' : '❌'} | Заглушен: ${track.muted ? '🔇' : '🔊'} | Состояние: ${track.readyState}`;
      stream.getTracks().forEach(t => t.stop());
      showNotification('✅ Микрофон работает','success');
    }catch(err){
      console.error(`testMicrophone error:`, err);
      $('#micInfo').innerHTML = `<strong>❌ Ошибка микрофона:</strong> ${err.message}`;
      showNotification('❌ Ошибка микрофона: '+err.message,'error');
    }
  }

  btnStart.onclick = () => { console.log(`Start button clicked`); startRec(); }; 
  btnStop.onclick = () => { console.log(`Stop button clicked`); stopRec(); }; 
  $('#btnTestMic').onclick = () => { console.log(`Test mic button clicked`); testMicrophone(); }; 
  btnRefreshMics.onclick = () => { console.log(`Refresh mics button clicked`); refreshMicrophones(); };
  micSelect.onchange = () => { 
    const id=micSelect.value; 
    console.log(`Microphone selection changed to: ${id}`);
    if (id){ 
      const name=micSelect.options[micSelect.selectedIndex].textContent; 
      localStorage.setItem('plaud_selected_mic', id); 
      showNotification(`🎤 Выбран микрофон: ${name}`,'info'); 
    } else { 
      localStorage.removeItem('plaud_selected_mic'); 
      showNotification('🎤 Автовыбор микрофона','info'); 
    } 
  };



  setTimeout(async()=>{ 
    console.log(`Initial auth check timeout`); 
    if (await checkAuth()) showNotification('🎉 Добро пожаловать!','success'); 
  }, 800);
  setTimeout(()=>{ 
    console.log(`Initial microphones check timeout`); 
    getAvailableMicrophones(); 
  }, 1200);
  langSel.onchange = () => {
    console.log(`Language changed to: ${langSel.value}`);
    showNotification(`🌐 Язык: ${langSel.value.toUpperCase()}`,'info');
  };

  // ===== Upload =====
  btnUpload.onclick = async ()=>{
    const f=fileInput.files?.[0]; 
    console.log(`Upload button clicked, file:`, f);
    if (!f) { 
      showNotification('⚠️ Выберите файл','warn'); 
      return; 
    } 
    if (!await checkAuth()){ 
      showNotification('❌ Нет авторизации','error'); 
      return; 
    } 
    showNotification(`📤 Загрузка: ${f.name}`,'info'); 
    uploadBlob(f, f.name); 
  };

  // Drag&Drop
  ;['dragenter','dragover'].forEach(ev=> dropzone.addEventListener(ev, e=>{ 
    console.log(`Drag event: ${ev}`);
    e.preventDefault(); 
    e.stopPropagation(); 
    dropzone.classList.add('dragover'); 
  }));
  ;['dragleave','drop'].forEach(ev=> dropzone.addEventListener(ev, e=>{ 
    console.log(`Drag event: ${ev}`);
    e.preventDefault(); 
    e.stopPropagation(); 
    dropzone.classList.remove('dragover'); 
  }));
  dropzone.addEventListener('drop', async e => { 
    const f = e.dataTransfer.files?.[0]; 
    console.log(`File dropped:`, f);
    if (!f) return; 
    if (!await checkAuth()) { 
      showNotification('❌ Нет авторизации','error'); 
      return; 
    } 
    showNotification(`📤 Загрузка: ${f.name}`,'info'); 
    uploadBlob(f, f.name); 
  });

  // Shortcuts
  window.addEventListener('keydown', e => {
    const tag = (e.target && e.target.tagName) || '';
    if (['INPUT','TEXTAREA','SELECT'].includes(tag)) return;
    if (e.key==='r' || e.key==='R') { 
      console.log(`R key pressed, starting/stopping recording`);
      e.preventDefault(); 
      btnStop.disabled ? btnStart.click() : btnStop.click(); 
    }
    if (e.key==='u' || e.key==='U') { 
      console.log(`U key pressed, opening file dialog`);
      e.preventDefault(); 
      fileInput.click(); 
    }
    if (e.key==='h' || e.key==='H') { 
      console.log(`H key pressed, loading history`);
      e.preventDefault(); 
      $('#btnLoadHistory').click(); 
    }
  });

  // ===== API upload & cards =====
  async function uploadBlob(blob, filename){
    const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
    const lang = langSel.value || 'ru';
    const token = localStorage.getItem('plaud_jwt_token');
    if (!token) { showNotification('⚠️ Войдите в систему','warn'); return; }

    console.log(`uploadBlob: ${filename}, lang: ${lang}`);
    const card = makeJobCard({filename, lang}); 
    console.log(`Card created:`, card);
    jobs.prepend(card.el); 
    console.log(`Card added to DOM`);
    addJob();
    
    try {
      const fd = new FormData(); fd.append('file', blob, filename);
      const res = await fetch(`${apiBase}/upload?language=${encodeURIComponent(lang)}`, { method:'POST', body: fd, headers: { 'Authorization': `Bearer ${token}` } });
      if (!res.ok) throw new Error(await res.text());
      const { job_id } = await res.json();
      console.log(`Upload successful, job_id: ${job_id}`);
      console.log(`Calling card.setJobId(${job_id})`);
      card.setJobId(job_id); 
      console.log(`Calling pollStatus(${apiBase}, ${job_id}, card)`);
      pollStatus(apiBase, job_id, card);
      showNotification(`📤 Файл загружен: ${filename}`,'success');
    } catch(e){ 
      console.error(`Upload error:`, e);
      card.setError('Ошибка загрузки: '+e.message); 
      showNotification('❌ Ошибка загрузки: '+e.message,'error'); 
    }
  }

  function makeJobCard({filename, lang}){
    console.log(`makeJobCard: ${filename}, ${lang}`);
    const el = document.createElement('div'); 
    el.className='card'; 
    el.innerHTML = `
      <div class="row">
        <strong>${filename}</strong>
        <span class="pill">lang=${lang}</span>
      </div>
      <div class="muted mono" style="margin-top:4px">job: <span class="jobid">—</span></div>
      <div class="progress-container" style="margin-top:12px"><div class="progress-bar" style="width:0%">0%</div></div>
      <div style="margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <span class="status-badge status-queued">В очереди</span>
        <span class="status-text muted">Ожидание обработки...</span>
      </div>
      <div class="process-details muted" style="margin-top:8px;font-size:12px"></div>
      <div class="results-section" style="margin-top:16px;display:none">
        <div class="result-content">
          <div class="result-section"><h4>🎯 Транскрипт</h4><div class="transcript-content"></div></div>
          <div class="result-section"><h4>📝 Саммари</h4><div class="summary-content"></div></div>
        </div>
        <div class="row" style="margin-top:12px;justify-content:center">
          <button class="btn btn-ghost btn-json">📥 Скачать JSON</button>
          <button class="btn btn-ghost btn-copy">📋 Скопировать саммари</button>
        </div>
      </div>`;

    const jobEl = el.querySelector('.jobid');
    const progressBar = el.querySelector('.progress-bar');
    const statusBadge = el.querySelector('.status-badge');
    const statusText = el.querySelector('.status-text');
    const processDetails = el.querySelector('.process-details');
    const resultsSection = el.querySelector('.results-section');
    const transcriptContent = el.querySelector('.transcript-content');
    const summaryContent = el.querySelector('.summary-content');
    const btnJson = el.querySelector('.btn-json');
    const btnCopy = el.querySelector('.btn-copy');
    let lastResult = null;
    
    console.log(`makeJobCard elements found:`, {
      jobEl: !!jobEl,
      progressBar: !!progressBar,
      statusBadge: !!statusBadge,
      statusText: !!statusText,
      processDetails: !!processDetails
    });

    function updateProgress(percent, status, details){
      console.log(`updateProgress: ${percent}%, status: ${status}, details: ${details}`);
      console.log(`Elements: progressBar=`, progressBar, `statusBadge=`, statusBadge, `statusText=`, statusText, `processDetails=`, processDetails);
      
      // Обновляем прогресс бар
      if (progressBar) {
        progressBar.style.width = percent + '%'; 
        progressBar.textContent = percent + '%';
        console.log(`Progress bar updated: width=${progressBar.style.width}, text=${progressBar.textContent}`);
        
        // Убираем все классы и добавляем нужный
        progressBar.className = 'progress-bar';
        if (status==='processing' || status==='queued') progressBar.classList.add('processing');
        else if (status==='transcribed_waiting_summary') progressBar.classList.add('transcribing');
        else if (status==='done') progressBar.classList.add('done');
        else if (status==='error') progressBar.classList.add('error');
        console.log(`Progress bar classes: ${progressBar.className}`);
      }

      // Обновляем статус бейдж
      if (statusBadge) {
        statusBadge.className = 'status-badge ' + (
          status==='queued' ? 'status-queued' :
          status==='processing' ? 'status-processing' :
          status==='transcribed_waiting_summary' ? 'status-transcribing' :
          status==='done' ? 'status-done' : 'status-error'
        );
        console.log(`Status badge classes: ${statusBadge.className}`);
        
        // Обновляем текст статуса
        const map = { 
          queued:'В очереди', 
          processing:'Обработка...', 
          transcribed_waiting_summary:'Транскрипция → саммари', 
          done:'Готово!', 
          error:'Ошибка' 
        };
        statusBadge.textContent = map[status] || status;
        console.log(`Status badge text: ${statusBadge.textContent}`);
      }
      
      // Обновляем детали процесса
      if (processDetails && details) {
        processDetails.innerHTML = details;
        console.log(`Process details: ${details}`);
      }
      
      // Обновляем текст статуса
      if (statusText) {
        const statusTextMap = {
          queued: 'Ожидание обработки...',
          processing: 'Обработка аудио...',
          transcribed_waiting_summary: 'Создание саммари...',
          done: 'Обработка завершена!',
          error: 'Произошла ошибка'
        };
        statusText.textContent = statusTextMap[status] || 'Неизвестный статус';
        console.log(`Status text: ${statusText.textContent}`);
      }
      
      console.log(`Final state: progressBar.width=${progressBar?.style.width}, statusBadge.text=${statusBadge?.textContent}, statusText.text=${statusText?.textContent}`);
    }

    const card = {
      el,
      setJobId(id){ 
        console.log(`setJobId: ${id}`); 
        console.log(`jobEl:`, jobEl);
        if (jobEl) jobEl.textContent=id; 
        console.log(`jobEl.textContent set to:`, jobEl?.textContent);
        console.log(`Calling updateProgress(14, 'queued', '📤 Файл загружен, ожидание в очереди...')`);
        updateProgress(14,'queued','📤 Файл загружен, ожидание в очереди...'); 
      },
      setStatus(status){
        console.log(`setStatus: ${status}`);
        console.log(`Calling updateProgress for status: ${status}`);
        
        if (status==='queued') {
          console.log(`Status is queued, calling updateProgress(22, 'queued', '📤 В очереди...')`);
          updateProgress(22, status, '📤 В очереди...');
        } else if (status==='processing') {
          console.log(`Status is processing, calling updateProgress(44, 'processing', '🔍 Обработка аудио...')`);
          updateProgress(44, status, '🔍 Обработка аудио...');
        } else if (status==='transcribed_waiting_summary') {
          console.log(`Status is transcribed_waiting_summary, calling updateProgress(72, 'transcribed_waiting_summary', '📝 Создание саммари...')`);
          updateProgress(72, status, '📝 Создание саммари...');
        } else if (status==='done') {
          console.log(`Status is done, calling updateProgress(100, 'done', '✅ Обработка завершена!')`);
          updateProgress(100, status, '✅ Обработка завершена!');
        } else if (status==='error') {
          console.log(`Status is error, calling updateProgress(0, 'error', '❌ Ошибка: ' + status)`);
          updateProgress(0, 'error', '❌ Ошибка: ' + status);
        } else {
          console.log(`Unknown status: ${status}, calling updateProgress(0, 'error', '❌ Неизвестный статус: ' + status)`);
          updateProgress(0, 'error', '❌ Неизвестный статус: ' + status);
        }
      },
      setError(msg){ 
        console.log(`setError: ${msg}`); 
        console.log(`Calling updateProgress(0, 'error', '❌ Ошибка: ' + msg)`);
        updateProgress(0,'error','❌ Ошибка: '+msg); 
        console.log(`Setting statusText.innerHTML to: <span class="warn">${msg}</span>`);
        if (statusText) statusText.innerHTML = `<span class="warn">${msg}</span>`; 
      },
      showResult(data){
        console.log(`showResult:`, data);
        console.log(`Setting lastResult and showing resultsSection`);
        lastResult = data; 
        if (resultsSection) resultsSection.style.display='block';
        
        const tr = data?.transcript;
        if (tr && transcriptContent) {
          console.log(`Transcript found:`, tr);
          transcriptContent.innerHTML = `
            <div style="margin-bottom:12px"><strong>Полный текст:</strong>
              <div style="background:rgba(2,6,23,.05);padding:8px;border-radius:8px;margin-top:6px;font-size:13px">${tr.text || 'Текст не найден'}</div>
            </div>
            <div><strong>Сегменты:</strong>
              <div style="max-height:200px;overflow:auto">${(tr.segments||[]).map(seg=>`
                <div style=\"background:#111f2e;padding:6px 8px;margin:4px 0;border-radius:6px;font-size:12px\">
                  <span class=\"muted\">${formatTime(seg.start)} - ${formatTime(seg.end)}</span><br>${seg.text}
                </div>`).join('')}</div>
            </div>`;
        } else {
          console.log(`No transcript found`);
        }
        
        const sm = data?.summary; 
        if (sm && summaryContent){
          console.log(`Summary found:`, sm);
          let html='';
          if (sm.meeting_summary) html += `<div style="margin-bottom:12px"><strong>📋 Резюме встречи:</strong><div style="background:#0f261b;padding:10px;border-radius:8px;margin-top:6px">${sm.meeting_summary}</div></div>`;
          if (sm.key_points?.length) html += `<div style="margin-bottom:12px"><strong>🎯 Ключевые моменты:</strong>${sm.key_points.map(p=>`<div class=\"key-point\">${p}</div>`).join('')}</div>`;
          if (sm.action_items?.length) html += `<div style="margin-bottom:12px"><strong>✅ Задачи и действия:</strong>${sm.action_items.map(it=>`<div class=\"action-item\"><strong>${it.owner||'Не указан'}</strong>: ${it.task||'—'} ${it.due?`<br><small>Срок: ${it.due}</small>`:''}</div>`).join('')}</div>`;
          if (sm.risks?.length) html += `<div style="margin-bottom:12px"><strong>⚠️ Риски:</strong>${sm.risks.map(r=>`<div class=\"risk-item\">${r}</div>`).join('')}</div>`;
          if (sm.raw && !sm.meeting_summary) html += `<div style="margin-bottom:12px"><strong>📄 Сырой результат:</strong><div style="background:rgba(2,6,23,.05);padding:10px;border-radius:8px;white-space:pre-wrap">${sm.raw}</div></div>`;
          summaryContent.innerHTML = html || '<em>Саммари не найдено</em>';
          console.log(`Summary HTML set:`, html);
        } else {
          console.log(`No summary found`);
        }
        
        console.log(`Setting up button handlers`);
        if (btnJson) btnJson.onclick = () => { const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`result_${data.job_id}.json`; a.click(); URL.revokeObjectURL(a.href); showNotification('📥 JSON скачан','success'); };
        if (btnCopy) btnCopy.onclick = async () => { try { const text = summaryContent?.textContent||''; await navigator.clipboard.writeText(text); btnCopy.textContent='📋 Скопировано!'; setTimeout(()=>btnCopy.textContent='📋 Скопировать саммари',1800); showNotification('📋 Саммари скопировано','success'); } catch(_) { showNotification('❌ Не удалось скопировать','error'); } };
      }
    };
    
    console.log(`makeJobCard returning object with methods:`, Object.keys(card));
    
    return card;
  }

  function formatTime(seconds){ 
    console.log(`formatTime: ${seconds}`); 
    const m=Math.floor(seconds/60); 
    const s=Math.floor(seconds%60); 
    const result = `${m}:${String(s).padStart(2,'0')}`; 
    console.log(`formatTime result: ${result}`); 
    return result; 
  }

  // Toasts
  function showNotification(message, type='info'){
    console.log(`showNotification: ${message} (${type})`);
    const colors = { info: ['#0ea5e9','#0284c7'], success:['#22c55e','#16a34a'], warn:['#f59e0b','#d97706'], error:['#ef4444','#b91c1c'] };
    const bg = colors[type]||colors.info;
    const el = document.createElement('div');
    el.style.cssText = `position:fixed;top:20px;right:20px;z-index:1000;max-width:340px;padding:14px 16px;border-radius:12px;color:white;box-shadow:var(--shadow);background:linear-gradient(135deg, ${bg[0]}, ${bg[1]});backdrop-filter:blur(6px);animation:toastIn .22s ease;`;
    el.textContent = message; document.body.appendChild(el);
    if (!document.querySelector('#toast-anim')){
      const s=document.createElement('style'); s.id='toast-anim'; s.textContent=`@keyframes toastIn{from{transform:translateX(12px);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes toastOut{from{transform:translateX(0);opacity:1}to{transform:translateX(12px);opacity:0}}`; document.head.appendChild(s);
    }
    const close = ()=>{ el.style.animation='toastOut .2s ease'; setTimeout(()=> el.remove(), 180); };
    setTimeout(close, 4200); el.onclick = close;
  }

  async function pollStatus(apiBase, jobId, card){
    console.log(`pollStatus started for job ${jobId}`);
    card.setStatus('processing'); 
    let done=false; 
    let attempts=0; 
    const token = localStorage.getItem('plaud_jwt_token');
    if (!token) { console.error('No JWT token'); return; }
    showNotification('🔄 Обработка аудио...','info');
    
    const tick = async () => {
      attempts++;
      console.log(`pollStatus tick ${attempts} for job ${jobId}`);
      
      try {
        const s = await fetch(`${apiBase}/status/${jobId}`, { headers:{ 'Authorization': `Bearer ${token}` } }).then(r=>r.json());
        
        // Обновляем статус с деталями процесса
        console.log(`Job ${jobId}: status = ${s.status}, attempt = ${attempts}`);
        
        if (s.status === 'queued') {
          card.setStatus('queued');
        } else if (s.status === 'processing') {
          card.setStatus('processing');
        } else if (s.status === 'transcribed_waiting_summary') {
          card.setStatus('transcribed_waiting_summary');
          showNotification('📝 Транскрипция готова, создаю саммари...','info');
        } else if (s.status === 'done') {
          card.setStatus('done');
          try {
            const out = await fetch(`${apiBase}/result/${jobId}`, { headers:{ 'Authorization': `Bearer ${token}` } }).then(r=>r.json());
            console.log(`Result fetched:`, out);
            card.showResult(out); 
            done=true; 
            document.getElementById('results').style.display='block'; 
            addToResultsList(out, card.el.querySelector('strong').textContent); 
            console.log(`Calling completeJob()`);
            completeJob(); 
            showNotification(`✅ Готово: ${card.el.querySelector('strong').textContent}`,'success');
          } catch(e){ card.setError('Ошибка результата: '+e.message); showNotification('❌ Ошибка результата: '+e.message,'error'); done=true; }
        } else if (s.status === 'error') { 
          card.setError('Ошибка обработки'); 
          showNotification('❌ Ошибка обработки','error'); 
          done=true; 
        } else {
          console.warn(`Unknown status: ${s.status}`);
          card.setStatus(s.status);
        }
        
        // Определяем задержку для следующего опроса
        if (!done) {
          const delay = s?.status==='processing' ? 1500 : 2000;
          console.log(`Next tick in ${delay}ms for job ${jobId}`);
          setTimeout(tick, delay);
        }
      } catch (e) {
        console.error(`pollStatus error for job ${jobId}:`, e);
        if (attempts>10) { 
          card.setError('Ошибка соединения: '+e.message); 
          showNotification('❌ Ошибка соединения: '+e.message,'error'); 
          done=true; 
        } else {
          // Повторяем попытку через 3 секунды при ошибке
          console.log(`Retrying in 3000ms for job ${jobId} (attempt ${attempts})`);
          setTimeout(tick, 3000);
        }
      }
    };
    tick();
  }

  function addToResultsList(data, filename){
    console.log(`addToResultsList: ${filename}`, data);
    const resultsList = $('#resultsList');
    const resultCard = document.createElement('div'); resultCard.className='result-card';
    const tr=data?.transcript, sm=data?.summary;
    resultCard.innerHTML = `
      <div class="result-header">
        <div class="result-title">📁 ${filename}</div>
        <div class="result-meta">Job ID: ${data.job_id}<br>${new Date().toLocaleString('ru-RU')}</div>
      </div>
      <div class="result-content">
        <div class="result-section"><h4>🎯 Транскрипт</h4>
          <div style="max-height:300px;overflow:auto">
            ${tr ? `
              <div style="margin-bottom:10px"><strong>Полный текст:</strong>
                <div style="background:rgba(2,6,23,.05);padding:8px;border-radius:8px;margin-top:6px;font-size:13px">${tr.text || 'Текст не найден'}</div>
              </div>
              <div><strong>Сегменты (${tr.segments?.length||0}):</strong>
                <div style="max-height:150px;overflow:auto">${(tr.segments||[]).map(seg=>`
                  <div style=\"background:#111f2e;padding:6px 8px;margin:4px 0;border-radius:6px;font-size:12px\">
                    <span class=\"muted\">${formatTime(seg.start)} - ${formatTime(seg.end)}</span><br>${seg.text}
                  </div>`).join('')}</div>
              </div>` : '<em>Транскрипт не найден</em>'}
          </div>
        </div>
        <div class="result-section"><h4>📝 Саммари</h4>
          <div style="max-height:300px;overflow:auto">
            ${sm ? `
              ${sm.meeting_summary ? `<div style=\"margin-bottom:10px\"><strong>📋 Резюме встречи:</strong><div style=\"background:#0f261b;padding:8px;border-radius:8px;margin-top:6px\">${sm.meeting_summary}</div></div>` : ''}
              ${sm.key_points?.length ? `<div style=\"margin-bottom:10px\"><strong>🎯 Ключевые моменты:</strong>${sm.key_points.map(p=>`<div class=\\\"key-point\\\">${p}</div>`).join('')}</div>` : ''}
              ${sm.action_items?.length ? `<div style=\"margin-bottom:10px\"><strong>✅ Задачи и действия:</strong>${sm.action_items.map(it=>`<div class=\\\"action-item\\\"><strong>${it.owner||'Не указан'}</strong>: ${it.task||'—'} ${it.due?`<br><small>Срок: ${it.due}</small>`:''}</div>`).join('')}</div>` : ''}
              ${sm.risks?.length ? `<div style=\"margin-bottom:10px\"><strong>⚠️ Риски:</strong>${sm.risks.map(r=>`<div class=\\\"risk-item\\\">${r}</div>`).join('')}</div>` : ''}
              ${sm.raw && !sm.meeting_summary ? `<div style=\"margin-bottom:10px\"><strong>📄 Сырой результат:</strong><div style=\"background:rgba(2,6,23,.05);padding:10px;border-radius:8px;white-space:pre-wrap\">${sm.raw}</div></div>` : ''}
            ` : '<em>Саммари не найдено</em>'}
          </div>
        </div>
      </div>
      <div style="text-align:center;margin-top:12px">
        <button onclick="downloadResult('${data.job_id}', ${JSON.stringify(data).replace(/"/g,'&quot;')})" class="btn btn-ghost" style="margin-right:6px">📥 Скачать JSON</button>
        <button onclick="copySummary(${JSON.stringify(sm).replace(/"/g,'&quot;')})" class="btn btn-ghost">📋 Скопировать саммари</button>
      </div>`;
    resultsList.insertBefore(resultCard, resultsList.firstChild);
    console.log(`Result card added to results list`);
  }

  // Overall progress
  let totalJobs=0, completedJobs=0;
  function updateOverallProgress(){
    const overall=$('#overallProgress'); 
    const bar=$('#overallProgressBar'); 
    const stats=$('#progressStats');
    
    console.log(`updateOverallProgress: ${completedJobs}/${totalJobs} = ${Math.round((completedJobs/totalJobs)*100)}%`);
    
    if (totalJobs>0){ 
      overall.style.display='block'; 
      const pct=Math.round((completedJobs/totalJobs)*100); 
      bar.style.width=pct+'%'; 
      bar.textContent=pct+'%'; 
      stats.textContent=`${completedJobs}/${totalJobs} завершено`;
      
      // Убираем все классы и добавляем нужный
      bar.className='progress-bar'; 
      if (pct<30) bar.classList.add('processing'); 
      else if (pct<70) bar.classList.add('transcribing'); 
      else if (pct<100) bar.classList.add('summarizing'); 
      else bar.classList.add('done');
      
      console.log(`Overall progress bar: width=${bar.style.width}, class=${bar.className}`);
    } else { 
      overall.style.display='none'; 
    }
  }
  function addJob(){ 
    totalJobs++; 
    console.log(`addJob: totalJobs=${totalJobs}`); 
    updateOverallProgress(); 
  }
  function completeJob(){ 
    completedJobs++; 
    console.log(`completeJob: completedJobs=${completedJobs}`); 
    updateOverallProgress(); 
  }

  // Global buttons for results
  window.downloadResult = function(jobId, data){ 
    console.log(`downloadResult: ${jobId}`, data); 
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); 
    const a=document.createElement('a'); 
    a.href=URL.createObjectURL(blob); 
    a.download=`result_${jobId}.json`; 
    a.click(); 
    URL.revokeObjectURL(a.href); 
    showNotification('📥 JSON скачан','success'); 
  };
  window.copySummary = function(summary){ 
    console.log(`copySummary:`, summary); 
    let t=''; 
    if (!summary) return; 
    if (summary.meeting_summary) t+=`Резюме встречи:\n${summary.meeting_summary}\n\n`; 
    if (summary.key_points?.length) t+=`Ключевые моменты:\n${summary.key_points.map(p=>`- ${p}`).join('\n')}\n\n`; 
    if (summary.action_items?.length) t+=`Задачи и действия:\n${summary.action_items.map(i=>`- ${i.owner||'Не указан'}: ${i.task||'—'}${i.due?` (до ${i.due})`:''}`).join('\n')}\n\n`; 
    if (summary.risks?.length) t+=`Риски:\n${summary.risks.map(r=>`- ${r}`).join('\n')}\n\n`; 
    if (summary.raw && !summary.meeting_summary) t+=summary.raw; 
    navigator.clipboard.writeText(t).then(()=>showNotification('📋 Саммари скопировано!','success')).catch(()=>showNotification('❌ Не удалось скопировать','error')); 
  };
  window.clearResults = function(){ 
    if (confirm('Очистить все результаты?')) { 
      console.log(`Clearing results`); 
      $('#resultsList').innerHTML=''; 
      $('#results').style.display='none'; 
      totalJobs=0; 
      completedJobs=0; 
      updateOverallProgress(); 
      showNotification('🗑️ Результаты очищены','success'); 
    } 
  };

  // ===== History =====
  $('#btnLoadHistory').onclick = async ()=>{
    console.log(`Load history button clicked`);
    if (!await checkAuth()) { 
      showNotification('❌ Нет авторизации','error'); 
      return; 
    } 
    await loadHistory(); 
  };
  $('#btnClearHistory').onclick = () => { 
    console.log(`Clear history button clicked`);
    if (confirm('Очистить историю на экране?')) { 
      $('#historyList').innerHTML=''; 
      $('#historyContainer').style.display='none'; 
      showNotification('🗑️ История очищена','success'); 
    } 
  };

  async function loadHistory(){
    console.log(`loadHistory called`);
    const token = localStorage.getItem('plaud_jwt_token');
    if (!token) { showNotification('⚠️ Войдите в систему','warn'); return; }
    
    try{
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`; 
      showNotification('📚 Загружаю историю...','info');
      const resp = await fetch(`${apiBase}/history`, { headers: { 'Authorization': `Bearer ${token}` } }); 
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json(); 
      console.log(`History data:`, data);
      displayHistory(data.jobs); 
      showNotification(`📚 Загружено ${data.jobs.length} задач`, 'success');
    }catch(e){ showNotification('❌ Ошибка истории: '+e.message,'error'); }
  }

  function displayHistory(jobsArr){
    console.log(`displayHistory:`, jobsArr);
    const list=$('#historyList'); const cont=$('#historyContainer');
    if (!jobsArr?.length){ 
      console.log(`No jobs to display`);
      list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">История пуста</div>'; 
      cont.style.display='block'; 
      return; 
    }
    let html='';
    jobsArr.forEach(job=>{
      const statusClass = getStatusClass(job.status); const statusText = getStatusText(job.status);
      const createdAt = job.created_at ? new Date(job.created_at*1000).toLocaleString('ru-RU') : 'Неизвестно';
      html += `
        <div class="card" style="margin:12px 0">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px">
            <div>
              <strong>📁 ${job.filename || 'Без названия'}</strong>
              <div class="muted" style="font-size:12px;margin-top:4px">Job ID: ${job.job_id}<br>Язык: ${job.language||'—'} • Создано: ${createdAt}</div>
            </div>
            <div style="text-align:right">
              <span class="status-badge ${statusClass}">${statusText}</span>
              <div class="muted" style="font-size:12px;margin-top:6px">${job.has_transcript ? '✅ Транскрипт' : '❌ Транскрипт'} • ${job.has_summary ? '✅ Саммари' : '❌ Саммари'}</div>
            </div>
          </div>
          <div class="row" style="justify-content:center">
            <button onclick="viewJobDetails('${job.job_id}')" class="btn">👁️ Просмотреть</button>
            <button onclick="downloadJobResult('${job.job_id}')" class="btn">📥 Скачать</button>
            <button onclick="deleteJob('${job.job_id}')" class="btn btn-danger">🗑️ Удалить</button>
          </div>
        </div>`;
    });
    list.innerHTML = html; cont.style.display='block';
    console.log(`History displayed, ${jobsArr.length} jobs`);
  }

  function getStatusClass(status){ 
    console.log(`getStatusClass: ${status}`); 
    switch(status){ 
      case 'done': return 'status-done'; 
      case 'transcribed_waiting_summary': return 'status-transcribing'; 
      case 'processing': return 'status-processing'; 
      default: return 'status-queued'; 
    } 
  }
  function getStatusText(status){ 
    console.log(`getStatusText: ${status}`); 
    switch(status){ 
      case 'done': return 'Готово'; 
      case 'transcribed_waiting_summary': return 'Транскрипция'; 
      case 'processing': return 'Обработка'; 
      default: return 'Неизвестно'; 
    } 
  }

  window.viewJobDetails = async function(jobId){
    console.log(`viewJobDetails: ${jobId}`);
    const token = localStorage.getItem('plaud_jwt_token');
    if (!token) { showNotification('⚠️ Войдите в систему','warn'); return; }
    
    try{ 
      const apiBase=apiBaseInput.value || `${location.protocol}//${location.host}`; 
      const r=await fetch(`${apiBase}/history/${jobId}`, { headers:{ 'Authorization': `Bearer ${token}` } }); 
      if (!r.ok) throw new Error(`HTTP ${r.status}`); 
      const jobData = await r.json(); 
      console.log(`Job data:`, jobData);
      showJobDetailsModal(jobData); 
    }
    catch(e){ showNotification('❌ Ошибка деталей: '+e.message,'error'); }
  };

  window.downloadJobResult = async function(jobId){
    console.log(`downloadJobResult: ${jobId}`);
    const token = localStorage.getItem('plaud_jwt_token');
    if (!token) { showNotification('⚠️ Войдите в систему','warn'); return; }
    
    try{ 
      const apiBase=apiBaseInput.value || `${location.protocol}//${location.host}`; 
      const r=await fetch(`${apiBase}/result/${jobId}`, { headers:{ 'Authorization': `Bearer ${token}` } }); 
      if (!r.ok) throw new Error(`HTTP ${r.status}`); 
      const data=await r.json(); 
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); 
      const a=document.createElement('a'); 
      a.href=URL.createObjectURL(blob); 
      a.download=`job_${jobId}_result.json`; 
      a.click(); 
      URL.revokeObjectURL(a.href); 
      showNotification('📥 Результат скачан','success'); 
    }
    catch(e){ showNotification('❌ Ошибка скачивания: '+e.message,'error'); }
  };

  window.deleteJob = async function(jobId){
    console.log(`deleteJob: ${jobId}`);
    if (!confirm(`Удалить задачу ${jobId}? Это действие нельзя отменить.`)) return;
    const token = localStorage.getItem('plaud_jwt_token');
    if (!token) { showNotification('⚠️ Войдите в систему','warn'); return; }
    
    try{ 
      const apiBase=apiBaseInput.value || `${location.protocol}//${location.host}`; 
      const r=await fetch(`${apiBase}/history/${jobId}`, { method:'DELETE', headers:{ 'Authorization': `Bearer ${token}` } }); 
      if (!r.ok) throw new Error(`HTTP ${r.status}`); 
      showNotification('🗑️ Задача удалена','success'); 
      await loadHistory(); 
    }
    catch(e){ showNotification('❌ Ошибка удаления: '+e.message,'error'); }
  };

  function showJobDetailsModal(job){
    console.log(`showJobDetailsModal:`, job);
    const modal=document.createElement('div'); modal.className='modal-overlay';
    const card=document.createElement('div'); card.className='modal-card';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;border-bottom:1px dashed var(--border);padding-bottom:12px">
        <h2 style="margin:0">📋 Детали задачи</h2>
        <button class="btn btn-icon" onclick="this.closest('.modal-overlay').remove()">✖</button>
      </div>
      <div class="muted" style="margin-bottom:12px"><strong>Файл:</strong> ${job.filename||'—'} • <strong>Job:</strong> ${job.job_id} • <strong>Язык:</strong> ${job.language||'—'} • <strong>Статус:</strong> <span class="status-badge ${getStatusClass(job.status)}">${getStatusText(job.status)}</span></div>
      ${job.transcript ? `
        <div class="result-section" style="margin-bottom:12px">
          <h4>🎯 Транскрипт</h4>
          <div style="max-height:220px;overflow:auto"><strong>Полный текст:</strong><br>${job.transcript.text||'—'}</div>
          ${job.transcript.segments ? `<div style=\"margin-top:10px\"><strong>Сегменты (${job.transcript.segments.length})</strong><div style=\"max-height:150px;overflow:auto\">${job.transcript.segments.map(seg=>`<div style='background:#111f2e;padding:6px 8px;margin:4px 0;border-radius:6px;font-size:12px'><span class=muted>${formatTime(seg.start)} - ${formatTime(seg.end)}</span><br>${seg.text}</div>`).join('')}</div></div>`: ''}
        </div>` : ''}
      ${job.summary ? `
        <div class="result-section">
          <h4>📝 Саммари</h4>
          ${job.summary.meeting_summary ? `<div style=\"background:#0f261b;padding:10px;border-radius:8px;margin-bottom:10px\"><strong>📋 Резюме встречи:</strong><br>${job.summary.meeting_summary}</div>` : ''}
          ${job.summary.key_points?.length ? `<div style=\"margin-bottom:10px\"><strong>🎯 Ключевые моменты:</strong>${job.summary.key_points.map(p=>`<div class=\\\"key-point\\\">${p}</div>`).join('')}</div>` : ''}
          ${job.summary.action_items?.length ? `<div style=\"margin-bottom:10px\"><strong>✅ Задачи и действия:</strong>${job.summary.action_items.map(i=>`<div class=\\\"action-item\\\"><strong>${i.owner||'—'}</strong>: ${i.task||'—'} ${i.due?`<br><small>Срок: ${i.due}</small>`:''}</div>`).join('')}</div>` : ''}
          ${job.summary.risks?.length ? `<div style=\"margin-bottom:10px\"><strong>⚠️ Риски:</strong>${job.summary.risks.map(r=>`<div class=\\\"risk-item\\\">${r}</div>`).join('')}</div>` : ''}
          ${job.summary.raw && !job.summary.meeting_summary ? `<div style=\"background:rgba(2,6,23,.05);padding:10px;border-radius:8px\"><strong>📄 Сырой результат:</strong><pre style=\"white-space:pre-wrap;margin:8px 0;font-size:12px\">${job.summary.raw}</pre></div>` : ''}
        </div>` : ''}
      <div style="text-align:center;margin-top:14px"><button class="btn" onclick="downloadJobResult('${job.job_id}')">📥 Скачать JSON</button> <button class="btn" onclick="this.closest('.modal-overlay').remove()">Закрыть</button></div>`;
    modal.appendChild(card); document.body.appendChild(modal);
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  }

  // Initialize auth UI on page load
  updateAuthUI();
  
  // Check authentication status on page load
  checkAuth();
  
  // Set up periodic auth check (every 5 minutes)
  setInterval(() => {
    const token = localStorage.getItem('plaud_jwt_token');
    if (token) {
      console.log('Periodic auth check...');
      checkAuth().then(isValid => {
        if (!isValid) {
          // Token is invalid, update UI
          updateKeyStatus('Токен истек', 'warn');
          updateAuthUI();
          showNotification('🔑 Токен авторизации истек. Войдите снова.', 'warn');
        }
      });
    }
  }, 5 * 60 * 1000); // 5 minutes
  
})();
</script>
</body>
</html>
