<!doctype html>
<html lang="ru" data-theme="light">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="color-scheme" content="light dark"/>
  <title>–ê—É–¥–∏–æ ‚Üí –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è + –°–∞–º–º–∞—Ä–∏</title>
  <style>
    /* =============================
       Modern theme with variables
       ============================= */
    :root {
      --bg: #0b0f14;
      --panel: rgba(255, 255, 255, 0.7);
      --card: rgba(255, 255, 255, 0.65);
      --text: #0f172a;
      --muted: #6b7280;
      --border: rgba(15,23,42,.08);
      --ring: rgba(99,102,241,.25);
      --primary: #6366f1; /* indigo-500 */
      --primary-600: #4f46e5;
      --primary-700: #4338ca;
      --success: #16a34a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --shadow: 0 10px 30px rgba(2,6,23,.15);
      --radius: 14px;
      --radius-sm: 10px;
      --radius-xl: 22px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Segoe UI Variable", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    [data-theme="dark"] {
      --bg: #0b0f14;
      --panel: rgba(17, 24, 39, 0.6);
      --card: rgba(17, 24, 39, 0.55);
      --text: #e5e7eb;
      --muted: #94a3b8;
      --border: rgba(255,255,255,.06);
      --ring: rgba(99,102,241,.35);
      --shadow: 0 14px 40px rgba(0,0,0,.45);
    }

    /* Background candy */
    body {
      margin: 0;
      font-family: var(--font);
      color: var(--text);
      background:
        radial-gradient(1000px 600px at 0% 10%, rgba(99,102,241,.15), transparent 60%),
        radial-gradient(1000px 600px at 100% 0%, rgba(56,189,248,.12), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.6));
      min-height: 100dvh;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    [data-theme="dark"] body { background:
        radial-gradient(1000px 600px at 0% 10%, rgba(99,102,241,.25), transparent 60%),
        radial-gradient(1000px 600px at 100% 0%, rgba(56,189,248,.2), transparent 60%),
        linear-gradient(180deg, rgba(2,6,23,.85), rgba(2,6,23,.85)); }

    .container { max-width: 1100px; margin: 24px auto 80px; padding: 0 18px; }

    /* Top navbar */
    .nav {
      position: sticky; top: 0; z-index: 50; backdrop-filter: saturate(140%) blur(12px);
      background: var(--panel); border-bottom: 1px solid var(--border);
    }
    .nav-inner { display:flex; align-items:center; justify-content:space-between; gap:12px; padding: 12px 18px; max-width: 1100px; margin: 0 auto; }
    .brand { display:flex; align-items:center; gap:12px; font-weight: 700; letter-spacing:.3px; }
    .brand .logo { width: 32px; height: 32px; border-radius: 10px; background: linear-gradient(135deg, var(--primary), #22d3ee); display:grid; place-items:center; color:white; box-shadow: var(--shadow);}
    .brand small { font-weight: 500; opacity:.75; }

    .toolbar { display:flex; gap:8px; align-items:center; }

    /* Buttons */
    button, .btn { appearance: none; border: 1px solid var(--border); background: rgba(255,255,255,.6); color: var(--text);
      padding: 10px 14px; border-radius: var(--radius-sm); cursor: pointer; transition: .2s ease; box-shadow: 0 1px 0 rgba(2,6,23,.04);
      backdrop-filter: blur(6px); }
    [data-theme="dark"] button { background: rgba(15,23,42,.55); }
    button:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(2,6,23,.12); }
    button:active { transform: translateY(0); box-shadow: 0 2px 10px rgba(2,6,23,.08); }

    .btn-primary { background: linear-gradient(135deg, var(--primary), var(--primary-700)); color: #fff; border-color: transparent; box-shadow: 0 10px 20px rgba(79,70,229,.35); }
    .btn-primary:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .btn-danger { background: linear-gradient(135deg, #ef4444, #b91c1c); color:#fff; border-color: transparent; }
    .btn-ghost { background: transparent; }
    .btn-icon { width: 40px; height: 40px; display:grid; place-items:center; border-radius: 12px; }

    /* Cards / glass */
    .card { border:1px solid var(--border); border-radius: var(--radius); padding: 16px; margin: 14px 0; box-shadow: var(--shadow);
            background: var(--card); }

    h1 { font-size: clamp(1.25rem, 1.2rem + 1vw, 1.9rem); margin: 14px 0; }
    h3 { margin: 0 0 8px; font-size: 1.05rem; }
    .muted { color: var(--muted); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center }
    .mono { font-family: var(--mono); }

    input, select { border:1px solid var(--border); border-radius: 10px; padding: 10px 12px; background: rgba(255,255,255,.7); color: var(--text);
                    transition: .2s ease; }
    [data-theme="dark"] input, [data-theme="dark"] select { background: rgba(15,23,42,.55); }
    input:focus, select:focus { outline: none; box-shadow: 0 0 0 6px var(--ring); border-color: var(--primary); }

    /* Pills & badges */
    .pill { display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius: 999px; padding: 6px 10px; background: rgba(255,255,255,.55); }
    .ok { color: var(--success); } .warn { color: #b45309; }

    /* Progress */
    .progress-container { width: 100%; background: rgba(2,6,23,.06); border-radius: 999px; overflow: hidden; border: 1px solid var(--border); }
    .progress-bar { height: 18px; background: linear-gradient(90deg, var(--primary), #22d3ee); transition: width .35s ease; display:flex; align-items:center; justify-content:center; color:white; font-size: 12px; font-weight: 700; letter-spacing: .2px; }
    .progress-bar.processing { background: linear-gradient(90deg, #22d3ee, var(--primary)); }
    .progress-bar.transcribing { background: linear-gradient(90deg, #f59e0b, #fb923c); }
    .progress-bar.summarizing { background: linear-gradient(90deg, #a855f7, #7c3aed); }
    .progress-bar.done { background: linear-gradient(90deg, #22c55e, #16a34a); }
    .progress-bar.error { background: linear-gradient(90deg, #ef4444, #dc2626); }

    /* Status chips */
    .status-badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing:.6px; }
    .status-queued { background: #e0e7ff; color:#3730a3; }
    .status-processing { background: #cffafe; color:#0e7490; }
    .status-transcribing { background: #fef3c7; color:#b45309; }
    .status-summarizing { background: #f3e8ff; color:#6d28d9; }
    .status-done { background: #dcfce7; color:#166534; }
    .status-error { background: #fee2e2; color:#991b1b; }

    /* Result blocks */
    .result-card { border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin: 16px 0; background: var(--card); transition: .25s ease; }
    .result-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); border-color: rgba(99,102,241,.35); }
    .result-header { display:flex; justify-content:space-between; align-items:center; gap:14px; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px dashed var(--border); }
    .result-title { font-size: 18px; font-weight: 800; }
    .result-meta { font-size: 12px; color: var(--muted); }
    .result-content { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    @media (max-width: 900px) { .result-content { grid-template-columns: 1fr; } }
    .result-section { background: rgba(255,255,255,.55); padding: 14px; border: 1px solid var(--border); border-radius: 12px; }
    [data-theme="dark"] .result-section { background: rgba(15,23,42,.45); }
    .result-section h4 { margin: 0 0 10px; font-size: 13px; font-weight: 800; letter-spacing: .6px; text-transform: uppercase; }

    .action-item { background: rgba(2,6,23,.05); padding: 8px 10px; margin: 6px 0; border-radius: 8px; border-left: 3px solid var(--primary); }
    .key-point { background: #fff7ed; padding: 8px 10px; margin: 6px 0; border-radius: 8px; border-left: 3px solid #fb923c; }
    .risk-item { background: #fef2f2; padding: 8px 10px; margin: 6px 0; border-radius: 8px; border-left: 3px solid #ef4444; }

    pre { white-space: pre-wrap; background: rgba(2,6,23,.05); border-radius: 10px; padding: 12px; overflow:auto; }

    /* Upload Dropzone */
    .dropzone { margin-top: 10px; border: 2px dashed var(--border); border-radius: var(--radius); padding: 18px; display:grid; place-items:center; text-align:center; transition: .2s ease; background: rgba(255,255,255,.4); }
    [data-theme="dark"] .dropzone { background: rgba(15,23,42,.4); }
    .dropzone.dragover { border-color: var(--primary); box-shadow: 0 0 0 6px var(--ring); transform: translateY(-1px); }

    /* Level Meter */
    .level-wrap { display:flex; align-items:center; gap:10px; margin-top:8px; }
    .level-bar { flex:1; height: 10px; border-radius: 999px; background: rgba(2,6,23,.08); overflow:hidden; border: 1px solid var(--border); }
    .level-inner { height: 100%; width: 0%; background: linear-gradient(90deg, #22d3ee, var(--primary)); transition: width .08s linear; }
    .level-num { font-variant-numeric: tabular-nums; width: 54px; text-align: right; }

    /* Modal (for job details) */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.5); z-index: 60; display:flex; align-items:center; justify-content:center; padding: 20px; }
    .modal-card { width:min(900px, 94vw); max-height: 90vh; overflow:auto; background: var(--card); border:1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow); padding: 20px; }

    /* Inline help */
    .kbd { font-family: var(--mono); font-size: 12px; padding: 2px 6px; border-radius: 6px; border: 1px solid var(--border); background: rgba(255,255,255,.6); }

    /* Footer */
    .footer { text-align:center; color: var(--muted); font-size: 12px; margin: 24px 0; }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <div class="nav">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo">üéß</div>
        <div>
          Audio ‚Üí Whisper ‚Üí DeepSeek<br/>
          <small class="muted">–ó–∞–ø–∏—Å—å, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è, —Å–∞–º–º–∞—Ä–∏ ‚Äî –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ</small>
        </div>
      </div>
      <div class="toolbar">
        <button id="loginBtn" class="btn btn-ghost">üîë –í–æ–π—Ç–∏</button>
        <button id="usersBtn" class="btn btn-ghost" style="display:none">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</button>
        <button id="helpBtn" class="btn btn-ghost">‚ùì –ü–æ–¥—Å–∫–∞–∑–∫–∏</button>
        <button id="themeToggle" class="btn btn-icon" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É" aria-label="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">üåû</button>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div id="loginModal" class="modal-overlay" style="display:none">
    <div class="modal-card" style="max-width:400px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;border-bottom:1px dashed var(--border);padding-bottom:12px">
        <h2 style="margin:0">üîë –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
        <button class="btn btn-icon" id="closeLoginModalBtn">‚úñ</button>
      </div>
      <form id="loginForm">
        <div style="margin-bottom:12px">
          <label for="loginUsername" style="display:block;margin-bottom:4px;font-weight:600">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
          <input id="loginUsername" type="text" required style="width:100%;box-sizing:border-box" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
        </div>
        <div style="margin-bottom:16px">
          <label for="loginPassword" style="display:block;margin-bottom:4px;font-weight:600">–ü–∞—Ä–æ–ª—å</label>
          <input id="loginPassword" type="password" required style="width:100%;box-sizing:border-box" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
        </div>
        <div style="display:flex;gap:8px;justify-content:space-between;align-items:center">
          <button type="submit" class="btn btn-primary" style="flex:1">–í–æ–π—Ç–∏</button>
          <button type="button" class="btn btn-ghost" id="cancelLoginBtn">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
      <div id="loginError" style="color:var(--danger);margin-top:12px;display:none;font-size:14px"></div>
    </div>
  </div>

  <!-- USERS MANAGEMENT MODAL -->
  <div id="usersModal" class="modal-overlay" style="display:none">
    <div class="modal-card" style="max-width:800px;max-height:80vh;overflow-y:auto">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;border-bottom:1px dashed var(--border);padding-bottom:12px">
        <h2 style="margin:0">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
        <button class="btn btn-icon" id="closeUsersModalBtn">‚úñ</button>
      </div>
      <div id="usersList" style="margin-bottom:16px">
        <div style="text-align:center;padding:20px;color:var(--muted)">
          –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...
        </div>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn btn-ghost" id="refreshUsersBtn">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
        <button class="btn btn-ghost" id="cancelUsersBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="container">
    <h1>–ó–∞–ø–∏—Å—å/–∑–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ ‚Üí Whisper ‚Üí DeepSeek</h1>

    <!-- OVERALL PROGRESS -->
    <div id="overallProgress" style="display:none" class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;gap:10px;">
        <strong>üìà –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏</strong>
        <span id="progressStats">0/0 –∑–∞–≤–µ—Ä—à–µ–Ω–æ</span>
      </div>
      <div class="progress-container"><div id="overallProgressBar" class="progress-bar" style="width:0%">0%</div></div>
    </div>

    <!-- SETTINGS -->
    <div class="card">
      <h3>‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h3>
      <div class="row">
        <label>API base:</label>
        <input id="apiBase" class="mono" style="min-width:320px" value="" placeholder="http://localhost:8000">
        <label>–Ø–∑—ã–∫:</label>
        <select id="lang"><option value="ru" selected>ru</option><option value="en">en</option></select>
      </div>
      <div class="row" style="margin-top:8px">
        <span id="keyStatus" class="muted">–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ API</span>
      </div>
      <div class="muted" style="margin-top:6px">
        –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä—ë—Ç—Å—è —Ç–µ–∫—É—â–∏–π origin. –ï—Å–ª–∏ API –Ω–∞ –¥—Ä—É–≥–æ–º —Ö–æ—Å—Ç–µ/–ø–æ—Ä—Ç—É ‚Äî —É–∫–∞–∂–∏: <span class="mono">http://localhost:8000</span>
      </div>
    </div>

    <!-- RECORD -->
    <div class="card">
      <h3>üéôÔ∏è –ó–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–±—Ä–∞—É–∑–µ—Ä)</h3>
      <div class="row">
        <label>–ú–∏–∫—Ä–æ—Ñ–æ–Ω:</label>
        <select id="micSelect" style="min-width:240px"><option value="">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä</option></select>
        <button id="btnRefreshMics" class="btn" title="–û–±–Ω–æ–≤–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnStart" class="btn-primary">‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
        <button id="btnStop" class="btn" disabled>‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
        <button id="btnTestMic" class="btn">üé§ –¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</button>
        <span id="recStatus" class="pill muted">–Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è</span>
      </div>
      <div id="recTime" class="muted" style="margin-top:8px"></div>
      <div class="level-wrap" id="levelWrap" style="display:none">
        <div class="level-bar"><div class="level-inner" id="levelInner"></div></div>
        <div class="level-num" id="levelNum">0%</div>
      </div>
      <div id="micInfo" class="muted" style="margin-top:8px;font-size:12px"></div>
      <audio id="player" controls style="display:none;margin-top:8px"></audio>
      <div class="muted" style="margin-top:8px">–ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏: <span class="kbd">R</span> ‚Äî —Å—Ç–∞—Ä—Ç/—Å—Ç–æ–ø –∑–∞–ø–∏—Å–∏, <span class="kbd">U</span> ‚Äî –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª, <span class="kbd">H</span> ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é.</div>
    </div>

    <!-- UPLOAD -->
    <div class="card">
      <h3>üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ç–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞</h3>
      <div class="row">
        <input id="fileInput" type="file" accept="audio/*,video/webm"/>
        <button id="btnUpload" class="btn">‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
      </div>
      <div id="dropzone" class="dropzone">
        <div>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ <span class="kbd">U</span> –¥–ª—è –≤—ã–±–æ—Ä–∞</div>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h3>üìö –ò—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>
        <div class="row">
          <button id="btnLoadHistory" class="btn-primary">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
          <button id="btnClearHistory" class="btn btn-danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>
      <div id="historyContainer" style="display:none"><div id="historyList"></div></div>
    </div>

    <!-- JOB CARDS -->
    <div id="jobs"></div>

    <!-- RESULTS -->
    <div id="results" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin: 18px 0">
        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏</h2>
        <button onclick="clearResults()" class="btn btn-danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
      </div>
      <div id="resultsList"></div>
    </div>

    <div class="footer">–°–¥–µ–ª–∞–Ω–æ —Å –ª—é–±–æ–≤—å—é –∫ UX ‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–≤–µ—Ç–ª—É—é/—Ç—ë–º–Ω—É—é —Ç–µ–º—É ‚Ä¢ –ë—ã—Å—Ç—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ drag&drop</div>
  </div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const apiBaseInput = $('#apiBase');
  const langSel = $('#lang');
  const btnStart = $('#btnStart');
  const btnStop = $('#btnStop');
  const statusSpan = $('#recStatus');
  const recTimeEl = $('#recTime');
  const fileInput = $('#fileInput');
  const btnUpload = $('#btnUpload');
  const player = $('#player');
  const jobs = $('#jobs');
  const micSelect = $('#micSelect');
  const btnRefreshMics = $('#btnRefreshMics');
  const dropzone = $('#dropzone');
  const themeToggle = $('#themeToggle');
  const helpBtn = $('#helpBtn');

  // ===== Theme =====
  const THEME_KEY = 'plaud_theme';
  function setTheme(theme){ 
    console.log(`setTheme: ${theme}`); 
    document.documentElement.setAttribute('data-theme', theme); 
    localStorage.setItem(THEME_KEY, theme); 
    themeToggle.textContent = theme==='dark' ? 'üåô' : 'üåû'; 
  }
  const savedTheme = localStorage.getItem(THEME_KEY) || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
  setTheme(savedTheme);
  themeToggle.onclick = () => {
    const currentTheme = document.documentElement.getAttribute('data-theme');
    const newTheme = currentTheme==='dark' ? 'light' : 'dark';
    console.log(`Theme toggle: ${currentTheme} -> ${newTheme}`);
    setTheme(newTheme);
  };

  // Login button handler
  $('#loginBtn').onclick = () => {
    console.log(`Login button clicked`);
    openLoginModal();
  };

  // Login form handler
  $('#loginForm').addEventListener('submit', handleLogin);
  
  // Close modal handlers
  $('#closeLoginModalBtn').onclick = closeLoginModal;
  $('#cancelLoginBtn').onclick = closeLoginModal;

  // Users management button handler
  $('#usersBtn').onclick = () => {
    console.log(`Users button clicked`);
    openUsersModal();
  };

  // Users modal handlers
  $('#closeUsersModalBtn').onclick = closeUsersModal;
  $('#cancelUsersBtn').onclick = closeUsersModal;
  $('#refreshUsersBtn').onclick = loadUsersList;

  helpBtn.onclick = () => {
    console.log(`Help button clicked`);
    showNotification('–°–æ—á–µ—Ç–∞–Ω–∏—è –∫–ª–∞–≤–∏—à: R ‚Äî –∑–∞–ø–∏—Å—å, U ‚Äî –≤—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª, H ‚Äî –∏—Å—Ç–æ—Ä–∏—è. –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç—å —Ñ–∞–π–ª –≤ –æ–±–ª–∞—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏.', 'info');
  };

  // Login modal functions
  function openLoginModal() {
    console.log(`Opening login modal`);
    $('#loginModal').style.display = 'flex';
    $('#loginUsername').focus();
  }

  function closeLoginModal() {
    console.log(`Closing login modal`);
    $('#loginModal').style.display = 'none';
    $('#loginError').style.display = 'none';
    $('#loginError').textContent = '';
    $('#loginForm').reset();
  }

  // Helper function to get API base URL
  function getApiBase() {
    return apiBaseInput.value || `${location.protocol}//${location.host}`;
  }

  // Users management modal functions
  function openUsersModal() {
    console.log(`Opening users modal`);
    $('#usersModal').style.display = 'flex';
    loadUsersList();
  }

  function closeUsersModal() {
    console.log(`Closing users modal`);
    $('#usersModal').style.display = 'none';
  }

  async function loadUsersList() {
    const usersList = $('#usersList');
    usersList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>';
    
    try {
      const token = localStorage.getItem('plaud_jwt_token');
      if (!token) {
        usersList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--danger)">‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</div>';
        return;
      }

      const response = await fetch(`${getApiBase()}/users`, {
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      const users = data.users || [];

      if (users.length === 0) {
        usersList.innerHTML = '<div style="text-align:center;padding:20px;color:var(--muted)">üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
        return;
      }

      // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      let usersHTML = '<div style="display:grid;gap:12px">';
      
      users.forEach(user => {
        const statusClass = user.is_active ? 'success' : 'warn';
        const statusText = user.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
        const adminClass = user.is_admin ? 'success' : 'muted';
        const adminText = user.is_admin ? 'üëë –ê–¥–º–∏–Ω' : 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
        const createdDate = new Date(user.created_at).toLocaleDateString('ru-RU');
        
        usersHTML += `
          <div class="card" style="padding:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <div>
                <strong>üë§ ${user.username}</strong>
                <span class="pill ${statusClass}" style="margin-left:8px">${statusText}</span>
                <span class="pill ${adminClass}" style="margin-left:8px">${adminText}</span>
              </div>
              <div style="display:flex;gap:8px">
                ${user.is_active ? 
                  `<button onclick="deactivateUser(${user.id})" class="btn btn-danger">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>` :
                  `<button onclick="activateUser(${user.id})" class="btn btn-primary">‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>`
                }
                ${user.is_admin ? 
                  `<button onclick="removeAdmin(${user.id})" class="btn btn-warn">üë§ –£–±—Ä–∞—Ç—å –∞–¥–º–∏–Ω–∞</button>` :
                  `<button onclick="makeAdmin(${user.id})" class="btn btn-primary">üëë –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º</button>`
                }
                <button onclick="deleteUser(${user.id}, '${user.username}')" class="btn btn-danger">
                  üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                </button>
              </div>
            </div>
            <div style="color:var(--muted);font-size:14px">
              üìß ${user.email} ‚Ä¢ üÜî ID: ${user.id} ‚Ä¢ üìÖ –°–æ–∑–¥–∞–Ω: ${createdDate}
            </div>
          </div>
        `;
      });
      
      usersHTML += '</div>';
      usersList.innerHTML = usersHTML;
      
    } catch (error) {
      console.error('Error loading users:', error);
      usersList.innerHTML = `<div style="text-align:center;padding:20px;color:var(--danger)">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</div>`;
    }
  }

  async function deleteUser(userId, username) {
    if (!confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${username}"?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
      return;
    }

    try {
      const token = localStorage.getItem('plaud_jwt_token');
      if (!token) {
        showNotification('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
        return;
      }

      const response = await fetch(`${getApiBase()}/users/${userId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || `HTTP ${response.status}`);
      }

      const result = await response.json();
      showNotification(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${username}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω`, 'success');
      loadUsersList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
      
    } catch (error) {
      console.error('Error deleting user:', error);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`, 'error');
    }
  }

  async function deactivateUser(userId) {
    try {
      const token = localStorage.getItem('plaud_jwt_token');
      if (!token) {
        showNotification('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
        return;
      }

      const response = await fetch(`${getApiBase()}/users/${userId}/deactivate`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || `HTTP ${response.status}`);
      }

      const result = await response.json();
      showNotification(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${result.user.username}" –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω`, 'success');
      loadUsersList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
      
    } catch (error) {
      console.error('Error deactivating user:', error);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏: ${error.message}`, 'error');
    }
  }

  async function activateUser(userId) {
    try {
      const token = localStorage.getItem('plaud_jwt_token');
      if (!token) {
        showNotification('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
        return;
      }

      const response = await fetch(`${getApiBase()}/users/${userId}/activate`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || `HTTP ${response.status}`);
      }

      const result = await response.json();
      showNotification(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${result.user.username}" –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω`, 'success');
      loadUsersList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
      
    } catch (error) {
      console.error('Error activating user:', error);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: ${error.message}`, 'error');
    }
  }

  async function makeAdmin(userId) {
    try {
      const token = localStorage.getItem('plaud_jwt_token');
      if (!token) {
        showNotification('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
        return;
      }

      const response = await fetch(`${getApiBase()}/users/${userId}/make-admin`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || `HTTP ${response.status}`);
      }

      const result = await response.json();
      showNotification(`‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å "${result.user.username}" –Ω–∞–∑–Ω–∞—á–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º`, 'success');
      loadUsersList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
      
    } catch (error) {
      console.error('Error making admin:', error);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: ${error.message}`, 'error');
    }
  }

  async function removeAdmin(userId) {
    try {
      const token = localStorage.getItem('plaud_jwt_token');
      if (!token) {
        showNotification('‚ùå –ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è', 'error');
        return;
      }

      const response = await fetch(`${getApiBase()}/users/${userId}/remove-admin`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`
        }
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.detail || `HTTP ${response.status}`);
      }

      const result = await response.json();
      showNotification(`‚úÖ –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ —Å–Ω—è—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${result.user.username}"`, 'success');
      loadUsersList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
      
    } catch (error) {
      console.error('Error removing admin:', error);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ —Å–Ω—è—Ç–∏—è –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: ${error.message}`, 'error');
    }
  }

  // Make functions globally available
  window.openLoginModal = openLoginModal;
  window.closeLoginModal = closeLoginModal;
  window.openUsersModal = openUsersModal;
  window.closeUsersModal = closeUsersModal;
  window.deleteUser = deleteUser;
  window.deactivateUser = deactivateUser;
  window.activateUser = activateUser;
  window.makeAdmin = makeAdmin;
  window.removeAdmin = removeAdmin;

  async function handleLogin(event) {
    event.preventDefault();
    console.log(`Handling login form submission`);
    
    const username = $('#loginUsername').value.trim();
    const password = $('#loginPassword').value;
    
    console.log(`Login attempt: username="${username}", passwordLength=${password.length}`);
    
    if (!username || !password) {
      console.log(`Login failed: empty fields`);
      showNotification('‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'warn');
      return false;
    }
    
    const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
    console.log(`API Base: ${apiBase}`);
    
    const formData = new FormData();
    formData.append('username', username);
    formData.append('password', password);
    
    try {
      showNotification('üîê –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤—Ö–æ–¥...', 'info');
      console.log(`Sending login request to: ${apiBase}/auth/login`);
      
      const response = await fetch(`${apiBase}/auth/login`, {
        method: 'POST',
        body: formData
      });
      
      console.log(`Login response: status=${response.status}, statusText=${response.statusText}`);
      
      if (response.ok) {
        const data = await response.json();
        console.log('Login successful:', data);
        
        // Save the JWT token
        localStorage.setItem('plaud_jwt_token', data.access_token);
        localStorage.setItem('plaud_username', data.username);
        
        console.log('Token saved to localStorage:', {
          token: data.access_token.substring(0, 20) + '...',
          username: data.username
        });
        
        // Get user info including admin status
        try {
          const userInfoResponse = await fetch(`${apiBase}/auth/me`, {
            headers: {
              'Authorization': `Bearer ${data.access_token}`
            }
          });
          
          if (userInfoResponse.ok) {
            const userInfo = await userInfoResponse.json();
            localStorage.setItem('plaud_is_admin', userInfo.is_admin ? 'true' : 'false');
            console.log('User info saved:', { is_admin: userInfo.is_admin });
          }
        } catch (error) {
          console.warn('Failed to get user info:', error);
          localStorage.setItem('plaud_is_admin', 'false');
        }
        
        updateKeyStatus('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'ok');
        
        closeLoginModal();
        showNotification(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${data.username}!`, 'success');
        
        // Update UI immediately
        console.log('Updating UI after login...');
        updateAuthUI();
        
        // Check auth to verify token works (but don't update UI again)
        console.log('Verifying token with server...');
        const isValid = await checkAuthSilent();
        console.log('Token verification result:', isValid);
        
        return true;
      } else {
        console.log(`Login failed: HTTP ${response.status}`);
        const errorData = await response.json().catch(() => ({ detail: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' }));
        console.log(`Login error data:`, errorData);
        
        $('#loginError').textContent = errorData.detail || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞';
        $('#loginError').style.display = 'block';
        showNotification('‚ùå –û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + (errorData.detail || '–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ'), 'error');
        return false;
      }
    } catch (error) {
      console.error('Login error:', error);
      console.error('Error details:', {
        name: error.name,
        message: error.message,
        stack: error.stack
      });
      
      $('#loginError').textContent = '–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + error.message;
      $('#loginError').style.display = 'block';
      showNotification('üåê –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º: ' + error.message, 'error');
      return false;
    }
  }

  // API base default current origin
  apiBaseInput.value = `${location.protocol}//${location.host}`;
  apiBaseInput.onchange = () => {
    console.log(`API base changed to: ${apiBaseInput.value}`);
    showNotification(`üîó API base: ${apiBaseInput.value}`, 'info');
  };

  // Check if user is already logged in
  const savedToken = localStorage.getItem('plaud_jwt_token');
  const savedUsername = localStorage.getItem('plaud_username');
  const savedIsAdmin = localStorage.getItem('plaud_is_admin');
  
  console.log(`Page load check: token=${!!savedToken}, username=${savedUsername}, isAdmin=${savedIsAdmin}`);
  
  if (savedToken && savedUsername) { 
    updateKeyStatus('–¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω', 'ok'); 
    updateAuthUI(); // Update UI to show logged in state
    showNotification('üîë –¢–æ–∫–µ–Ω –∑–∞–≥—Ä—É–∂–µ–Ω', 'success'); 
    
    // If we don't have admin status, try to get it
    if (savedIsAdmin === null) {
      console.log('Admin status not found, fetching user info...');
      checkAuth(); // This will fetch admin status
    }
  }

  // Saved mic
  const savedMicId = localStorage.getItem('plaud_selected_mic');
  if (savedMicId) window.savedMicId = savedMicId;

  // Auth check
  async function checkAuth(){
    console.log(`checkAuth called`);
    let token = localStorage.getItem('plaud_jwt_token');
    
    if (!token) {
      console.log(`No JWT token found`);
      updateKeyStatus('–í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'warn');
      updateAuthUI();
      return false;
    }
    
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      console.log(`Checking auth with API base: ${apiBase}`);
      
      // Try to check auth status
      const response = await fetch(`${apiBase}/auth/check`, { 
        headers: { 'Authorization': `Bearer ${token}` },
        method: 'GET'
      });
      
      if (response.ok) {
        const data = await response.json();
        console.log(`Auth successful for user: ${data.username}`);
        updateKeyStatus(`–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞ (${data.username})`, 'ok');
        
        // Update UI based on auth status only if it's not already updated
        const currentUsername = localStorage.getItem('plaud_username');
        if (currentUsername !== data.username) {
          console.log(`Username mismatch, updating UI: ${currentUsername} -> ${data.username}`);
          updateAuthUI();
        } else {
          // Even if username matches, we should check admin status
          console.log(`Username matches, checking admin status for: ${data.username}`);
          try {
            const userInfoResponse = await fetch(`${apiBase}/auth/me`, {
              headers: { 'Authorization': `Bearer ${token}` }
            });
            
            if (userInfoResponse.ok) {
              const userInfo = await userInfoResponse.json();
              const currentIsAdmin = localStorage.getItem('plaud_is_admin') === 'true';
              const newIsAdmin = userInfo.is_admin;
              
              console.log(`Admin status check: current=${currentIsAdmin}, new=${newIsAdmin}`);
              
              if (currentIsAdmin !== newIsAdmin) {
                console.log(`Admin status changed, updating UI: ${currentIsAdmin} -> ${newIsAdmin}`);
                localStorage.setItem('plaud_is_admin', newIsAdmin ? 'true' : 'false');
                updateAuthUI();
              } else {
                console.log(`Admin status unchanged: ${newIsAdmin}`);
              }
            }
          } catch (error) {
            console.warn('Failed to check admin status:', error);
          }
        }
        
        return true;
      }
      
      console.log(`Auth failed: HTTP ${response.status}`);
      
      // If JWT token is invalid, clear it
      localStorage.removeItem('plaud_jwt_token');
      localStorage.removeItem('plaud_username');
      updateKeyStatus('–¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫', 'warn');
      showNotification('üîë –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'warn');
      updateAuthUI();
      
      return false;
    } catch (e) {
      console.error(`Auth error:`, e);
      updateKeyStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è','warn');
      
      // Don't clear token on connection errors, just show warning
      if (e.name === 'TypeError' && e.message.includes('fetch')) {
        showNotification('üåê –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'warn');
      } else {
        showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
      }
      
      return false;
    }
  }

  // Silent auth check (doesn't update UI)
  async function checkAuthSilent(){
    console.log(`checkAuthSilent called`);
    let token = localStorage.getItem('plaud_jwt_token');
    
    if (!token) {
      console.log(`No JWT token found in silent check`);
      return false;
    }
    
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      console.log(`Silent checking auth with API base: ${apiBase}`);
      
      // Try to check auth status
      const response = await fetch(`${apiBase}/auth/check`, { 
        headers: { 'Authorization': `Bearer ${token}` },
        method: 'GET'
      });
      
      if (response.ok) {
        const data = await response.json();
        console.log(`Silent auth successful for user: ${data.username}`);
        return true;
      }
      
      console.log(`Silent auth failed: HTTP ${response.status}`);
      
      // If JWT token is invalid, clear it but don't show notifications
      localStorage.removeItem('plaud_jwt_token');
      localStorage.removeItem('plaud_username');
      
      return false;
    } catch (e) {
      console.error(`Silent auth error:`, e);
      // Don't show notifications or update UI on connection errors
      return false;
    }
  }
  function updateKeyStatus(msg, type){
    console.log(`updateKeyStatus: ${msg} (${type})`);
    const el=$('#keyStatus');
    el.textContent=msg;
    el.className = type==='ok' ? 'ok' : 'warn';
  }

  // Update UI based on authentication status
  function updateAuthUI() {
    const token = localStorage.getItem('plaud_jwt_token');
    const username = localStorage.getItem('plaud_username');
    const isAdmin = localStorage.getItem('plaud_is_admin') === 'true';
    const loginBtn = $('#loginBtn');
    const usersBtn = $('#usersBtn');
    
    console.log(`updateAuthUI: token=${!!token}, username=${username}, isAdmin=${isAdmin}`);
    console.log(`Current button text: "${loginBtn.textContent}"`);
    console.log(`Users button current display: "${usersBtn.style.display}"`);
    
    if (token && username) {
      // User is logged in
      const newText = `üë§ ${username}`;
      loginBtn.textContent = newText;
      loginBtn.title = '–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã';
      loginBtn.onclick = handleLogout;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º
      const shouldShowUsersBtn = isAdmin;
      usersBtn.style.display = shouldShowUsersBtn ? 'block' : 'none';
      
      console.log(`UI updated: user logged in as ${username}, isAdmin=${isAdmin}, shouldShowUsersBtn=${shouldShowUsersBtn}, usersBtn.display="${usersBtn.style.display}"`);
    } else {
      // User is not logged in
      loginBtn.textContent = 'üîë –í–æ–π—Ç–∏';
      loginBtn.title = '–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É';
      loginBtn.onclick = () => {
        console.log(`Login button clicked`);
        openLoginModal();
      };
      usersBtn.style.display = 'none';
      console.log(`UI updated: user not logged in, button text: "üîë –í–æ–π—Ç–∏"`);
    }
    
    // Force a re-render by triggering a small style change
    loginBtn.style.transform = 'scale(1)';
    
    // Additional verification
    setTimeout(() => {
      console.log(`UI verification after 100ms: button text="${loginBtn.textContent}", onclick=${typeof loginBtn.onclick}, usersBtn.display="${usersBtn.style.display}"`);
    }, 100);
  }

  // Logout function
  function handleLogout() {
    console.log(`Logout initiated`);
    localStorage.removeItem('plaud_jwt_token');
    localStorage.removeItem('plaud_username');
    localStorage.removeItem('plaud_is_admin');
    updateKeyStatus('–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã', 'warn');
    showNotification('üëã –î–æ —Å–≤–∏–¥–∞–Ω–∏—è!', 'info');
    updateAuthUI();
  }

  // ========== Microphones ==========
  async function getAvailableMicrophones(){
    console.log(`getAvailableMicrophones called`);
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(t => t.stop());
      const devices = await navigator.mediaDevices.enumerateDevices();
      const audioInputs = devices.filter(d => d.kind==='audioinput');
      console.log(`Found ${audioInputs.length} audio input devices`);
      micSelect.innerHTML = '<option value="">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä</option>';
      audioInputs.forEach(device => { const o=document.createElement('option'); o.value=device.deviceId; o.textContent=device.label || `–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${device.deviceId.slice(0,8)}...`; micSelect.appendChild(o); });
      if (window.savedMicId) { const saved = micSelect.querySelector(`option[value="${window.savedMicId}"]`); if (saved) { micSelect.value=window.savedMicId; showNotification(`üé§ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –º–∏–∫—Ä–æ—Ñ–æ–Ω: ${saved.textContent}`, 'info'); } window.savedMicId=null; }
      if (audioInputs.length>0) { const micInfo=$('#micInfo'); micInfo.innerHTML = `<strong>üì± –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω—ã:</strong><br>${audioInputs.map((d,i)=>`${i+1}. ${d.label || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} (${d.deviceId.slice(0,8)}...)`).join('<br>')}`; }
    } catch (err) {
      console.error(`getAvailableMicrophones error:`, err);
      if (err.name==='NotAllowedError') showNotification('üîí –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É','warn'); else showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–ø–∏—Å–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤: '+err.message,'error');
    }
  }
  function refreshMicrophones(){ 
    console.log(`refreshMicrophones called`); 
    showNotification('üîÑ –û–±–Ω–æ–≤–ª—è—é —Å–ø–∏—Å–æ–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤...','info'); 
    getAvailableMicrophones(); 
  }

  // ========== Recording ==========
  let mediaRecorder, chunks=[], startTs=null, tickTimer=null, recordedBlob=null, recordedName=null;
  let audioCtx=null, analyser=null, meterRAF=null, levelInner=$('#levelInner'), levelNum=$('#levelNum');

  function supports(mime){ 
    const result = (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(mime)); 
    console.log(`supports(${mime}): ${result}`); 
    return result; 
  }

  async function startRec(){
    console.log(`startRec called`);
    if (!await checkAuth()) { showNotification('‚ùå –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É','error'); return; }
    try {
      const audioConstraints = { echoCancellation:true, noiseSuppression:true, autoGainControl:true, sampleRate:48000, channelCount:1 };
      const selectedMicId = micSelect.value; if (selectedMicId) audioConstraints.deviceId = { exact: selectedMicId };
      console.log(`Audio constraints:`, audioConstraints);
      const stream = await navigator.mediaDevices.getUserMedia({ audio: audioConstraints });

      // MIME
      const mime = supports('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus' : supports('audio/ogg;codecs=opus') ? 'audio/ogg;codecs=opus' : supports('audio/webm') ? 'audio/webm' : 'audio/wav';
      console.log(`Using MIME type: ${mime}`);
      mediaRecorder = new MediaRecorder(stream, { mimeType: mime, audioBitsPerSecond: 128000 });

      chunks=[]; recordedBlob=null; recordedName=null;
      mediaRecorder.ondataavailable = e => { if (e.data && e.data.size>0) chunks.push(e.data); };
      mediaRecorder.onstart = () => { showNotification('üéôÔ∏è –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å','success'); };
      mediaRecorder.onerror = (event) => showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ' + event.error,'error');
      mediaRecorder.onstop = onStopRec;
      mediaRecorder.start(100);

      // Timer UI
      startTs = Date.now();
      tickTimer = setInterval(()=>{ const s=Math.floor((Date.now()-startTs)/1000); recTimeEl.textContent = `–ò–¥—ë—Ç –∑–∞–ø–∏—Å—å: ${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`; }, 500);
      btnStart.disabled = true; btnStop.disabled = false; statusSpan.textContent = '–∑–∞–ø–∏—Å—å‚Ä¶'; statusSpan.className='pill';

      // Audio level meter
      $('#levelWrap').style.display='flex';
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const src = audioCtx.createMediaStreamSource(stream); analyser = audioCtx.createAnalyser(); analyser.fftSize=256; src.connect(analyser);
      const buf = new Uint8Array(analyser.fftSize);
      const meter = () => {
        analyser.getByteTimeDomainData(buf);
        let sum=0; for (let i=0;i<buf.length;i++){ const v=(buf[i]-128)/128; sum+=v*v; }
        const rms = Math.sqrt(sum/buf.length); // 0..1
        const pct = Math.min(100, Math.max(0, Math.round(rms*160))); // scale
        levelInner.style.width = pct + '%'; levelNum.textContent = pct + '%';
        meterRAF = requestAnimationFrame(meter);
      };
      meter();

    } catch (err) {
      console.error(`startRec error:`, err);
      if (err.name==='NotAllowedError') showNotification('üîí –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É','warn');
      else if (err.name==='NotFoundError') showNotification('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω','error');
      else if (err.name==='NotReadableError') showNotification('üì± –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º','warn');
      else showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: '+err.message,'error');
    }
  }

  function onStopRec(){
    console.log(`onStopRec called`);
    clearInterval(tickTimer); cancelAnimationFrame(meterRAF); $('#levelWrap').style.display='none';
    if (chunks.length===0) { showNotification('‚ö†Ô∏è –ü—É—Å—Ç–∞—è –∑–∞–ø–∏—Å—å','warn'); return; }
    const blob = new Blob(chunks, {type: mediaRecorder.mimeType || 'audio/webm'}); recordedBlob = blob;
    console.log(`Recording blob created: ${blob.size} bytes, type: ${blob.type}`);
    if (blob.size===0) { showNotification('‚ö†Ô∏è –ó–∞–ø–∏—Å—å –ø—É—Å—Ç–∞—è','warn'); return; }
    recordedName = `recording_${new Date().toISOString().replace(/[:.]/g,'-')}.${blob.type.startsWith('audio/ogg')?'ogg':'webm'}`;
    console.log(`Recording name: ${recordedName}`);
    player.src = URL.createObjectURL(blob); player.style.display='block';
    recTimeEl.textContent = `–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${(blob.size/1024/1024).toFixed(2)} MB`;
    statusSpan.textContent = '–≥–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ'; statusSpan.className='pill ok';
    showNotification(`‚úÖ –ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (${(blob.size/1024/1024).toFixed(2)} MB), –æ—Ç–ø—Ä–∞–≤–ª—è—é...`,'success');
    console.log(`Calling uploadBlob with blob and name: ${recordedName}`);
    uploadBlob(blob, recordedName);
  }

  function stopRec(){
    console.log(`stopRec called`);
    if (mediaRecorder && mediaRecorder.state!=='inactive'){
      console.log(`Stopping media recorder`);
      mediaRecorder.stop(); mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    }
    if (audioCtx) { try { audioCtx.close(); } catch(_){} }
    btnStart.disabled=false; btnStop.disabled=true;
  }

  async function testMicrophone(){
    console.log(`testMicrophone called`);
    try{
      showNotification('üé§ –¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞...','info');
      const audioConstraints = { echoCancellation:false, noiseSuppression:false, autoGainControl:false };
      const selectedMicId = micSelect.value; if (selectedMicId) audioConstraints.deviceId = { exact: selectedMicId };
      console.log(`Test audio constraints:`, audioConstraints);
      const stream = await navigator.mediaDevices.getUserMedia({ audio: audioConstraints });
      const track = stream.getAudioTracks()[0];
      console.log(`Test track:`, track);
      const micInfo = $('#micInfo');
      micInfo.innerHTML = `<strong>üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω:</strong> ${track.label || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>–í–∫–ª—é—á–µ–Ω: ${track.enabled ? '‚úÖ' : '‚ùå'} | –ó–∞–≥–ª—É—à–µ–Ω: ${track.muted ? 'üîá' : 'üîä'} | –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${track.readyState}`;
      stream.getTracks().forEach(t => t.stop());
      showNotification('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç','success');
    }catch(err){
      console.error(`testMicrophone error:`, err);
      $('#micInfo').innerHTML = `<strong>‚ùå –û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:</strong> ${err.message}`;
      showNotification('‚ùå –û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: '+err.message,'error');
    }
  }

  btnStart.onclick = () => { console.log(`Start button clicked`); startRec(); }; 
  btnStop.onclick = () => { console.log(`Stop button clicked`); stopRec(); }; 
  $('#btnTestMic').onclick = () => { console.log(`Test mic button clicked`); testMicrophone(); }; 
  btnRefreshMics.onclick = () => { console.log(`Refresh mics button clicked`); refreshMicrophones(); };
  micSelect.onchange = () => { 
    const id=micSelect.value; 
    console.log(`Microphone selection changed to: ${id}`);
    if (id){ 
      const name=micSelect.options[micSelect.selectedIndex].textContent; 
      localStorage.setItem('plaud_selected_mic', id); 
      showNotification(`üé§ –í—ã–±—Ä–∞–Ω –º–∏–∫—Ä–æ—Ñ–æ–Ω: ${name}`,'info'); 
    } else { 
      localStorage.removeItem('plaud_selected_mic'); 
      showNotification('üé§ –ê–≤—Ç–æ–≤—ã–±–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞','info'); 
    } 
  };



  setTimeout(async()=>{ 
    console.log(`Initial auth check timeout`); 
    if (await checkAuth()) showNotification('üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!','success'); 
  }, 800);
  setTimeout(()=>{ 
    console.log(`Initial microphones check timeout`); 
    getAvailableMicrophones(); 
  }, 1200);
  langSel.onchange = () => {
    console.log(`Language changed to: ${langSel.value}`);
    showNotification(`üåê –Ø–∑—ã–∫: ${langSel.value.toUpperCase()}`,'info');
  };

  // ===== Upload =====
  btnUpload.onclick = async ()=>{
    const f=fileInput.files?.[0]; 
    console.log(`Upload button clicked, file:`, f);
    if (!f) { 
      showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª','warn'); 
      return; 
    } 
    if (!await checkAuth()){ 
      showNotification('‚ùå –ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏','error'); 
      return; 
    } 
    showNotification(`üì§ –ó–∞–≥—Ä—É–∑–∫–∞: ${f.name}`,'info'); 
    uploadBlob(f, f.name); 
  };

  // Drag&Drop
  ;['dragenter','dragover'].forEach(ev=> dropzone.addEventListener(ev, e=>{ 
    console.log(`Drag event: ${ev}`);
    e.preventDefault(); 
    e.stopPropagation(); 
    dropzone.classList.add('dragover'); 
  }));
  ;['dragleave','drop'].forEach(ev=> dropzone.addEventListener(ev, e=>{ 
    console.log(`Drag event: ${ev}`);
    e.preventDefault(); 
    e.stopPropagation(); 
    dropzone.classList.remove('dragover'); 
  }));
  dropzone.addEventListener('drop', async e => { 
    const f = e.dataTransfer.files?.[0]; 
    console.log(`File dropped:`, f);
    if (!f) return; 
    if (!await checkAuth()) { 
      showNotification('‚ùå –ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏','error'); 
      return; 
    } 
    showNotification(`üì§ –ó–∞–≥—Ä—É–∑–∫–∞: ${f.name}`,'info'); 
    uploadBlob(f, f.name); 
  });

  // Shortcuts
  window.addEventListener('keydown', e => {
    const tag = (e.target && e.target.tagName) || '';
    if (['INPUT','TEXTAREA','SELECT'].includes(tag)) return;
    if (e.key==='r' || e.key==='R') { 
      console.log(`R key pressed, starting/stopping recording`);
      e.preventDefault(); 
      btnStop.disabled ? btnStart.click() : btnStop.click(); 
    }
    if (e.key==='u' || e.key==='U') { 
      console.log(`U key pressed, opening file dialog`);
      e.preventDefault(); 
      fileInput.click(); 
    }
    if (e.key==='h' || e.key==='H') { 
      console.log(`H key pressed, loading history`);
      e.preventDefault(); 
      $('#btnLoadHistory').click(); 
    }
  });

  // ===== API upload & cards =====
  async function uploadBlob(blob, filename){
    const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
    const lang = langSel.value || 'ru';
    const token = localStorage.getItem('plaud_jwt_token');
    if (!token) { showNotification('‚ö†Ô∏è –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É','warn'); return; }

    console.log(`uploadBlob: ${filename}, lang: ${lang}`);
    const card = makeJobCard({filename, lang}); 
    console.log(`Card created:`, card);
    jobs.prepend(card.el); 
    console.log(`Card added to DOM`);
    addJob();
    
    try {
      const fd = new FormData(); fd.append('file', blob, filename);
      const res = await fetch(`${apiBase}/upload?language=${encodeURIComponent(lang)}`, { method:'POST', body: fd, headers: { 'Authorization': `Bearer ${token}` } });
      if (!res.ok) throw new Error(await res.text());
      const { job_id } = await res.json();
      console.log(`Upload successful, job_id: ${job_id}`);
      console.log(`Calling card.setJobId(${job_id})`);
      card.setJobId(job_id); 
      console.log(`Calling pollStatus(${apiBase}, ${job_id}, card)`);
      pollStatus(apiBase, job_id, card);
      showNotification(`üì§ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ${filename}`,'success');
    } catch(e){ 
      console.error(`Upload error:`, e);
      card.setError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message); 
      showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message,'error'); 
    }
  }

  function makeJobCard({filename, lang}){
    console.log(`makeJobCard: ${filename}, ${lang}`);
    const el = document.createElement('div'); 
    el.className='card'; 
    el.innerHTML = `
      <div class="row">
        <strong>${filename}</strong>
        <span class="pill">lang=${lang}</span>
      </div>
      <div class="muted mono" style="margin-top:4px">job: <span class="jobid">‚Äî</span></div>
      <div class="progress-container" style="margin-top:12px"><div class="progress-bar" style="width:0%">0%</div></div>
      <div style="margin-top:8px;display:flex;align-items:center;gap:8px;flex-wrap:wrap">
        <span class="status-badge status-queued">–í –æ—á–µ—Ä–µ–¥–∏</span>
        <span class="status-text muted">–û–∂–∏–¥–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏...</span>
      </div>
      <div class="process-details muted" style="margin-top:8px;font-size:12px"></div>
      <div class="results-section" style="margin-top:16px;display:none">
        <div class="result-content">
          <div class="result-section"><h4>üéØ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</h4><div class="transcript-content"></div></div>
          <div class="result-section"><h4>üìù –°–∞–º–º–∞—Ä–∏</h4><div class="summary-content"></div></div>
        </div>
        <div class="row" style="margin-top:12px;justify-content:center">
          <button class="btn btn-ghost btn-json">üì• –°–∫–∞—á–∞—Ç—å JSON</button>
          <button class="btn btn-ghost btn-copy">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏</button>
        </div>
      </div>`;

    const jobEl = el.querySelector('.jobid');
    const progressBar = el.querySelector('.progress-bar');
    const statusBadge = el.querySelector('.status-badge');
    const statusText = el.querySelector('.status-text');
    const processDetails = el.querySelector('.process-details');
    const resultsSection = el.querySelector('.results-section');
    const transcriptContent = el.querySelector('.transcript-content');
    const summaryContent = el.querySelector('.summary-content');
    const btnJson = el.querySelector('.btn-json');
    const btnCopy = el.querySelector('.btn-copy');
    let lastResult = null;
    
    console.log(`makeJobCard elements found:`, {
      jobEl: !!jobEl,
      progressBar: !!progressBar,
      statusBadge: !!statusBadge,
      statusText: !!statusText,
      processDetails: !!processDetails
    });

    function updateProgress(percent, status, details){
      console.log(`updateProgress: ${percent}%, status: ${status}, details: ${details}`);
      console.log(`Elements: progressBar=`, progressBar, `statusBadge=`, statusBadge, `statusText=`, statusText, `processDetails=`, processDetails);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä
      if (progressBar) {
        progressBar.style.width = percent + '%'; 
        progressBar.textContent = percent + '%';
        console.log(`Progress bar updated: width=${progressBar.style.width}, text=${progressBar.textContent}`);
        
        // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–π
        progressBar.className = 'progress-bar';
        if (status==='processing' || status==='queued') progressBar.classList.add('processing');
        else if (status==='transcribed_waiting_summary') progressBar.classList.add('transcribing');
        else if (status==='done') progressBar.classList.add('done');
        else if (status==='error') progressBar.classList.add('error');
        console.log(`Progress bar classes: ${progressBar.className}`);
      }

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –±–µ–π–¥–∂
      if (statusBadge) {
        statusBadge.className = 'status-badge ' + (
          status==='queued' ? 'status-queued' :
          status==='processing' ? 'status-processing' :
          status==='transcribed_waiting_summary' ? 'status-transcribing' :
          status==='done' ? 'status-done' : 'status-error'
        );
        console.log(`Status badge classes: ${statusBadge.className}`);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
        const map = { 
          queued:'–í –æ—á–µ—Ä–µ–¥–∏', 
          processing:'–û–±—Ä–∞–±–æ—Ç–∫–∞...', 
          transcribed_waiting_summary:'–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è ‚Üí —Å–∞–º–º–∞—Ä–∏', 
          done:'–ì–æ—Ç–æ–≤–æ!', 
          error:'–û—à–∏–±–∫–∞' 
        };
        statusBadge.textContent = map[status] || status;
        console.log(`Status badge text: ${statusBadge.textContent}`);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
      if (processDetails && details) {
        processDetails.innerHTML = details;
        console.log(`Process details: ${details}`);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
      if (statusText) {
        const statusTextMap = {
          queued: '–û–∂–∏–¥–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏...',
          processing: '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ...',
          transcribed_waiting_summary: '–°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–º–∞—Ä–∏...',
          done: '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!',
          error: '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'
        };
        statusText.textContent = statusTextMap[status] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å';
        console.log(`Status text: ${statusText.textContent}`);
      }
      
      console.log(`Final state: progressBar.width=${progressBar?.style.width}, statusBadge.text=${statusBadge?.textContent}, statusText.text=${statusText?.textContent}`);
    }

    const card = {
      el,
      setJobId(id){ 
        console.log(`setJobId: ${id}`); 
        console.log(`jobEl:`, jobEl);
        if (jobEl) jobEl.textContent=id; 
        console.log(`jobEl.textContent set to:`, jobEl?.textContent);
        console.log(`Calling updateProgress(14, 'queued', 'üì§ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–∂–∏–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏...')`);
        updateProgress(14,'queued','üì§ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–∂–∏–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏...'); 
      },
      setStatus(status){
        console.log(`setStatus: ${status}`);
        console.log(`Calling updateProgress for status: ${status}`);
        
        if (status==='queued') {
          console.log(`Status is queued, calling updateProgress(22, 'queued', 'üì§ –í –æ—á–µ—Ä–µ–¥–∏...')`);
          updateProgress(22, status, 'üì§ –í –æ—á–µ—Ä–µ–¥–∏...');
        } else if (status==='processing') {
          console.log(`Status is processing, calling updateProgress(44, 'processing', 'üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ...')`);
          updateProgress(44, status, 'üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ...');
        } else if (status==='transcribed_waiting_summary') {
          console.log(`Status is transcribed_waiting_summary, calling updateProgress(72, 'transcribed_waiting_summary', 'üìù –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–º–∞—Ä–∏...')`);
          updateProgress(72, status, 'üìù –°–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–º–∞—Ä–∏...');
        } else if (status==='done') {
          console.log(`Status is done, calling updateProgress(100, 'done', '‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!')`);
          updateProgress(100, status, '‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
        } else if (status==='error') {
          console.log(`Status is error, calling updateProgress(0, 'error', '‚ùå –û—à–∏–±–∫–∞: ' + status)`);
          updateProgress(0, 'error', '‚ùå –û—à–∏–±–∫–∞: ' + status);
        } else {
          console.log(`Unknown status: ${status}, calling updateProgress(0, 'error', '‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å: ' + status)`);
          updateProgress(0, 'error', '‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ç–∞—Ç—É—Å: ' + status);
        }
      },
      setError(msg){ 
        console.log(`setError: ${msg}`); 
        console.log(`Calling updateProgress(0, 'error', '‚ùå –û—à–∏–±–∫–∞: ' + msg)`);
        updateProgress(0,'error','‚ùå –û—à–∏–±–∫–∞: '+msg); 
        console.log(`Setting statusText.innerHTML to: <span class="warn">${msg}</span>`);
        if (statusText) statusText.innerHTML = `<span class="warn">${msg}</span>`; 
      },
      showResult(data){
        console.log(`showResult:`, data);
        console.log(`Setting lastResult and showing resultsSection`);
        lastResult = data; 
        if (resultsSection) resultsSection.style.display='block';
        
        const tr = data?.transcript;
        if (tr && transcriptContent) {
          console.log(`Transcript found:`, tr);
          transcriptContent.innerHTML = `
            <div style="margin-bottom:12px"><strong>–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç:</strong>
              <div style="background:rgba(2,6,23,.05);padding:8px;border-radius:8px;margin-top:6px;font-size:13px">${tr.text || '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}</div>
            </div>
            <div><strong>–°–µ–≥–º–µ–Ω—Ç—ã:</strong>
              <div style="max-height:200px;overflow:auto">${(tr.segments||[]).map(seg=>`
                <div style=\"background:#111f2e;padding:6px 8px;margin:4px 0;border-radius:6px;font-size:12px\">
                  <span class=\"muted\">${formatTime(seg.start)} - ${formatTime(seg.end)}</span><br>${seg.text}
                </div>`).join('')}</div>
            </div>`;
        } else {
          console.log(`No transcript found`);
        }
        
        const sm = data?.summary; 
        if (sm && summaryContent){
          console.log(`Summary found:`, sm);
          let html='';
          if (sm.meeting_summary) html += `<div style="margin-bottom:12px"><strong>üìã –†–µ–∑—é–º–µ –≤—Å—Ç—Ä–µ—á–∏:</strong><div style="background:#0f261b;padding:10px;border-radius:8px;margin-top:6px">${sm.meeting_summary}</div></div>`;
          if (sm.key_points?.length) html += `<div style="margin-bottom:12px"><strong>üéØ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:</strong>${sm.key_points.map(p=>`<div class=\"key-point\">${p}</div>`).join('')}</div>`;
          if (sm.action_items?.length) html += `<div style="margin-bottom:12px"><strong>‚úÖ –ó–∞–¥–∞—á–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è:</strong>${sm.action_items.map(it=>`<div class=\"action-item\"><strong>${it.owner||'–ù–µ —É–∫–∞–∑–∞–Ω'}</strong>: ${it.task||'‚Äî'} ${it.due?`<br><small>–°—Ä–æ–∫: ${it.due}</small>`:''}</div>`).join('')}</div>`;
          if (sm.risks?.length) html += `<div style="margin-bottom:12px"><strong>‚ö†Ô∏è –†–∏—Å–∫–∏:</strong>${sm.risks.map(r=>`<div class=\"risk-item\">${r}</div>`).join('')}</div>`;
          if (sm.raw && !sm.meeting_summary) html += `<div style="margin-bottom:12px"><strong>üìÑ –°—ã—Ä–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong><div style="background:rgba(2,6,23,.05);padding:10px;border-radius:8px;white-space:pre-wrap">${sm.raw}</div></div>`;
          summaryContent.innerHTML = html || '<em>–°–∞–º–º–∞—Ä–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</em>';
          console.log(`Summary HTML set:`, html);
        } else {
          console.log(`No summary found`);
        }
        
        console.log(`Setting up button handlers`);
        if (btnJson) btnJson.onclick = () => { const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=`result_${data.job_id}.json`; a.click(); URL.revokeObjectURL(a.href); showNotification('üì• JSON —Å–∫–∞—á–∞–Ω','success'); };
        if (btnCopy) btnCopy.onclick = async () => { try { const text = summaryContent?.textContent||''; await navigator.clipboard.writeText(text); btnCopy.textContent='üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'; setTimeout(()=>btnCopy.textContent='üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏',1800); showNotification('üìã –°–∞–º–º–∞—Ä–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ','success'); } catch(_) { showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å','error'); } };
      }
    };
    
    console.log(`makeJobCard returning object with methods:`, Object.keys(card));
    
    return card;
  }

  function formatTime(seconds){ 
    console.log(`formatTime: ${seconds}`); 
    const m=Math.floor(seconds/60); 
    const s=Math.floor(seconds%60); 
    const result = `${m}:${String(s).padStart(2,'0')}`; 
    console.log(`formatTime result: ${result}`); 
    return result; 
  }

  // Toasts
  function showNotification(message, type='info'){
    console.log(`showNotification: ${message} (${type})`);
    const colors = { info: ['#0ea5e9','#0284c7'], success:['#22c55e','#16a34a'], warn:['#f59e0b','#d97706'], error:['#ef4444','#b91c1c'] };
    const bg = colors[type]||colors.info;
    const el = document.createElement('div');
    el.style.cssText = `position:fixed;top:20px;right:20px;z-index:1000;max-width:340px;padding:14px 16px;border-radius:12px;color:white;box-shadow:var(--shadow);background:linear-gradient(135deg, ${bg[0]}, ${bg[1]});backdrop-filter:blur(6px);animation:toastIn .22s ease;`;
    el.textContent = message; document.body.appendChild(el);
    if (!document.querySelector('#toast-anim')){
      const s=document.createElement('style'); s.id='toast-anim'; s.textContent=`@keyframes toastIn{from{transform:translateX(12px);opacity:0}to{transform:translateX(0);opacity:1}}@keyframes toastOut{from{transform:translateX(0);opacity:1}to{transform:translateX(12px);opacity:0}}`; document.head.appendChild(s);
    }
    const close = ()=>{ el.style.animation='toastOut .2s ease'; setTimeout(()=> el.remove(), 180); };
    setTimeout(close, 4200); el.onclick = close;
  }

  async function pollStatus(apiBase, jobId, card){
    console.log(`pollStatus started for job ${jobId}`);
    card.setStatus('processing'); 
    let done=false; 
    let attempts=0; 
    const token = localStorage.getItem('plaud_jwt_token');
    if (!token) { console.error('No JWT token'); return; }
    showNotification('üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ...','info');
    
    const tick = async () => {
      attempts++;
      console.log(`pollStatus tick ${attempts} for job ${jobId}`);
      
      try {
        const s = await fetch(`${apiBase}/status/${jobId}`, { headers:{ 'Authorization': `Bearer ${token}` } }).then(r=>r.json());
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Å –¥–µ—Ç–∞–ª—è–º–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
        console.log(`Job ${jobId}: status = ${s.status}, attempt = ${attempts}`);
        
        if (s.status === 'queued') {
          card.setStatus('queued');
        } else if (s.status === 'processing') {
          card.setStatus('processing');
        } else if (s.status === 'transcribed_waiting_summary') {
          card.setStatus('transcribed_waiting_summary');
          showNotification('üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –≥–æ—Ç–æ–≤–∞, —Å–æ–∑–¥–∞—é —Å–∞–º–º–∞—Ä–∏...','info');
        } else if (s.status === 'done') {
          card.setStatus('done');
          try {
            const out = await fetch(`${apiBase}/result/${jobId}`, { headers:{ 'Authorization': `Bearer ${token}` } }).then(r=>r.json());
            console.log(`Result fetched:`, out);
            card.showResult(out); 
            done=true; 
            document.getElementById('results').style.display='block'; 
            addToResultsList(out, card.el.querySelector('strong').textContent); 
            console.log(`Calling completeJob()`);
            completeJob(); 
            showNotification(`‚úÖ –ì–æ—Ç–æ–≤–æ: ${card.el.querySelector('strong').textContent}`,'success');
          } catch(e){ card.setError('–û—à–∏–±–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: '+e.message); showNotification('‚ùå –û—à–∏–±–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: '+e.message,'error'); done=true; }
        } else if (s.status === 'error') { 
          card.setError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏'); 
          showNotification('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏','error'); 
          done=true; 
        } else {
          console.warn(`Unknown status: ${s.status}`);
          card.setStatus(s.status);
        }
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–ø—Ä–æ—Å–∞
        if (!done) {
          const delay = s?.status==='processing' ? 1500 : 2000;
          console.log(`Next tick in ${delay}ms for job ${jobId}`);
          setTimeout(tick, delay);
        }
      } catch (e) {
        console.error(`pollStatus error for job ${jobId}:`, e);
        if (attempts>10) { 
          card.setError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: '+e.message); 
          showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: '+e.message,'error'); 
          done=true; 
        } else {
          // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–∏ –æ—à–∏–±–∫–µ
          console.log(`Retrying in 3000ms for job ${jobId} (attempt ${attempts})`);
          setTimeout(tick, 3000);
        }
      }
    };
    tick();
  }

  function addToResultsList(data, filename){
    console.log(`addToResultsList: ${filename}`, data);
    const resultsList = $('#resultsList');
    const resultCard = document.createElement('div'); resultCard.className='result-card';
    const tr=data?.transcript, sm=data?.summary;
    resultCard.innerHTML = `
      <div class="result-header">
        <div class="result-title">üìÅ ${filename}</div>
        <div class="result-meta">Job ID: ${data.job_id}<br>${new Date().toLocaleString('ru-RU')}</div>
      </div>
      <div class="result-content">
        <div class="result-section"><h4>üéØ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</h4>
          <div style="max-height:300px;overflow:auto">
            ${tr ? `
              <div style="margin-bottom:10px"><strong>–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç:</strong>
                <div style="background:rgba(2,6,23,.05);padding:8px;border-radius:8px;margin-top:6px;font-size:13px">${tr.text || '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}</div>
              </div>
              <div><strong>–°–µ–≥–º–µ–Ω—Ç—ã (${tr.segments?.length||0}):</strong>
                <div style="max-height:150px;overflow:auto">${(tr.segments||[]).map(seg=>`
                  <div style=\"background:#111f2e;padding:6px 8px;margin:4px 0;border-radius:6px;font-size:12px\">
                    <span class=\"muted\">${formatTime(seg.start)} - ${formatTime(seg.end)}</span><br>${seg.text}
                  </div>`).join('')}</div>
              </div>` : '<em>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</em>'}
          </div>
        </div>
        <div class="result-section"><h4>üìù –°–∞–º–º–∞—Ä–∏</h4>
          <div style="max-height:300px;overflow:auto">
            ${sm ? `
              ${sm.meeting_summary ? `<div style=\"margin-bottom:10px\"><strong>üìã –†–µ–∑—é–º–µ –≤—Å—Ç—Ä–µ—á–∏:</strong><div style=\"background:#0f261b;padding:8px;border-radius:8px;margin-top:6px\">${sm.meeting_summary}</div></div>` : ''}
              ${sm.key_points?.length ? `<div style=\"margin-bottom:10px\"><strong>üéØ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:</strong>${sm.key_points.map(p=>`<div class=\\\"key-point\\\">${p}</div>`).join('')}</div>` : ''}
              ${sm.action_items?.length ? `<div style=\"margin-bottom:10px\"><strong>‚úÖ –ó–∞–¥–∞—á–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è:</strong>${sm.action_items.map(it=>`<div class=\\\"action-item\\\"><strong>${it.owner||'–ù–µ —É–∫–∞–∑–∞–Ω'}</strong>: ${it.task||'‚Äî'} ${it.due?`<br><small>–°—Ä–æ–∫: ${it.due}</small>`:''}</div>`).join('')}</div>` : ''}
              ${sm.risks?.length ? `<div style=\"margin-bottom:10px\"><strong>‚ö†Ô∏è –†–∏—Å–∫–∏:</strong>${sm.risks.map(r=>`<div class=\\\"risk-item\\\">${r}</div>`).join('')}</div>` : ''}
              ${sm.raw && !sm.meeting_summary ? `<div style=\"margin-bottom:10px\"><strong>üìÑ –°—ã—Ä–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong><div style=\"background:rgba(2,6,23,.05);padding:10px;border-radius:8px;white-space:pre-wrap\">${sm.raw}</div></div>` : ''}
            ` : '<em>–°–∞–º–º–∞—Ä–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</em>'}
          </div>
        </div>
      </div>
      <div style="text-align:center;margin-top:12px">
        <button onclick="downloadResult('${data.job_id}', ${JSON.stringify(data).replace(/"/g,'&quot;')})" class="btn btn-ghost" style="margin-right:6px">üì• –°–∫–∞—á–∞—Ç—å JSON</button>
        <button onclick="copySummary(${JSON.stringify(sm).replace(/"/g,'&quot;')})" class="btn btn-ghost">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏</button>
      </div>`;
    resultsList.insertBefore(resultCard, resultsList.firstChild);
    console.log(`Result card added to results list`);
  }

  // Overall progress
  let totalJobs=0, completedJobs=0;
  function updateOverallProgress(){
    const overall=$('#overallProgress'); 
    const bar=$('#overallProgressBar'); 
    const stats=$('#progressStats');
    
    console.log(`updateOverallProgress: ${completedJobs}/${totalJobs} = ${Math.round((completedJobs/totalJobs)*100)}%`);
    
    if (totalJobs>0){ 
      overall.style.display='block'; 
      const pct=Math.round((completedJobs/totalJobs)*100); 
      bar.style.width=pct+'%'; 
      bar.textContent=pct+'%'; 
      stats.textContent=`${completedJobs}/${totalJobs} –∑–∞–≤–µ—Ä—à–µ–Ω–æ`;
      
      // –£–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–ª–∞—Å—Å—ã –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω—É–∂–Ω—ã–π
      bar.className='progress-bar'; 
      if (pct<30) bar.classList.add('processing'); 
      else if (pct<70) bar.classList.add('transcribing'); 
      else if (pct<100) bar.classList.add('summarizing'); 
      else bar.classList.add('done');
      
      console.log(`Overall progress bar: width=${bar.style.width}, class=${bar.className}`);
    } else { 
      overall.style.display='none'; 
    }
  }
  function addJob(){ 
    totalJobs++; 
    console.log(`addJob: totalJobs=${totalJobs}`); 
    updateOverallProgress(); 
  }
  function completeJob(){ 
    completedJobs++; 
    console.log(`completeJob: completedJobs=${completedJobs}`); 
    updateOverallProgress(); 
  }

  // Global buttons for results
  window.downloadResult = function(jobId, data){ 
    console.log(`downloadResult: ${jobId}`, data); 
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); 
    const a=document.createElement('a'); 
    a.href=URL.createObjectURL(blob); 
    a.download=`result_${jobId}.json`; 
    a.click(); 
    URL.revokeObjectURL(a.href); 
    showNotification('üì• JSON —Å–∫–∞—á–∞–Ω','success'); 
  };
  window.copySummary = function(summary){ 
    console.log(`copySummary:`, summary); 
    let t=''; 
    if (!summary) return; 
    if (summary.meeting_summary) t+=`–†–µ–∑—é–º–µ –≤—Å—Ç—Ä–µ—á–∏:\n${summary.meeting_summary}\n\n`; 
    if (summary.key_points?.length) t+=`–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:\n${summary.key_points.map(p=>`- ${p}`).join('\n')}\n\n`; 
    if (summary.action_items?.length) t+=`–ó–∞–¥–∞—á–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è:\n${summary.action_items.map(i=>`- ${i.owner||'–ù–µ —É–∫–∞–∑–∞–Ω'}: ${i.task||'‚Äî'}${i.due?` (–¥–æ ${i.due})`:''}`).join('\n')}\n\n`; 
    if (summary.risks?.length) t+=`–†–∏—Å–∫–∏:\n${summary.risks.map(r=>`- ${r}`).join('\n')}\n\n`; 
    if (summary.raw && !summary.meeting_summary) t+=summary.raw; 
    navigator.clipboard.writeText(t).then(()=>showNotification('üìã –°–∞–º–º–∞—Ä–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!','success')).catch(()=>showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å','error')); 
  };
  window.clearResults = function(){ 
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?')) { 
      console.log(`Clearing results`); 
      $('#resultsList').innerHTML=''; 
      $('#results').style.display='none'; 
      totalJobs=0; 
      completedJobs=0; 
      updateOverallProgress(); 
      showNotification('üóëÔ∏è –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã','success'); 
    } 
  };

  // ===== History =====
  $('#btnLoadHistory').onclick = async ()=>{
    console.log(`Load history button clicked`);
    if (!await checkAuth()) { 
      showNotification('‚ùå –ù–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏','error'); 
      return; 
    } 
    await loadHistory(); 
  };
  $('#btnClearHistory').onclick = () => { 
    console.log(`Clear history button clicked`);
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é –Ω–∞ —ç–∫—Ä–∞–Ω–µ?')) { 
      $('#historyList').innerHTML=''; 
      $('#historyContainer').style.display='none'; 
      showNotification('üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞','success'); 
    } 
  };

  async function loadHistory(){
    console.log(`loadHistory called`);
    const token = localStorage.getItem('plaud_jwt_token');
    if (!token) { showNotification('‚ö†Ô∏è –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É','warn'); return; }
    
    try{
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`; 
      showNotification('üìö –ó–∞–≥—Ä—É–∂–∞—é –∏—Å—Ç–æ—Ä–∏—é...','info');
      const resp = await fetch(`${apiBase}/history`, { headers: { 'Authorization': `Bearer ${token}` } }); 
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      const data = await resp.json(); 
      console.log(`History data:`, data);
      displayHistory(data.jobs); 
      showNotification(`üìö –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.jobs.length} –∑–∞–¥–∞—á`, 'success');
    }catch(e){ showNotification('‚ùå –û—à–∏–±–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏: '+e.message,'error'); }
  }

  function displayHistory(jobsArr){
    console.log(`displayHistory:`, jobsArr);
    const list=$('#historyList'); const cont=$('#historyContainer');
    if (!jobsArr?.length){ 
      console.log(`No jobs to display`);
      list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>'; 
      cont.style.display='block'; 
      return; 
    }
    let html='';
    jobsArr.forEach(job=>{
      const statusClass = getStatusClass(job.status); const statusText = getStatusText(job.status);
      const createdAt = job.created_at ? new Date(job.created_at*1000).toLocaleString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      html += `
        <div class="card" style="margin:12px 0">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:8px">
            <div>
              <strong>üìÅ ${job.filename || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong>
              <div class="muted" style="font-size:12px;margin-top:4px">Job ID: ${job.job_id}<br>–Ø–∑—ã–∫: ${job.language||'‚Äî'} ‚Ä¢ –°–æ–∑–¥–∞–Ω–æ: ${createdAt}</div>
            </div>
            <div style="text-align:right">
              <span class="status-badge ${statusClass}">${statusText}</span>
              <div class="muted" style="font-size:12px;margin-top:6px">${job.has_transcript ? '‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç' : '‚ùå –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç'} ‚Ä¢ ${job.has_summary ? '‚úÖ –°–∞–º–º–∞—Ä–∏' : '‚ùå –°–∞–º–º–∞—Ä–∏'}</div>
            </div>
          </div>
          <div class="row" style="justify-content:center">
            <button onclick="viewJobDetails('${job.job_id}')" class="btn">üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å</button>
            <button onclick="downloadJobResult('${job.job_id}')" class="btn">üì• –°–∫–∞—á–∞—Ç—å</button>
            <button onclick="deleteJob('${job.job_id}')" class="btn btn-danger">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>`;
    });
    list.innerHTML = html; cont.style.display='block';
    console.log(`History displayed, ${jobsArr.length} jobs`);
  }

  function getStatusClass(status){ 
    console.log(`getStatusClass: ${status}`); 
    switch(status){ 
      case 'done': return 'status-done'; 
      case 'transcribed_waiting_summary': return 'status-transcribing'; 
      case 'processing': return 'status-processing'; 
      default: return 'status-queued'; 
    } 
  }
  function getStatusText(status){ 
    console.log(`getStatusText: ${status}`); 
    switch(status){ 
      case 'done': return '–ì–æ—Ç–æ–≤–æ'; 
      case 'transcribed_waiting_summary': return '–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è'; 
      case 'processing': return '–û–±—Ä–∞–±–æ—Ç–∫–∞'; 
      default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'; 
    } 
  }

  window.viewJobDetails = async function(jobId){
    console.log(`viewJobDetails: ${jobId}`);
    const token = localStorage.getItem('plaud_jwt_token');
    if (!token) { showNotification('‚ö†Ô∏è –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É','warn'); return; }
    
    try{ 
      const apiBase=apiBaseInput.value || `${location.protocol}//${location.host}`; 
      const r=await fetch(`${apiBase}/history/${jobId}`, { headers:{ 'Authorization': `Bearer ${token}` } }); 
      if (!r.ok) throw new Error(`HTTP ${r.status}`); 
      const jobData = await r.json(); 
      console.log(`Job data:`, jobData);
      showJobDetailsModal(jobData); 
    }
    catch(e){ showNotification('‚ùå –û—à–∏–±–∫–∞ –¥–µ—Ç–∞–ª–µ–π: '+e.message,'error'); }
  };

  window.downloadJobResult = async function(jobId){
    console.log(`downloadJobResult: ${jobId}`);
    const token = localStorage.getItem('plaud_jwt_token');
    if (!token) { showNotification('‚ö†Ô∏è –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É','warn'); return; }
    
    try{ 
      const apiBase=apiBaseInput.value || `${location.protocol}//${location.host}`; 
      const r=await fetch(`${apiBase}/result/${jobId}`, { headers:{ 'Authorization': `Bearer ${token}` } }); 
      if (!r.ok) throw new Error(`HTTP ${r.status}`); 
      const data=await r.json(); 
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'}); 
      const a=document.createElement('a'); 
      a.href=URL.createObjectURL(blob); 
      a.download=`job_${jobId}_result.json`; 
      a.click(); 
      URL.revokeObjectURL(a.href); 
      showNotification('üì• –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞—á–∞–Ω','success'); 
    }
    catch(e){ showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: '+e.message,'error'); }
  };

  window.deleteJob = async function(jobId){
    console.log(`deleteJob: ${jobId}`);
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É ${jobId}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;
    const token = localStorage.getItem('plaud_jwt_token');
    if (!token) { showNotification('‚ö†Ô∏è –í–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É','warn'); return; }
    
    try{ 
      const apiBase=apiBaseInput.value || `${location.protocol}//${location.host}`; 
      const r=await fetch(`${apiBase}/history/${jobId}`, { method:'DELETE', headers:{ 'Authorization': `Bearer ${token}` } }); 
      if (!r.ok) throw new Error(`HTTP ${r.status}`); 
      showNotification('üóëÔ∏è –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞','success'); 
      await loadHistory(); 
    }
    catch(e){ showNotification('‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: '+e.message,'error'); }
  };

  function showJobDetailsModal(job){
    console.log(`showJobDetailsModal:`, job);
    const modal=document.createElement('div'); modal.className='modal-overlay';
    const card=document.createElement('div'); card.className='modal-card';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;border-bottom:1px dashed var(--border);padding-bottom:12px">
        <h2 style="margin:0">üìã –î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏</h2>
        <button class="btn btn-icon" onclick="this.closest('.modal-overlay').remove()">‚úñ</button>
      </div>
      <div class="muted" style="margin-bottom:12px"><strong>–§–∞–π–ª:</strong> ${job.filename||'‚Äî'} ‚Ä¢ <strong>Job:</strong> ${job.job_id} ‚Ä¢ <strong>–Ø–∑—ã–∫:</strong> ${job.language||'‚Äî'} ‚Ä¢ <strong>–°—Ç–∞—Ç—É—Å:</strong> <span class="status-badge ${getStatusClass(job.status)}">${getStatusText(job.status)}</span></div>
      ${job.transcript ? `
        <div class="result-section" style="margin-bottom:12px">
          <h4>üéØ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</h4>
          <div style="max-height:220px;overflow:auto"><strong>–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç:</strong><br>${job.transcript.text||'‚Äî'}</div>
          ${job.transcript.segments ? `<div style=\"margin-top:10px\"><strong>–°–µ–≥–º–µ–Ω—Ç—ã (${job.transcript.segments.length})</strong><div style=\"max-height:150px;overflow:auto\">${job.transcript.segments.map(seg=>`<div style='background:#111f2e;padding:6px 8px;margin:4px 0;border-radius:6px;font-size:12px'><span class=muted>${formatTime(seg.start)} - ${formatTime(seg.end)}</span><br>${seg.text}</div>`).join('')}</div></div>`: ''}
        </div>` : ''}
      ${job.summary ? `
        <div class="result-section">
          <h4>üìù –°–∞–º–º–∞—Ä–∏</h4>
          ${job.summary.meeting_summary ? `<div style=\"background:#0f261b;padding:10px;border-radius:8px;margin-bottom:10px\"><strong>üìã –†–µ–∑—é–º–µ –≤—Å—Ç—Ä–µ—á–∏:</strong><br>${job.summary.meeting_summary}</div>` : ''}
          ${job.summary.key_points?.length ? `<div style=\"margin-bottom:10px\"><strong>üéØ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:</strong>${job.summary.key_points.map(p=>`<div class=\\\"key-point\\\">${p}</div>`).join('')}</div>` : ''}
          ${job.summary.action_items?.length ? `<div style=\"margin-bottom:10px\"><strong>‚úÖ –ó–∞–¥–∞—á–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è:</strong>${job.summary.action_items.map(i=>`<div class=\\\"action-item\\\"><strong>${i.owner||'‚Äî'}</strong>: ${i.task||'‚Äî'} ${i.due?`<br><small>–°—Ä–æ–∫: ${i.due}</small>`:''}</div>`).join('')}</div>` : ''}
          ${job.summary.risks?.length ? `<div style=\"margin-bottom:10px\"><strong>‚ö†Ô∏è –†–∏—Å–∫–∏:</strong>${job.summary.risks.map(r=>`<div class=\\\"risk-item\\\">${r}</div>`).join('')}</div>` : ''}
          ${job.summary.raw && !job.summary.meeting_summary ? `<div style=\"background:rgba(2,6,23,.05);padding:10px;border-radius:8px\"><strong>üìÑ –°—ã—Ä–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong><pre style=\"white-space:pre-wrap;margin:8px 0;font-size:12px\">${job.summary.raw}</pre></div>` : ''}
        </div>` : ''}
      <div style="text-align:center;margin-top:14px"><button class="btn" onclick="downloadJobResult('${job.job_id}')">üì• –°–∫–∞—á–∞—Ç—å JSON</button> <button class="btn" onclick="this.closest('.modal-overlay').remove()">–ó–∞–∫—Ä—ã—Ç—å</button></div>`;
    modal.appendChild(card); document.body.appendChild(modal);
    modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
  }

  // Initialize auth UI on page load
  updateAuthUI();
  
  // Check authentication status on page load
  checkAuth();
  
  // Set up periodic auth check (every 5 minutes)
  setInterval(() => {
    const token = localStorage.getItem('plaud_jwt_token');
    if (token) {
      console.log('Periodic auth check...');
      checkAuth().then(isValid => {
        if (!isValid) {
          // Token is invalid, update UI
          updateKeyStatus('–¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫', 'warn');
          updateAuthUI();
          showNotification('üîë –¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏—Å—Ç–µ–∫. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.', 'warn');
        }
      });
    }
  }, 5 * 60 * 1000); // 5 minutes
  
})();
</script>
</body>
</html>
