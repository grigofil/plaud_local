<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ê—É–¥–∏–æ ‚Üí –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è + –°–∞–º–º–∞—Ä–∏</title>
  <style>
    body{font-family:system-ui, sans-serif;max-width:920px;margin:24px auto;padding:0 16px}
    h1{font-size:1.6rem;margin:0 0 12px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
    button.primary{background:#111;color:#fff;border-color:#111}
    button[disabled]{opacity:.5;cursor:not-allowed}
    input[type="file"]{display:block;margin:8px 0}
    .muted{color:#666}
    pre{white-space:pre-wrap;background:#f7f7f7;border-radius:8px;padding:12px;overflow:auto}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:6px 10px;margin-right:8px;background:#fafafa}
    .ok{color:#0a7a32} .warn{color:#a66a00}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 800px){.grid{grid-template-columns:1fr}}
    
    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
    .progress-container {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 10px;
      margin: 8px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 20px;
      background: linear-gradient(90deg, #4CAF50, #45a049);
      border-radius: 10px;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
    
    .progress-bar.processing { background: linear-gradient(90deg, #2196F3, #1976D2); }
    .progress-bar.transcribing { background: linear-gradient(90deg, #FF9800, #F57C00); }
    .progress-bar.summarizing { background: linear-gradient(90deg, #9C27B0, #7B1FA2); }
    .progress-bar.done { background: linear-gradient(90deg, #4CAF50, #45a049); }
    .progress-bar.error { background: linear-gradient(90deg, #f44336, #d32f2f); }
    
    /* –°—Ç–∞—Ç—É—Å—ã */
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-queued { background: #e3f2fd; color: #1976d2; }
    .status-processing { background: #fff3e0; color: #f57c00; }
    .status-transcribing { background: #fff8e1; color: #f57c00; }
    .status-summarizing { background: #f3e5f5; color: #7b1fa2; }
    .status-done { background: #e8f5e8; color: #388e3c; }
    .status-error { background: #ffebee; color: #d32f2f; }
    
    /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã */
    .result-card {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      background: #fafafa;
      transition: all 0.3s ease;
    }
    
    .result-card:hover {
      border-color: #2196F3;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
    }
    
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .result-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .result-meta {
      font-size: 12px;
      color: #666;
    }
    
    .result-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 800px) {
      .result-content { grid-template-columns: 1fr; }
    }
    
    .result-section {
      background: white;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    
    .result-section h4 {
      margin: 0 0 12px 0;
      color: #333;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .action-item {
      background: #f5f5f5;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 6px;
      border-left: 3px solid #2196F3;
    }
    
    .key-point {
      background: #fff3e0;
      padding: 6px 10px;
      margin: 4px 0;
      border-radius: 6px;
      border-left: 3px solid #ff9800;
    }
    
    .risk-item {
      background: #ffebee;
      padding: 6px 10px;
      margin: 4px 0;
      border-radius: 6px;
      border-left: 3px solid #f44336;
    }
  </style>
</head>
<body>
  <h1>–ó–∞–ø–∏—Å—å/–∑–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ ‚Üí Whisper ‚Üí DeepSeek</h1>
  
  <!-- –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å -->
  <div id="overallProgress" style="display: none;" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <strong>üìà –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏</strong>
      <span id="progressStats">0/0 –∑–∞–≤–µ—Ä—à–µ–Ω–æ</span>
    </div>
    <div class="progress-container">
      <div id="overallProgressBar" class="progress-bar" style="width: 0%">0%</div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label>API base:</label>
      <input id="apiBase" class="mono" style="min-width:280px" value="" placeholder="http://localhost:8000">
      <label>–Ø–∑—ã–∫:</label>
      <select id="lang"><option value="ru" selected>ru</option><option value="en">en</option></select>
    </div>
    <div class="row" style="margin-top:8px">
      <label>API key:</label>
      <input id="apiKey" class="mono" style="min-width:280px" placeholder="Bearer token">
      <button id="saveKey">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span id="keyStatus" class="muted"></span>
    </div>
    <div class="muted" style="margin-top:6px">
      –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä—ë—Ç—Å—è —Ç–µ–∫—É—â–∏–π origin. –ï—Å–ª–∏ API –Ω–∞ –¥—Ä—É–≥–æ–º —Ö–æ—Å—Ç–µ/–ø–æ—Ä—Ç—É ‚Äî —É–∫–∞–∂–∏ —Ç—É—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä: <span class="mono">http://localhost:8000</span>
    </div>
  </div>

  <div class="card">
    <h3>üéôÔ∏è –ó–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–±—Ä–∞—É–∑–µ—Ä)</h3>
    <div class="row">
      <button id="btnStart" class="primary">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
      <button id="btnStop" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <span id="recStatus" class="pill muted">–Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è</span>
    </div>
    <div id="recTime" class="muted" style="margin-top:8px"></div>
    <audio id="player" controls style="display:none;margin-top:8px"></audio>
  </div>

  <div class="card">
    <h3>üì§ –ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª</h3>
    <input id="fileInput" type="file" accept="audio/*,video/webm"/>
    <button id="btnUpload">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>

  <div id="jobs"></div>
  
  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ -->
  <div id="results" style="display: none;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏</h2>
      <button onclick="clearResults()" style="background:#f44336;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
      </button>
    </div>
    <div id="resultsList"></div>
  </div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const apiBaseInput = $('#apiBase');
  const langSel = $('#lang');
  const btnStart = $('#btnStart');
  const btnStop = $('#btnStop');
  const statusSpan = $('#recStatus');
  const recTimeEl = $('#recTime');
  const fileInput = $('#fileInput');
  const btnUpload = $('#btnUpload');
  const player = $('#player');
  const jobs = $('#jobs');

  // API base: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–∫—É—â–∏–π origin
  apiBaseInput.value = `${location.protocol}//${location.host}`;
  
  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ API base
  apiBaseInput.onchange = () => {
    showNotification(`üîó API base –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${apiBaseInput.value}`);
  };
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π API –∫–ª—é—á
  const savedKey = localStorage.getItem('plaud_api_key');
  if (savedKey) {
    $('#apiKey').value = savedKey;
    updateKeyStatus('–ö–ª—é—á –∑–∞–≥—Ä—É–∂–µ–Ω', 'ok');
    showNotification('üîë API –∫–ª—é—á –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö');
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  async function checkAuth() {
    const apiKey = $('#apiKey').value;
    if (!apiKey) {
      updateKeyStatus('–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á', 'warn');
      return false;
    }
    
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      const response = await fetch(`${apiBase}/auth/check`, {
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });
      
             if (response.ok) {
         const data = await response.json();
         updateKeyStatus('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞', 'ok');
         showNotification('üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
         return true;
       } else {
         updateKeyStatus('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'warn');
         showNotification('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
         return false;
       }
         } catch (error) {
       updateKeyStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'warn');
       showNotification('üåê –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
       return false;
     }
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–ª—é—á–∞
  function updateKeyStatus(message, type) {
    const statusEl = $('#keyStatus');
    statusEl.textContent = message;
    statusEl.className = type === 'ok' ? 'ok' : 'warn';
  }

  // ====== –∑–∞–ø–∏—Å—å ======
  let mediaRecorder, chunks=[], startTs=null, tickTimer=null, recordedBlob=null, recordedName=null;

  function supports(mime){ return (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(mime)); }

  async function startRec(){
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∑–∞–ø–∏—Å–∏
    if (!await checkAuth()) {
      showNotification('‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∑–∞–ø–∏—Å–∏');
      return;
    }
    
    try{
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      const mime = supports('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
                  : supports('audio/ogg;codecs=opus')  ? 'audio/ogg;codecs=opus'
                  : 'audio/webm';
      mediaRecorder = new MediaRecorder(stream, {mimeType: mime});
      chunks=[]; recordedBlob=null; recordedName=null;
      mediaRecorder.ondataavailable = e => { if(e.data && e.data.size>0) chunks.push(e.data); };
      mediaRecorder.onstop = onStopRec;
      mediaRecorder.start(250); // –∫–∞–∂–¥—ã–µ 250–º—Å —á–∞–Ω–∫–∏
      startTs = Date.now();
      tickTimer = setInterval(()=>{
        const s = Math.floor((Date.now()-startTs)/1000);
        recTimeEl.textContent = `–ò–¥—ë—Ç –∑–∞–ø–∏—Å—å: ${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
      }, 500);
      btnStart.disabled = true; btnStop.disabled = false;
      statusSpan.textContent = '–∑–∞–ø–∏—Å—å‚Ä¶';
      statusSpan.className = 'pill';
      
      showNotification('üéôÔ∏è –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å');
    }catch(err){
      showNotification('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + err.message);
    }
  }

  function onStopRec(){
    clearInterval(tickTimer);
    const blob = new Blob(chunks, {type: mediaRecorder.mimeType || 'audio/webm'});
    recordedBlob = blob;
    recordedName = `recording_${new Date().toISOString().replace(/[:.]/g,'-')}.${blob.type.startsWith('audio/ogg')?'ogg':'webm'}`;
    player.src = URL.createObjectURL(blob);
    player.style.display = 'block';
    recTimeEl.textContent = `–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${(blob.size/1024/1024).toFixed(2)} MB`;
    statusSpan.textContent = '–≥–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ';
    statusSpan.className = 'pill ok';
    
    showNotification('‚úÖ –ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –Ω–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É...');
    
    // –∞–≤—Ç–æ-–æ—Ç–ø—Ä–∞–≤–∫–∞
    uploadBlob(blob, recordedName);
  }

  function stopRec(){
    if(mediaRecorder && mediaRecorder.state!=='inactive'){
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(t=>t.stop());
    }
    btnStart.disabled = false; btnStop.disabled = true;
  }

  btnStart.onclick = startRec;
  btnStop.onclick = stopRec;
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
  $('#saveKey').onclick = async () => {
    const apiKey = $('#apiKey').value;
    if (apiKey) {
      localStorage.setItem('plaud_api_key', apiKey);
      showNotification('üíæ API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
      await checkAuth();
    } else {
      showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    }
  };
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–ª—é—á–∞
  $('#apiKey').oninput = () => {
    updateKeyStatus('–ö–ª—é—á –∏–∑–º–µ–Ω–µ–Ω', 'warn');
    showNotification('üîë API –∫–ª—é—á –∏–∑–º–µ–Ω–µ–Ω');
  };
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  setTimeout(async () => {
    if (await checkAuth()) {
      showNotification('üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Plaud Local!');
    }
  }, 1000);
  
  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —è–∑—ã–∫–∞
  langSel.onchange = () => {
    showNotification(`üåê –Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${langSel.value.toUpperCase()}`);
  };

  // ====== –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ ======
  btnUpload.onclick = async ()=>{
    const f = fileInput.files?.[0];
    if(!f){ 
      showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
      return; 
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
    if (!await checkAuth()) {
      showNotification('‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
      return;
    }
    
    showNotification(`üì§ –ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞: ${f.name}`);
    uploadBlob(f, f.name);
  };

  // ====== –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ API ======
  async function uploadBlob(blob, filename){
    const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
    const lang = langSel.value || 'ru';
    const apiKey = $('#apiKey').value;
    
    if (!apiKey) {
      showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
      return;
    }
    
    const card = makeJobCard({filename, lang});
    jobs.prepend(card.el);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
    addJob();

    try{
      const fd = new FormData();
      fd.append('file', blob, filename);
      const res = await fetch(`${apiBase}/upload?language=${encodeURIComponent(lang)}`, {
        method: 'POST',
        body: fd,
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });
      if(!res.ok){ throw new Error(await res.text()); }
      const {job_id} = await res.json();
      card.setJobId(job_id);
      pollStatus(apiBase, job_id, card);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
      showNotification(`üì§ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ${filename}`);
    }catch(e){
      card.setError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}`);
    }
  }

  function makeJobCard({filename, lang}){
    const el = document.createElement('div');
    el.className='card';
    el.innerHTML = `
      <div class="row">
        <strong>${filename}</strong>
        <span class="pill">lang=${lang}</span>
      </div>
      <div class="muted mono" style="margin-top:4px">job: <span class="jobid">‚Äî</span></div>
      
      <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
      <div class="progress-container" style="margin-top:12px;">
        <div class="progress-bar" style="width: 0%">0%</div>
      </div>
      
      <!-- –°—Ç–∞—Ç—É—Å —Å –∏–∫–æ–Ω–∫–æ–π -->
      <div style="margin-top:8px;display:flex;align-items:center;gap:8px;">
        <span class="status-badge status-queued">–í –æ—á–µ—Ä–µ–¥–∏</span>
        <span class="status-text muted">–û–∂–∏–¥–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏...</span>
      </div>
      
      <!-- –î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ -->
      <div class="process-details" style="margin-top:8px;font-size:12px;color:#666;">
        <div>üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...</div>
      </div>
      
      <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
      <div class="results-section" style="margin-top:16px;display:none;">
        <div class="grid">
          <div class="result-section">
            <h4>üéØ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</h4>
            <div class="transcript-content"></div>
          </div>
          <div class="result-section">
            <h4>üìù –°–∞–º–º–∞—Ä–∏</h4>
            <div class="summary-content"></div>
          </div>
        </div>
        <div class="row" style="margin-top:12px;justify-content:center;">
          <button class="btn-json">üì• –°–∫–∞—á–∞—Ç—å JSON</button>
          <button class="btn-copy">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏</button>
        </div>
      </div>
    `;
    
    const jobEl = el.querySelector('.jobid');
    const progressBar = el.querySelector('.progress-bar');
    const statusBadge = el.querySelector('.status-badge');
    const statusText = el.querySelector('.status-text');
    const processDetails = el.querySelector('.process-details');
    const resultsSection = el.querySelector('.results-section');
    const transcriptContent = el.querySelector('.transcript-content');
    const summaryContent = el.querySelector('.summary-content');
    const btnJson = el.querySelector('.btn-json');
    const btnCopy = el.querySelector('.btn-copy');

    let lastResult = null;

    function updateProgress(percent, status, details) {
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
      progressBar.className = 'progress-bar';
      if (status === 'processing' || status === 'queued') progressBar.classList.add('processing');
      else if (status === 'transcribed_waiting_summary') progressBar.classList.add('transcribing');
      else if (status === 'done') progressBar.classList.add('done');
      else if (status === 'error') progressBar.classList.add('error');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
      statusBadge.className = 'status-badge';
      if (status === 'queued') statusBadge.classList.add('status-queued');
      else if (status === 'processing') statusBadge.classList.add('status-processing');
      else if (status === 'transcribed_waiting_summary') statusBadge.classList.add('status-transcribing');
      else if (status === 'done') statusBadge.classList.add('status-done');
      else if (status === 'error') statusBadge.classList.add('status-error');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
      const statusMessages = {
        'queued': '–í –æ—á–µ—Ä–µ–¥–∏',
        'processing': '–û–±—Ä–∞–±–æ—Ç–∫–∞...',
        'transcribed_waiting_summary': '–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–º–∞—Ä–∏...',
        'done': '–ì–æ—Ç–æ–≤–æ!',
        'error': '–û—à–∏–±–∫–∞'
      };
      statusBadge.textContent = statusMessages[status] || status;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
      if (details) {
        processDetails.innerHTML = details;
      }
    }

    return {
      el,
      setJobId(id) { 
        jobEl.textContent = id; 
        updateProgress(10, 'queued', 'üì§ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–∂–∏–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏...');
      },
      setStatus(status) { 
        if (status === 'queued') updateProgress(20, status, 'üì§ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–∂–∏–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏...');
        else if (status === 'processing') updateProgress(40, status, 'üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ...');
        else if (status === 'transcribed_waiting_summary') updateProgress(70, status, 'üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–º–∞—Ä–∏...');
        else if (status === 'done') updateProgress(100, status, '‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
        else updateProgress(0, 'error', '‚ùå –û—à–∏–±–∫–∞: ' + status);
      },
      setError(msg) { 
        updateProgress(0, 'error', '‚ùå –û—à–∏–±–∫–∞: ' + msg);
        statusText.innerHTML = `<span class="warn">${msg}</span>`;
      },
      showResult(data) {
        lastResult = data;
        resultsSection.style.display = 'block';
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
        const transcript = data?.transcript;
        if (transcript) {
          transcriptContent.innerHTML = `
            <div style="margin-bottom:12px;">
              <strong>–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç:</strong>
              <div style="background:#f5f5f5;padding:8px;border-radius:4px;margin-top:4px;font-size:13px;">
                ${transcript.text || '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}
              </div>
            </div>
            <div>
              <strong>–°–µ–≥–º–µ–Ω—Ç—ã:</strong>
              <div style="max-height:200px;overflow-y:auto;">
                ${(transcript.segments || []).map(seg => `
                  <div style="background:#f0f0f0;padding:4px 8px;margin:2px 0;border-radius:4px;font-size:12px;">
                    <span style="color:#666;">${formatTime(seg.start)} - ${formatTime(seg.end)}</span>
                    <br>${seg.text}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–∞–º–º–∞—Ä–∏
        const summary = data?.summary;
        if (summary) {
          let summaryHtml = '';
          
          if (summary.meeting_summary) {
            summaryHtml += `
              <div style="margin-bottom:16px;">
                <strong>üìã –†–µ–∑—é–º–µ –≤—Å—Ç—Ä–µ—á–∏:</strong>
                <div style="background:#e8f5e8;padding:12px;border-radius:6px;margin-top:6px;font-size:13px;">
                  ${summary.meeting_summary}
                </div>
              </div>
            `;
          }
          
          if (summary.key_points && summary.key_points.length > 0) {
            summaryHtml += `
              <div style="margin-bottom:16px;">
                <strong>üéØ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:</strong>
                ${summary.key_points.map(point => `
                  <div class="key-point">${point}</div>
                `).join('')}
              </div>
            `;
          }
          
          if (summary.action_items && summary.action_items.length > 0) {
            summaryHtml += `
              <div style="margin-bottom:16px;">
                <strong>‚úÖ –ó–∞–¥–∞—á–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è:</strong>
                ${summary.action_items.map(item => `
                  <div class="action-item">
                    <strong>${item.owner || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong>: ${item.task || '–ó–∞–¥–∞—á–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
                    ${item.due ? `<br><small>–°—Ä–æ–∫: ${item.due}</small>` : ''}
                  </div>
                `).join('')}
              </div>
            `;
          }
          
          if (summary.risks && summary.risks.length > 0) {
            summaryHtml += `
              <div style="margin-bottom:16px;">
                <strong>‚ö†Ô∏è –†–∏—Å–∫–∏:</strong>
                ${summary.risks.map(risk => `
                  <div class="risk-item">${risk}</div>
                `).join('')}
              </div>
            `;
          }
          
          if (summary.raw && !summary.meeting_summary) {
            summaryHtml += `
              <div style="margin-bottom:16px;">
                <strong>üìÑ –°—ã—Ä–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong>
                <div style="background:#f5f5f5;padding:12px;border-radius:6px;margin-top:6px;font-size:13px;white-space:pre-wrap;">
                  ${summary.raw}
                </div>
              </div>
            `;
          }
          
          summaryContent.innerHTML = summaryHtml || '<em>–°–∞–º–º–∞—Ä–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</em>';
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        btnJson.onclick = () => {
          const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `result_${data.job_id}.json`;
          a.click();
          URL.revokeObjectURL(a.href);
          showNotification('üì• JSON —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω');
        };
        
        btnCopy.onclick = async () => {
          try {
            const textToCopy = summaryContent.textContent || '';
            await navigator.clipboard.writeText(textToCopy);
            btnCopy.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => btnCopy.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏', 2000);
            showNotification('üìã –°–∞–º–º–∞—Ä–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
          } catch(e) { 
            showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏');
          }
        };
      }
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }
  
  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  function showNotification(message) {
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-width: 300px;
      animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    if (!document.querySelector('#notification-styles')) {
      const style = document.createElement('style');
      style.id = 'notification-styles';
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    }
    
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 5000);
    
    // –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–∫—Ä—ã—Ç—å –ø–æ –∫–ª–∏–∫—É
    notification.onclick = () => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    };
  }

  async function pollStatus(apiBase, jobId, card){
    card.setStatus('processing');
    let done = false;
    let attempts = 0;
    const apiKey = $('#apiKey').value;
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    showNotification('üîÑ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∞—É–¥–∏–æ...');
    
    const tick = async () => {
      attempts++;
      try {
        const s = await fetch(`${apiBase}/status/${jobId}`, {
          headers: {
            'Authorization': `Bearer ${apiKey}`
          }
        }).then(r => r.json());
        
        card.setStatus(s.status);
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
        if (s.status === 'transcribed_waiting_summary') {
          showNotification('üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Å–æ–∑–¥–∞—é —Å–∞–º–º–∞—Ä–∏...');
        }
        
        if (s.status === 'done') {
          try {
            const out = await fetch(`${apiBase}/result/${jobId}`, {
              headers: {
                'Authorization': `Bearer ${apiKey}`
              }
            }).then(r => r.json());
            
            card.showResult(out);
            done = true;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            document.getElementById('results').style.display = 'block';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫
            addToResultsList(out, card.el.querySelector('strong').textContent);
            
            // –û—Ç–º–µ—á–∞–µ–º –∑–∞–¥–∞—á—É –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é
            completeJob();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(`‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${card.el.querySelector('strong').textContent}`);
            
                     } catch (e) {
             card.setError('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ' + e.message);
             showNotification(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ${e.message}`);
             done = true;
           }
                 } else if (s.status === 'error') {
           card.setError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏');
           showNotification(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á–∏`);
           done = true;
        }
      } catch (e) {
                 if (attempts > 10) {
           card.setError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + e.message);
           showNotification(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${e.message}`);
           done = true;
         } else {
           // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
           console.log('–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞, –ø–æ–≤—Ç–æ—Ä—è–µ–º...', e.message);
         }
      }
      
      if (!done) {
        // –ë–æ–ª–µ–µ —á–∞—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ UX
        const delay = s?.status === 'processing' ? 1500 : 2000;
        setTimeout(tick, delay);
      }
    };
    
    tick();
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫
  function addToResultsList(data, filename) {
    const resultsList = document.getElementById('resultsList');
    const resultCard = document.createElement('div');
    resultCard.className = 'result-card';
    
    const transcript = data?.transcript;
    const summary = data?.summary;
    
    resultCard.innerHTML = `
      <div class="result-header">
        <div class="result-title">üìÅ ${filename}</div>
        <div class="result-meta">
          Job ID: ${data.job_id}<br>
          ${new Date().toLocaleString('ru-RU')}
        </div>
      </div>
      <div class="result-content">
        <div class="result-section">
          <h4>üéØ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</h4>
          <div style="max-height:300px;overflow-y:auto;">
            ${transcript ? `
              <div style="margin-bottom:12px;">
                <strong>–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç:</strong>
                <div style="background:#f5f5f5;padding:8px;border-radius:4px;margin-top:4px;font-size:13px;">
                  ${transcript.text || '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}
                </div>
              </div>
              <div>
                <strong>–°–µ–≥–º–µ–Ω—Ç—ã (${transcript.segments?.length || 0}):</strong>
                <div style="max-height:150px;overflow-y:auto;">
                  ${(transcript.segments || []).map(seg => `
                    <div style="background:#f0f0f0;padding:4px 8px;margin:2px 0;border-radius:4px;font-size:12px;">
                      <span style="color:#666;">${formatTime(seg.start)} - ${formatTime(seg.end)}</span>
                      <br>${seg.text}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : '<em>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</em>'}
          </div>
        </div>
        <div class="result-section">
          <h4>üìù –°–∞–º–º–∞—Ä–∏</h4>
          <div style="max-height:300px;overflow-y:auto;">
            ${summary ? `
              ${summary.meeting_summary ? `
                <div style="margin-bottom:12px;">
                  <strong>üìã –†–µ–∑—é–º–µ –≤—Å—Ç—Ä–µ—á–∏:</strong>
                  <div style="background:#e8f5e8;padding:8px;border-radius:4px;margin-top:4px;font-size:13px;">
                    ${summary.meeting_summary}
                  </div>
                </div>
              ` : ''}
              ${summary.key_points && summary.key_points.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <strong>üéØ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:</strong>
                  ${summary.key_points.map(point => `
                    <div class="key-point">${point}</div>
                  `).join('')}
                </div>
              ` : ''}
              ${summary.action_items && summary.action_items.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <strong>‚úÖ –ó–∞–¥–∞—á–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è:</strong>
                  ${summary.action_items.map(item => `
                    <div class="action-item">
                      <strong>${item.owner || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong>: ${item.task || '–ó–∞–¥–∞—á–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
                      ${item.due ? `<br><small>–°—Ä–æ–∫: ${item.due}</small>` : ''}
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              ${summary.risks && summary.risks.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <strong>‚ö†Ô∏è –†–∏—Å–∫–∏:</strong>
                  ${summary.risks.map(risk => `
                    <div class="risk-item">${risk}</div>
                  `).join('')}
                </div>
              ` : ''}
              ${summary.raw && !summary.meeting_summary ? `
                <div style="margin-bottom:12px;">
                  <strong>üìÑ –°—ã—Ä–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong>
                  <div style="background:#f5f5f5;padding:8px;border-radius:4px;margin-top:4px;font-size:13px;white-space:pre-wrap;">
                    ${summary.raw}
                  </div>
                </div>
              ` : ''}
            ` : '<em>–°–∞–º–º–∞—Ä–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</em>'}
          </div>
        </div>
      </div>
      <div style="text-align:center;margin-top:16px;">
        <button onclick="downloadResult('${data.job_id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})" style="margin-right:8px;">
          üì• –°–∫–∞—á–∞—Ç—å JSON
        </button>
        <button onclick="copySummary(${JSON.stringify(summary).replace(/"/g, '&quot;')})">
          üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏
        </button>
      </div>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
    resultsList.insertBefore(resultCard, resultsList.firstChild);
  }
  
  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—â–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
  let totalJobs = 0;
  let completedJobs = 0;
  
  function updateOverallProgress() {
    const overallProgress = document.getElementById('overallProgress');
    const overallProgressBar = document.getElementById('overallProgressBar');
    const progressStats = document.getElementById('progressStats');
    
    if (totalJobs > 0) {
      overallProgress.style.display = 'block';
      const percent = Math.round((completedJobs / totalJobs) * 100);
      overallProgressBar.style.width = percent + '%';
      overallProgressBar.textContent = percent + '%';
      progressStats.textContent = `${completedJobs}/${totalJobs} –∑–∞–≤–µ—Ä—à–µ–Ω–æ`;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
      overallProgressBar.className = 'progress-bar';
      if (percent < 30) overallProgressBar.classList.add('processing');
      else if (percent < 70) overallProgressBar.classList.add('transcribing');
      else if (percent < 100) overallProgressBar.classList.add('summarizing');
      else overallProgressBar.classList.add('done');
    } else {
      overallProgress.style.display = 'none';
    }
  }
  
  function addJob() {
    totalJobs++;
    updateOverallProgress();
  }
  
  function completeJob() {
    completedJobs++;
    updateOverallProgress();
  }
  
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
  window.downloadResult = function(jobId, data) {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `result_${jobId}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    showNotification('üì• JSON —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω');
  };
  
  window.copySummary = function(summary) {
    let textToCopy = '';
    
    if (summary.meeting_summary) {
      textToCopy += `–†–µ–∑—é–º–µ –≤—Å—Ç—Ä–µ—á–∏:\n${summary.meeting_summary}\n\n`;
    }
    
    if (summary.key_points && summary.key_points.length > 0) {
      textToCopy += `–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:\n${summary.key_points.map(point => `- ${point}`).join('\n')}\n\n`;
    }
    
    if (summary.action_items && summary.action_items.length > 0) {
      textToCopy += `–ó–∞–¥–∞—á–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è:\n${summary.action_items.map(item => 
        `- ${item.owner || '–ù–µ —É–∫–∞–∑–∞–Ω'}: ${item.task || '–ó–∞–¥–∞—á–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}${item.due ? ` (–¥–æ ${item.due})` : ''}`
      ).join('\n')}\n\n`;
    }
    
    if (summary.risks && summary.risks.length > 0) {
      textToCopy += `–†–∏—Å–∫–∏:\n${summary.risks.map(risk => `- ${risk}`).join('\n')}\n\n`;
    }
    
    if (summary.raw && !summary.meeting_summary) {
      textToCopy += summary.raw;
    }
    
    navigator.clipboard.writeText(textToCopy).then(() => {
      showNotification('üìã –°–∞–º–º–∞—Ä–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    }).catch(() => {
      showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏');
    });
  };
  
  window.clearResults = function() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?')) {
      document.getElementById('resultsList').innerHTML = '';
      document.getElementById('results').style.display = 'none';
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
      totalJobs = 0;
      completedJobs = 0;
      updateOverallProgress();
      
      showNotification('üóëÔ∏è –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã');
    }
  };
})();
</script>
</body>
</html>
