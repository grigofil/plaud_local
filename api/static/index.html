<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ê—É–¥–∏–æ ‚Üí –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è + –°–∞–º–º–∞—Ä–∏</title>
  <style>
    body{font-family:system-ui, sans-serif;max-width:920px;margin:24px auto;padding:0 16px}
    h1{font-size:1.6rem;margin:0 0 12px}
    .card{border:1px solid #ddd;border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{padding:10px 14px;border-radius:10px;border:1px solid #ccc;background:#fff;cursor:pointer}
    button.primary{background:#111;color:#fff;border-color:#111}
    button[disabled]{opacity:.5;cursor:not-allowed}
    input[type="file"]{display:block;margin:8px 0}
    
    /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ */
    #micSelect {
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 8px;
      background: #fff;
      font-size: 14px;
      min-width: 200px;
    }
    
    #micSelect:focus {
      outline: none;
      border-color: #2196F3;
      box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
    }
    
    #btnRefreshMics {
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.2s ease;
    }
    
    #btnRefreshMics:hover {
      transform: scale(1.05);
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .muted{color:#666}
    pre{white-space:pre-wrap;background:#f7f7f7;border-radius:8px;padding:12px;overflow:auto}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:6px 10px;margin-right:8px;background:#fafafa}
    .ok{color:#0a7a32} .warn{color:#a66a00}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width: 800px){.grid{grid-template-columns:1fr}}
    
    /* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */
    .progress-container {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 10px;
      margin: 8px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 20px;
      background: linear-gradient(90deg, #4CAF50, #45a049);
      border-radius: 10px;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
    
    .progress-bar.processing { background: linear-gradient(90deg, #2196F3, #1976D2); }
    .progress-bar.transcribing { background: linear-gradient(90deg, #FF9800, #F57C00); }
    .progress-bar.summarizing { background: linear-gradient(90deg, #9C27B0, #7B1FA2); }
    .progress-bar.done { background: linear-gradient(90deg, #4CAF50, #45a049); }
    .progress-bar.error { background: linear-gradient(90deg, #f44336, #d32f2f); }
    
    /* –°—Ç–∞—Ç—É—Å—ã */
    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .status-queued { background: #e3f2fd; color: #1976d2; }
    .status-processing { background: #fff3e0; color: #f57c00; }
    .status-transcribing { background: #fff8e1; color: #f57c00; }
    .status-summarizing { background: #f3e5f5; color: #7b1fa2; }
    .status-done { background: #e8f5e8; color: #388e3c; }
    .status-error { background: #ffebee; color: #d32f2f; }
    
    /* –°—Ç–∞—Ç—É—Å—ã –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ */
    .status-waiting { background: #fff8e1; color: #f57c00; }
    .status-unknown { background: #f5f5f5; color: #666; }
    
    /* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã */
    .result-card {
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 20px;
      margin: 16px 0;
      background: #fafafa;
      transition: all 0.3s ease;
    }
    
    .result-card:hover {
      border-color: #2196F3;
      box-shadow: 0 4px 12px rgba(33, 150, 243, 0.15);
    }
    
    .result-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .result-title {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .result-meta {
      font-size: 12px;
      color: #666;
    }
    
    .result-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    
    @media (max-width: 800px) {
      .result-content { grid-template-columns: 1fr; }
    }
    
    .result-section {
      background: white;
      padding: 16px;
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }
    
    .result-section h4 {
      margin: 0 0 12px 0;
      color: #333;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .action-item {
      background: #f5f5f5;
      padding: 8px 12px;
      margin: 4px 0;
      border-radius: 6px;
      border-left: 3px solid #2196F3;
    }
    
    .key-point {
      background: #fff3e0;
      padding: 6px 10px;
      margin: 4px 0;
      border-radius: 6px;
      border-left: 3px solid #ff9800;
    }
    
    .risk-item {
      background: #ffebee;
      padding: 6px 10px;
      margin: 4px 0;
      border-radius: 6px;
      border-left: 3px solid #f44336;
    }
  </style>
</head>
<body>
  <h1>–ó–∞–ø–∏—Å—å/–∑–∞–≥—Ä—É–∑–∫–∞ –∞—É–¥–∏–æ ‚Üí Whisper ‚Üí DeepSeek</h1>
  
  <!-- –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å -->
  <div id="overallProgress" style="display: none;" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <strong>üìà –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏</strong>
      <span id="progressStats">0/0 –∑–∞–≤–µ—Ä—à–µ–Ω–æ</span>
    </div>
    <div class="progress-container">
      <div id="overallProgressBar" class="progress-bar" style="width: 0%">0%</div>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <label>API base:</label>
      <input id="apiBase" class="mono" style="min-width:280px" value="" placeholder="http://localhost:8000">
      <label>–Ø–∑—ã–∫:</label>
      <select id="lang"><option value="ru" selected>ru</option><option value="en">en</option></select>
    </div>
    <div class="row" style="margin-top:8px">
      <label>API key:</label>
      <input id="apiKey" class="mono" style="min-width:280px" placeholder="Bearer token">
      <button id="saveKey">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <span id="keyStatus" class="muted"></span>
    </div>
    <div class="muted" style="margin-top:6px">
      –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–µ—Ä—ë—Ç—Å—è —Ç–µ–∫—É—â–∏–π origin. –ï—Å–ª–∏ API –Ω–∞ –¥—Ä—É–≥–æ–º —Ö–æ—Å—Ç–µ/–ø–æ—Ä—Ç—É ‚Äî —É–∫–∞–∂–∏ —Ç—É—Ç, –Ω–∞–ø—Ä–∏–º–µ—Ä: <span class="mono">http://localhost:8000</span>
    </div>
  </div>

  <div class="card">
    <h3>üéôÔ∏è –ó–∞–ø–∏—Å—å —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ (–±—Ä–∞—É–∑–µ—Ä)</h3>
    <div class="row">
      <label>–ú–∏–∫—Ä–æ—Ñ–æ–Ω:</label>
      <select id="micSelect" style="min-width:200px">
        <option value="">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä</option>
      </select>
      <button id="btnRefreshMics" style="background:#4CAF50;color:white;border:none;padding:4px 8px;">üîÑ</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button id="btnStart" class="primary">–ù–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å</button>
      <button id="btnStop" disabled>–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
      <button id="btnTestMic" style="background:#2196F3;color:white;border:none;">üé§ –¢–µ—Å—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞</button>
      <span id="recStatus" class="pill muted">–Ω–µ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è</span>
    </div>
    <div id="recTime" class="muted" style="margin-top:8px"></div>
    <div id="micInfo" class="muted" style="margin-top:8px;font-size:12px;"></div>
    <audio id="player" controls style="display:none;margin-top:8px"></audio>
  </div>

  <div class="card">
    <h3>üì§ –ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥–æ—Ç–æ–≤—ã–π —Ñ–∞–π–ª</h3>
    <input id="fileInput" type="file" accept="audio/*,video/webm"/>
    <button id="btnUpload">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
  </div>

  <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏ -->
  <div class="card">
    <div class="row">
      <h3>üìö –ò—Å—Ç–æ—Ä–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏</h3>
      <button id="btnLoadHistory" class="primary">üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
      <button id="btnClearHistory" style="background:#f44336;color:white;border:none;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
    </div>
    <div id="historyContainer" style="display: none;">
      <div id="historyList"></div>
    </div>
  </div>

  <div id="jobs"></div>
  
  <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ -->
  <div id="results" style="display: none;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏</h2>
      <button onclick="clearResults()" style="background:#f44336;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
      </button>
    </div>
    <div id="resultsList"></div>
  </div>

<script>
(() => {
  const $ = sel => document.querySelector(sel);
  const apiBaseInput = $('#apiBase');
  const langSel = $('#lang');
  const btnStart = $('#btnStart');
  const btnStop = $('#btnStop');
  const statusSpan = $('#recStatus');
  const recTimeEl = $('#recTime');
  const fileInput = $('#fileInput');
  const btnUpload = $('#btnUpload');
  const player = $('#player');
  const jobs = $('#jobs');
  const micSelect = $('#micSelect');
  const btnRefreshMics = $('#btnRefreshMics');

  // API base: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–µ–∫—É—â–∏–π origin
  apiBaseInput.value = `${location.protocol}//${location.host}`;
  
  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ API base
  apiBaseInput.onchange = () => {
    showNotification(`üîó API base –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${apiBaseInput.value}`);
  };
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π API –∫–ª—é—á
  const savedKey = localStorage.getItem('plaud_api_key');
  if (savedKey) {
    $('#apiKey').value = savedKey;
    updateKeyStatus('–ö–ª—é—á –∑–∞–≥—Ä—É–∂–µ–Ω', 'ok');
    showNotification('üîë API –∫–ª—é—á –∑–∞–≥—Ä—É–∂–µ–Ω –∏–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö');
  }
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  const savedMicId = localStorage.getItem('plaud_selected_mic');
  if (savedMicId) {
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤
    window.savedMicId = savedMicId;
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  async function checkAuth() {
    const apiKey = $('#apiKey').value;
    if (!apiKey) {
      updateKeyStatus('–í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á', 'warn');
      return false;
    }
    
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      const response = await fetch(`${apiBase}/auth/check`, {
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });
      
             if (response.ok) {
         const data = await response.json();
         updateKeyStatus('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞', 'ok');
         showNotification('üîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
         return true;
       } else {
         updateKeyStatus('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'warn');
         showNotification('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
         return false;
       }
         } catch (error) {
       updateKeyStatus('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'warn');
       showNotification('üåê –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
       return false;
     }
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫–ª—é—á–∞
  function updateKeyStatus(message, type) {
    const statusEl = $('#keyStatus');
    statusEl.textContent = message;
    statusEl.className = type === 'ok' ? 'ok' : 'warn';
  }

  // ====== —Ä–∞–±–æ—Ç–∞ —Å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞–º–∏ ======
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤
  async function getAvailableMicrophones() {
    try {
      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫
      stream.getTracks().forEach(t => t.stop());
      
      // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
      const devices = await navigator.mediaDevices.enumerateDevices();
      const audioInputs = devices.filter(device => device.kind === 'audioinput');
      
      console.log('–î–æ—Å—Ç—É–ø–Ω—ã–µ –∞—É–¥–∏–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:', audioInputs);
      
      // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
      micSelect.innerHTML = '<option value="">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä</option>';
      
      // –î–æ–±–∞–≤–ª—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –≤ —Å–ø–∏—Å–æ–∫
      audioInputs.forEach(device => {
        const option = document.createElement('option');
        option.value = device.deviceId;
        option.textContent = device.label || `–ú–∏–∫—Ä–æ—Ñ–æ–Ω ${device.deviceId.slice(0, 8)}...`;
        micSelect.appendChild(option);
      });
      
      // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
      if (window.savedMicId) {
        const savedOption = micSelect.querySelector(`option[value="${window.savedMicId}"]`);
        if (savedOption) {
          micSelect.value = window.savedMicId;
          showNotification(`üé§ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—ã–±–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ${savedOption.textContent}`);
        }
        // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π ID
        window.savedMicId = null;
      }
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
      if (audioInputs.length > 0) {
        showNotification(`üîç –ù–∞–π–¥–µ–Ω–æ ${audioInputs.length} –∞—É–¥–∏–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤`);
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
        const micInfo = document.getElementById('micInfo');
        micInfo.innerHTML = `
          <strong>üì± –î–æ—Å—Ç—É–ø–Ω—ã–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω—ã:</strong><br>
          ${audioInputs.map((device, index) => 
            `${index + 1}. ${device.label || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ'} (${device.deviceId.slice(0, 8)}...)`
          ).join('<br>')}
        `;
      } else {
        showNotification('‚ö†Ô∏è –ê—É–¥–∏–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
      }
      
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤:', err);
      showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤: ' + err.message);
      
      if (err.name === 'NotAllowedError') {
        showNotification('üîí –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤');
      }
    }
  }
  
  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤
  function refreshMicrophones() {
    showNotification('üîÑ –û–±–Ω–æ–≤–ª—è—é —Å–ø–∏—Å–æ–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤...');
    getAvailableMicrophones();
  }

  // ====== –∑–∞–ø–∏—Å—å ======
  let mediaRecorder, chunks=[], startTs=null, tickTimer=null, recordedBlob=null, recordedName=null;

  function supports(mime){ return (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(mime)); }

  async function startRec(){
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∑–∞–ø–∏—Å–∏
    if (!await checkAuth()) {
      showNotification('‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º –∑–∞–ø–∏—Å–∏');
      return;
    }
    
    try{
      console.log('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...');
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É–¥–∏–æ
      const audioConstraints = {
        echoCancellation: true,
        noiseSuppression: true,
        autoGainControl: true,
        sampleRate: 48000,
        channelCount: 1
      };
      
      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ ID
      const selectedMicId = micSelect.value;
      if (selectedMicId) {
        audioConstraints.deviceId = { exact: selectedMicId };
        console.log('–ò—Å–ø–æ–ª—å–∑—É—é –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω:', selectedMicId);
      } else {
        console.log('–ò—Å–ø–æ–ª—å–∑—É—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');
      }
      
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: audioConstraints
      });
      
      console.log('–ü–æ–ª—É—á–µ–Ω –ø–æ—Ç–æ–∫ –∞—É–¥–∏–æ:', stream);
      console.log('–ê—É–¥–∏–æ —Ç—Ä–µ–∫–∏:', stream.getAudioTracks());
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –∞—É–¥–∏–æ —Ç—Ä–µ–∫–∏
      const audioTracks = stream.getAudioTracks();
      if (audioTracks.length === 0) {
        throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –∞—É–¥–∏–æ —Ç—Ä–µ–∫–∏');
      }
      
      const audioTrack = audioTracks[0];
      console.log('–ê—É–¥–∏–æ —Ç—Ä–µ–∫:', audioTrack.label, audioTrack.enabled, audioTrack.muted);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
      const mime = supports('audio/webm;codecs=opus') ? 'audio/webm;codecs=opus'
                  : supports('audio/ogg;codecs=opus')  ? 'audio/ogg;codecs=opus'
                  : supports('audio/webm') ? 'audio/webm'
                  : 'audio/wav';
      
      console.log('–í—ã–±—Ä–∞–Ω MIME —Ç–∏–ø:', mime);
      
      // –°–æ–∑–¥–∞–µ–º MediaRecorder —Å —É–ª—É—á—à–µ–Ω–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
      mediaRecorder = new MediaRecorder(stream, {
        mimeType: mime,
        audioBitsPerSecond: 128000
      });
      
      chunks = []; 
      recordedBlob = null; 
      recordedName = null;
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
      mediaRecorder.ondataavailable = e => { 
        console.log('–ü–æ–ª—É—á–µ–Ω —á–∞–Ω–∫ –¥–∞–Ω–Ω—ã—Ö:', e.data.size, '–±–∞–π—Ç');
        if(e.data && e.data.size > 0) {
          chunks.push(e.data);
        }
      };
      
      mediaRecorder.onstart = () => {
        console.log('–ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å');
        showNotification('üéôÔ∏è –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å');
      };
      
      mediaRecorder.onstop = onStopRec;
      
      mediaRecorder.onerror = (event) => {
        console.error('–û—à–∏–±–∫–∞ MediaRecorder:', event);
        showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏: ' + event.error);
      };
      
      // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å —Å –±–æ–ª–µ–µ —á–∞—Å—Ç—ã–º –ø–æ–ª—É—á–µ–Ω–∏–µ–º —á–∞–Ω–∫–æ–≤
      mediaRecorder.start(100); // –∫–∞–∂–¥—ã–µ 100–º—Å —á–∞–Ω–∫–∏
      
      startTs = Date.now();
      tickTimer = setInterval(()=>{
        const s = Math.floor((Date.now()-startTs)/1000);
        recTimeEl.textContent = `–ò–¥—ë—Ç –∑–∞–ø–∏—Å—å: ${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`;
      }, 500);
      
      btnStart.disabled = true; 
      btnStop.disabled = false;
      statusSpan.textContent = '–∑–∞–ø–∏—Å—å‚Ä¶';
      statusSpan.className = 'pill';
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–ø–∏—Å–∏
      showNotification(`üéôÔ∏è –ó–∞–ø–∏—Å—å –Ω–∞—á–∞–ª–∞—Å—å (${mime})`);
      
    }catch(err){
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø–∏—Å–∏:', err);
      showNotification('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É: ' + err.message);
      
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞
      if (err.name === 'NotAllowedError') {
        showNotification('üîí –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞');
      } else if (err.name === 'NotFoundError') {
        showNotification('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
      } else if (err.name === 'NotReadableError') {
        showNotification('üì± –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º');
      }
    }
  }

  function onStopRec(){
    console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏...');
    clearInterval(tickTimer);
    
    if (chunks.length === 0) {
      showNotification('‚ö†Ô∏è –ù–µ –ø–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω');
      return;
    }
    
    console.log('–°–æ–∑–¥–∞—é Blob –∏–∑', chunks.length, '—á–∞–Ω–∫–æ–≤');
    const blob = new Blob(chunks, {type: mediaRecorder.mimeType || 'audio/webm'});
    recordedBlob = blob;
    
    console.log('–†–∞–∑–º–µ—Ä –∑–∞–ø–∏—Å–∏:', blob.size, '–±–∞–π—Ç');
    
    if (blob.size === 0) {
      showNotification('‚ö†Ô∏è –ó–∞–ø–∏—Å—å –ø—É—Å—Ç–∞—è. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏');
      return;
    }
    
    recordedName = `recording_${new Date().toISOString().replace(/[:.]/g,'-')}.${blob.type.startsWith('audio/ogg')?'ogg':'webm'}`;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞—É–¥–∏–æ –ø–ª–µ–µ—Ä
    player.src = URL.createObjectURL(blob);
    player.style.display = 'block';
    
    recTimeEl.textContent = `–ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${(blob.size/1024/1024).toFixed(2)} MB`;
    statusSpan.textContent = '–≥–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ';
    statusSpan.className = 'pill ok';
    
    showNotification(`‚úÖ –ó–∞–ø–∏—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∞ (${(blob.size/1024/1024).toFixed(2)} MB), –Ω–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É...`);
    
    // –∞–≤—Ç–æ-–æ—Ç–ø—Ä–∞–≤–∫–∞
    uploadBlob(blob, recordedName);
  }

  function stopRec(){
    console.log('–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–ø–∏—Å–∏...');
    if(mediaRecorder && mediaRecorder.state !== 'inactive'){
      mediaRecorder.stop();
      mediaRecorder.stream.getTracks().forEach(t => {
        console.log('–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Ç—Ä–µ–∫:', t.label);
        t.stop();
      });
    }
    btnStart.disabled = false; 
    btnStop.disabled = true;
  }
  
  // –§—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  async function testMicrophone() {
    try {
      console.log('–¢–µ—Å—Ç–∏—Ä—É—é –º–∏–∫—Ä–æ—Ñ–æ–Ω...');
      showNotification('üé§ –¢–µ—Å—Ç–∏—Ä—É—é –º–∏–∫—Ä–æ—Ñ–æ–Ω...');
      
      // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞—É–¥–∏–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      const audioConstraints = {
        echoCancellation: false,
        noiseSuppression: false,
        autoGainControl: false
      };
      
      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ ID
      const selectedMicId = micSelect.value;
      if (selectedMicId) {
        audioConstraints.deviceId = { exact: selectedMicId };
        console.log('–¢–µ—Å—Ç–∏—Ä—É—é –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω:', selectedMicId);
      } else {
        console.log('–¢–µ—Å—Ç–∏—Ä—É—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∏–∫—Ä–æ—Ñ–æ–Ω');
      }
      
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: audioConstraints
      });
      
      const audioTracks = stream.getAudioTracks();
      if (audioTracks.length === 0) {
        throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –∞—É–¥–∏–æ —Ç—Ä–µ–∫–∏');
      }
      
      const audioTrack = audioTracks[0];
      const micInfo = document.getElementById('micInfo');
      
      micInfo.innerHTML = `
        <strong>üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–∞–π–¥–µ–Ω:</strong><br>
        –ù–∞–∑–≤–∞–Ω–∏–µ: ${audioTrack.label || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>
        –í–∫–ª—é—á–µ–Ω: ${audioTrack.enabled ? '‚úÖ' : '‚ùå'}<br>
        –ó–∞–≥–ª—É—à–µ–Ω: ${audioTrack.muted ? 'üîá' : 'üîä'}<br>
        –°–æ—Å—Ç–æ—è–Ω–∏–µ: ${audioTrack.readyState}<br>
        ID: ${audioTrack.id}<br>
        <br>
        <strong>üì± –¢–µ–∫—É—â–∏–π –≤—ã–±–æ—Ä:</strong><br>
        ${micSelect.value ? 
          `‚úÖ ${micSelect.options[micSelect.selectedIndex].textContent}` : 
          'üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä'
        }
      `;
      
      showNotification('‚úÖ –ú–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç!');
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫
      stream.getTracks().forEach(t => t.stop());
      
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:', err);
      const micInfo = document.getElementById('micInfo');
      micInfo.innerHTML = `<strong>‚ùå –û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞:</strong> ${err.message}`;
      
      if (err.name === 'NotAllowedError') {
        showNotification('üîí –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞');
      } else if (err.name === 'NotFoundError') {
        showNotification('üé§ –ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞');
      } else if (err.name === 'NotReadableError') {
        showNotification('üì± –ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º');
      } else {
        showNotification('‚ùå –û—à–∏–±–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞: ' + err.message);
      }
    }
  }

  btnStart.onclick = startRec;
  btnStop.onclick = stopRec;
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  document.getElementById('btnTestMic').onclick = testMicrophone;
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤
  btnRefreshMics.onclick = refreshMicrophones;
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—ã–±–æ—Ä–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  micSelect.onchange = () => {
    const selectedMicId = micSelect.value;
    if (selectedMicId) {
      const selectedOption = micSelect.options[micSelect.selectedIndex];
      showNotification(`üé§ –í—ã–±—Ä–∞–Ω –º–∏–∫—Ä–æ—Ñ–æ–Ω: ${selectedOption.textContent}`);
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä –≤ localStorage
      localStorage.setItem('plaud_selected_mic', selectedMicId);
    } else {
      showNotification('üé§ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞');
      // –£–¥–∞–ª—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
      localStorage.removeItem('plaud_selected_mic');
    }
  };
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
  $('#saveKey').onclick = async () => {
    const apiKey = $('#apiKey').value;
    if (apiKey) {
      localStorage.setItem('plaud_api_key', apiKey);
      showNotification('üíæ API –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
      await checkAuth();
    } else {
      showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
    }
  };
  
  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–ª—é—á–∞
  $('#apiKey').oninput = () => {
    updateKeyStatus('–ö–ª—é—á –∏–∑–º–µ–Ω–µ–Ω', 'warn');
    showNotification('üîë API –∫–ª—é—á –∏–∑–º–µ–Ω–µ–Ω');
  };
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  setTimeout(async () => {
    if (await checkAuth()) {
      showNotification('üéâ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Plaud Local!');
    }
  }, 1000);
  
  // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
  setTimeout(() => {
    getAvailableMicrophones();
  }, 1500);
  
  // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —è–∑—ã–∫–∞
  langSel.onchange = () => {
    showNotification(`üåê –Ø–∑—ã–∫ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${langSel.value.toUpperCase()}`);
  };

  // ====== –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ ======
  btnUpload.onclick = async ()=>{
    const f = fileInput.files?.[0];
    if(!f){ 
      showNotification('‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏');
      return; 
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π
    if (!await checkAuth()) {
      showNotification('‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
      return;
    }
    
    showNotification(`üì§ –ù–∞—á–∏–Ω–∞—é –∑–∞–≥—Ä—É–∑–∫—É —Ñ–∞–π–ª–∞: ${f.name}`);
    uploadBlob(f, f.name);
  };

  // ====== –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤ API ======
  async function uploadBlob(blob, filename){
    const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
    const lang = langSel.value || 'ru';
    const apiKey = $('#apiKey').value;
    
    if (!apiKey) {
      showNotification('‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
      return;
    }
    
    const card = makeJobCard({filename, lang});
    jobs.prepend(card.el);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–∞—á—É –≤ –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
    addJob();

    try{
      const fd = new FormData();
      fd.append('file', blob, filename);
      const res = await fetch(`${apiBase}/upload?language=${encodeURIComponent(lang)}`, {
        method: 'POST',
        body: fd,
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });
      if(!res.ok){ throw new Error(await res.text()); }
      const {job_id} = await res.json();
      card.setJobId(job_id);
      pollStatus(apiBase, job_id, card);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
      showNotification(`üì§ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω: ${filename}`);
    }catch(e){
      card.setError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: '+e.message);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${e.message}`);
    }
  }

  function makeJobCard({filename, lang}){
    const el = document.createElement('div');
    el.className='card';
    el.innerHTML = `
      <div class="row">
        <strong>${filename}</strong>
        <span class="pill">lang=${lang}</span>
      </div>
      <div class="muted mono" style="margin-top:4px">job: <span class="jobid">‚Äî</span></div>
      
      <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä -->
      <div class="progress-container" style="margin-top:12px;">
        <div class="progress-bar" style="width: 0%">0%</div>
      </div>
      
      <!-- –°—Ç–∞—Ç—É—Å —Å –∏–∫–æ–Ω–∫–æ–π -->
      <div style="margin-top:8px;display:flex;align-items:center;gap:8px;">
        <span class="status-badge status-queued">–í –æ—á–µ—Ä–µ–¥–∏</span>
        <span class="status-text muted">–û–∂–∏–¥–∞–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏...</span>
      </div>
      
      <!-- –î–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞ -->
      <div class="process-details" style="margin-top:8px;font-size:12px;color:#666;">
        <div>üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...</div>
      </div>
      
      <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Å–∫—Ä—ã—Ç—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
      <div class="results-section" style="margin-top:16px;display:none;">
        <div class="grid">
          <div class="result-section">
            <h4>üéØ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</h4>
            <div class="transcript-content"></div>
          </div>
          <div class="result-section">
            <h4>üìù –°–∞–º–º–∞—Ä–∏</h4>
            <div class="summary-content"></div>
          </div>
        </div>
        <div class="row" style="margin-top:12px;justify-content:center;">
          <button class="btn-json">üì• –°–∫–∞—á–∞—Ç—å JSON</button>
          <button class="btn-copy">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏</button>
        </div>
      </div>
    `;
    
    const jobEl = el.querySelector('.jobid');
    const progressBar = el.querySelector('.progress-bar');
    const statusBadge = el.querySelector('.status-badge');
    const statusText = el.querySelector('.status-text');
    const processDetails = el.querySelector('.process-details');
    const resultsSection = el.querySelector('.results-section');
    const transcriptContent = el.querySelector('.transcript-content');
    const summaryContent = el.querySelector('.summary-content');
    const btnJson = el.querySelector('.btn-json');
    const btnCopy = el.querySelector('.btn-copy');

    let lastResult = null;

    function updateProgress(percent, status, details) {
      progressBar.style.width = percent + '%';
      progressBar.textContent = percent + '%';
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∫–ª–∞—Å—Å—ã –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
      progressBar.className = 'progress-bar';
      if (status === 'processing' || status === 'queued') progressBar.classList.add('processing');
      else if (status === 'transcribed_waiting_summary') progressBar.classList.add('transcribing');
      else if (status === 'done') progressBar.classList.add('done');
      else if (status === 'error') progressBar.classList.add('error');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
      statusBadge.className = 'status-badge';
      if (status === 'queued') statusBadge.classList.add('status-queued');
      else if (status === 'processing') statusBadge.classList.add('status-processing');
      else if (status === 'transcribed_waiting_summary') statusBadge.classList.add('status-transcribing');
      else if (status === 'done') statusBadge.classList.add('status-done');
      else if (status === 'error') statusBadge.classList.add('status-error');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
      const statusMessages = {
        'queued': '–í –æ—á–µ—Ä–µ–¥–∏',
        'processing': '–û–±—Ä–∞–±–æ—Ç–∫–∞...',
        'transcribed_waiting_summary': '–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–º–∞—Ä–∏...',
        'done': '–ì–æ—Ç–æ–≤–æ!',
        'error': '–û—à–∏–±–∫–∞'
      };
      statusBadge.textContent = statusMessages[status] || status;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞
      if (details) {
        processDetails.innerHTML = details;
      }
    }

    return {
      el,
      setJobId(id) { 
        jobEl.textContent = id; 
        updateProgress(10, 'queued', 'üì§ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–∂–∏–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏...');
      },
      setStatus(status) { 
        if (status === 'queued') updateProgress(20, status, 'üì§ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –æ–∂–∏–¥–∞–Ω–∏–µ –≤ –æ—á–µ—Ä–µ–¥–∏...');
        else if (status === 'processing') updateProgress(40, status, 'üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—É–¥–∏–æ...');
        else if (status === 'transcribed_waiting_summary') updateProgress(70, status, 'üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∞–º–º–∞—Ä–∏...');
        else if (status === 'done') updateProgress(100, status, '‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!');
        else updateProgress(0, 'error', '‚ùå –û—à–∏–±–∫–∞: ' + status);
      },
      setError(msg) { 
        updateProgress(0, 'error', '‚ùå –û—à–∏–±–∫–∞: ' + msg);
        statusText.innerHTML = `<span class="warn">${msg}</span>`;
      },
      showResult(data) {
        lastResult = data;
        resultsSection.style.display = 'block';
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
        const transcript = data?.transcript;
        if (transcript) {
          transcriptContent.innerHTML = `
            <div style="margin-bottom:12px;">
              <strong>–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç:</strong>
              <div style="background:#f5f5f5;padding:8px;border-radius:4px;margin-top:4px;font-size:13px;">
                ${transcript.text || '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}
              </div>
            </div>
            <div>
              <strong>–°–µ–≥–º–µ–Ω—Ç—ã:</strong>
              <div style="max-height:200px;overflow-y:auto;">
                ${(transcript.segments || []).map(seg => `
                  <div style="background:#f0f0f0;padding:4px 8px;margin:2px 0;border-radius:4px;font-size:12px;">
                    <span style="color:#666;">${formatTime(seg.start)} - ${formatTime(seg.end)}</span>
                    <br>${seg.text}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–∞–º–º–∞—Ä–∏
        const summary = data?.summary;
        if (summary) {
          let summaryHtml = '';
          
          if (summary.meeting_summary) {
            summaryHtml += `
              <div style="margin-bottom:16px;">
                <strong>üìã –†–µ–∑—é–º–µ –≤—Å—Ç—Ä–µ—á–∏:</strong>
                <div style="background:#e8f5e8;padding:12px;border-radius:6px;margin-top:6px;font-size:13px;">
                  ${summary.meeting_summary}
                </div>
              </div>
            `;
          }
          
          if (summary.key_points && summary.key_points.length > 0) {
            summaryHtml += `
              <div style="margin-bottom:16px;">
                <strong>üéØ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:</strong>
                ${summary.key_points.map(point => `
                  <div class="key-point">${point}</div>
                `).join('')}
              </div>
            `;
          }
          
          if (summary.action_items && summary.action_items.length > 0) {
            summaryHtml += `
              <div style="margin-bottom:16px;">
                <strong>‚úÖ –ó–∞–¥–∞—á–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è:</strong>
                ${summary.action_items.map(item => `
                  <div class="action-item">
                    <strong>${item.owner || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong>: ${item.task || '–ó–∞–¥–∞—á–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
                    ${item.due ? `<br><small>–°—Ä–æ–∫: ${item.due}</small>` : ''}
                  </div>
                `).join('')}
              </div>
            `;
          }
          
          if (summary.risks && summary.risks.length > 0) {
            summaryHtml += `
              <div style="margin-bottom:16px;">
                <strong>‚ö†Ô∏è –†–∏—Å–∫–∏:</strong>
                ${summary.risks.map(risk => `
                  <div class="risk-item">${risk}</div>
                `).join('')}
              </div>
            `;
          }
          
          if (summary.raw && !summary.meeting_summary) {
            summaryHtml += `
              <div style="margin-bottom:16px;">
                <strong>üìÑ –°—ã—Ä–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong>
                <div style="background:#f5f5f5;padding:12px;border-radius:6px;margin-top:6px;font-size:13px;white-space:pre-wrap;">
                  ${summary.raw}
                </div>
              </div>
            `;
          }
          
          summaryContent.innerHTML = summaryHtml || '<em>–°–∞–º–º–∞—Ä–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</em>';
        }
        
        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫
        btnJson.onclick = () => {
          const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `result_${data.job_id}.json`;
          a.click();
          URL.revokeObjectURL(a.href);
          showNotification('üì• JSON —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω');
        };
        
        btnCopy.onclick = async () => {
          try {
            const textToCopy = summaryContent.textContent || '';
            await navigator.clipboard.writeText(textToCopy);
            btnCopy.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => btnCopy.textContent = 'üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏', 2000);
            showNotification('üìã –°–∞–º–º–∞—Ä–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
          } catch(e) { 
            showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏');
          }
        };
      }
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
  function formatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }
  
  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  function showNotification(message) {
    // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: #4CAF50;
      color: white;
      padding: 16px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      max-width: 300px;
      animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
    if (!document.querySelector('#notification-styles')) {
      const style = document.createElement('style');
      style.id = 'notification-styles';
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
      `;
      document.head.appendChild(style);
    }
    
    document.body.appendChild(notification);
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    }, 5000);
    
    // –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–∫—Ä—ã—Ç—å –ø–æ –∫–ª–∏–∫—É
    notification.onclick = () => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 300);
    };
  }

  async function pollStatus(apiBase, jobId, card){
    card.setStatus('processing');
    let done = false;
    let attempts = 0;
    const apiKey = $('#apiKey').value;
    
    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
    showNotification('üîÑ –ù–∞—á–∏–Ω–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É –∞—É–¥–∏–æ...');
    
    const tick = async () => {
      attempts++;
      try {
        const s = await fetch(`${apiBase}/status/${jobId}`, {
          headers: {
            'Authorization': `Bearer ${apiKey}`
          }
        }).then(r => r.json());
        
        card.setStatus(s.status);
        
        // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞
        if (s.status === 'transcribed_waiting_summary') {
          showNotification('üìù –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞, —Å–æ–∑–¥–∞—é —Å–∞–º–º–∞—Ä–∏...');
        }
        
        if (s.status === 'done') {
          try {
            const out = await fetch(`${apiBase}/result/${jobId}`, {
              headers: {
                'Authorization': `Bearer ${apiKey}`
              }
            }).then(r => r.json());
            
            card.showResult(out);
            done = true;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–µ–∫—Ü–∏—é —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
            document.getElementById('results').style.display = 'block';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫
            addToResultsList(out, card.el.querySelector('strong').textContent);
            
            // –û—Ç–º–µ—á–∞–µ–º –∑–∞–¥–∞—á—É –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—É—é
            completeJob();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(`‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${card.el.querySelector('strong').textContent}`);
            
                     } catch (e) {
             card.setError('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ' + e.message);
             showNotification(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞: ${e.message}`);
             done = true;
           }
                 } else if (s.status === 'error') {
           card.setError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏');
           showNotification(`‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–¥–∞—á–∏`);
           done = true;
        }
      } catch (e) {
                 if (attempts > 10) {
           card.setError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ' + e.message);
           showNotification(`‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${e.message}`);
           done = true;
         } else {
           // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏ –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ—à–∏–±–∫–∞—Ö
           console.log('–í—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞, –ø–æ–≤—Ç–æ—Ä—è–µ–º...', e.message);
         }
      }
      
      if (!done) {
        // –ë–æ–ª–µ–µ —á–∞—Å—Ç–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –ª—É—á—à–µ–≥–æ UX
        const delay = s?.status === 'processing' ? 1500 : 2000;
        setTimeout(tick, delay);
      }
    };
    
    tick();
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫
  function addToResultsList(data, filename) {
    const resultsList = document.getElementById('resultsList');
    const resultCard = document.createElement('div');
    resultCard.className = 'result-card';
    
    const transcript = data?.transcript;
    const summary = data?.summary;
    
    resultCard.innerHTML = `
      <div class="result-header">
        <div class="result-title">üìÅ ${filename}</div>
        <div class="result-meta">
          Job ID: ${data.job_id}<br>
          ${new Date().toLocaleString('ru-RU')}
        </div>
      </div>
      <div class="result-content">
        <div class="result-section">
          <h4>üéØ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</h4>
          <div style="max-height:300px;overflow-y:auto;">
            ${transcript ? `
              <div style="margin-bottom:12px;">
                <strong>–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç:</strong>
                <div style="background:#f5f5f5;padding:8px;border-radius:4px;margin-top:4px;font-size:13px;">
                  ${transcript.text || '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}
                </div>
              </div>
              <div>
                <strong>–°–µ–≥–º–µ–Ω—Ç—ã (${transcript.segments?.length || 0}):</strong>
                <div style="max-height:150px;overflow-y:auto;">
                  ${(transcript.segments || []).map(seg => `
                    <div style="background:#f0f0f0;padding:4px 8px;margin:2px 0;border-radius:4px;font-size:12px;">
                      <span style="color:#666;">${formatTime(seg.start)} - ${formatTime(seg.end)}</span>
                      <br>${seg.text}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : '<em>–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</em>'}
          </div>
        </div>
        <div class="result-section">
          <h4>üìù –°–∞–º–º–∞—Ä–∏</h4>
          <div style="max-height:300px;overflow-y:auto;">
            ${summary ? `
              ${summary.meeting_summary ? `
                <div style="margin-bottom:12px;">
                  <strong>üìã –†–µ–∑—é–º–µ –≤—Å—Ç—Ä–µ—á–∏:</strong>
                  <div style="background:#e8f5e8;padding:8px;border-radius:4px;margin-top:4px;font-size:13px;">
                    ${summary.meeting_summary}
                  </div>
                </div>
              ` : ''}
              ${summary.key_points && summary.key_points.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <strong>üéØ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:</strong>
                  ${summary.key_points.map(point => `
                    <div class="key-point">${point}</div>
                  `).join('')}
                </div>
              ` : ''}
              ${summary.action_items && summary.action_items.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <strong>‚úÖ –ó–∞–¥–∞—á–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è:</strong>
                  ${summary.action_items.map(item => `
                    <div class="action-item">
                      <strong>${item.owner || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong>: ${item.task || '–ó–∞–¥–∞—á–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
                      ${item.due ? `<br><small>–°—Ä–æ–∫: ${item.due}</small>` : ''}
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              ${summary.risks && summary.risks.length > 0 ? `
                <div style="margin-bottom:12px;">
                  <strong>‚ö†Ô∏è –†–∏—Å–∫–∏:</strong>
                  ${summary.risks.map(risk => `
                    <div class="risk-item">${risk}</div>
                  `).join('')}
                </div>
              ` : ''}
              ${summary.raw && !summary.meeting_summary ? `
                <div style="margin-bottom:12px;">
                  <strong>üìÑ –°—ã—Ä–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong>
                  <div style="background:#f5f5f5;padding:8px;border-radius:4px;margin-top:4px;font-size:13px;white-space:pre-wrap;">
                    ${summary.raw}
                  </div>
                </div>
              ` : ''}
            ` : '<em>–°–∞–º–º–∞—Ä–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</em>'}
          </div>
        </div>
      </div>
      <div style="text-align:center;margin-top:16px;">
        <button onclick="downloadResult('${data.job_id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})" style="margin-right:8px;">
          üì• –°–∫–∞—á–∞—Ç—å JSON
        </button>
        <button onclick="copySummary(${JSON.stringify(summary).replace(/"/g, '&quot;')})">
          üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏
        </button>
      </div>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
    resultsList.insertBefore(resultCard, resultsList.firstChild);
  }
  
  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—â–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
  let totalJobs = 0;
  let completedJobs = 0;
  
  function updateOverallProgress() {
    const overallProgress = document.getElementById('overallProgress');
    const overallProgressBar = document.getElementById('overallProgressBar');
    const progressStats = document.getElementById('progressStats');
    
    if (totalJobs > 0) {
      overallProgress.style.display = 'block';
      const percent = Math.round((completedJobs / totalJobs) * 100);
      overallProgressBar.style.width = percent + '%';
      overallProgressBar.textContent = percent + '%';
      progressStats.textContent = `${completedJobs}/${totalJobs} –∑–∞–≤–µ—Ä—à–µ–Ω–æ`;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
      overallProgressBar.className = 'progress-bar';
      if (percent < 30) overallProgressBar.classList.add('processing');
      else if (percent < 70) overallProgressBar.classList.add('transcribing');
      else if (percent < 100) overallProgressBar.classList.add('summarizing');
      else overallProgressBar.classList.add('done');
    } else {
      overallProgress.style.display = 'none';
    }
  }
  
  function addJob() {
    totalJobs++;
    updateOverallProgress();
  }
  
  function completeJob() {
    completedJobs++;
    updateOverallProgress();
  }
  
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
  window.downloadResult = function(jobId, data) {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `result_${jobId}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
    showNotification('üì• JSON —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω');
  };
  
  window.copySummary = function(summary) {
    let textToCopy = '';
    
    if (summary.meeting_summary) {
      textToCopy += `–†–µ–∑—é–º–µ –≤—Å—Ç—Ä–µ—á–∏:\n${summary.meeting_summary}\n\n`;
    }
    
    if (summary.key_points && summary.key_points.length > 0) {
      textToCopy += `–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:\n${summary.key_points.map(point => `- ${point}`).join('\n')}\n\n`;
    }
    
    if (summary.action_items && summary.action_items.length > 0) {
      textToCopy += `–ó–∞–¥–∞—á–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è:\n${summary.action_items.map(item => 
        `- ${item.owner || '–ù–µ —É–∫–∞–∑–∞–Ω'}: ${item.task || '–ó–∞–¥–∞—á–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}${item.due ? ` (–¥–æ ${item.due})` : ''}`
      ).join('\n')}\n\n`;
    }
    
    if (summary.risks && summary.risks.length > 0) {
      textToCopy += `–†–∏—Å–∫–∏:\n${summary.risks.map(risk => `- ${risk}`).join('\n')}\n\n`;
    }
    
    if (summary.raw && !summary.meeting_summary) {
      textToCopy += summary.raw;
    }
    
    navigator.clipboard.writeText(textToCopy).then(() => {
      showNotification('üìã –°–∞–º–º–∞—Ä–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
    }).catch(() => {
      showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–∞–º–º–∞—Ä–∏');
    });
  };
  
  window.clearResults = function() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã?')) {
      document.getElementById('resultsList').innerHTML = '';
      document.getElementById('results').style.display = 'none';
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
      totalJobs = 0;
      completedJobs = 0;
      updateOverallProgress();
      
      showNotification('üóëÔ∏è –í—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ—á–∏—â–µ–Ω—ã');
    }
  };
  
  // ====== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–°–¢–û–†–ò–ò ======
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
  $('#btnLoadHistory').onclick = async () => {
    if (!await checkAuth()) {
      showNotification('‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
      return;
    }
    
    await loadHistory();
  };
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
  $('#btnClearHistory').onclick = () => {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?')) {
      document.getElementById('historyList').innerHTML = '';
      document.getElementById('historyContainer').style.display = 'none';
      showNotification('üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
    }
  };
  
  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
  async function loadHistory() {
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      const apiKey = $('#apiKey').value;
      
      showNotification('üìö –ó–∞–≥—Ä—É–∂–∞—é –∏—Å—Ç–æ—Ä–∏—é...');
      
      const response = await fetch(`${apiBase}/history`, {
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      displayHistory(data.jobs);
      
      showNotification(`üìö –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.jobs.length} –∑–∞–¥–∞—á`);
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}`);
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
  function displayHistory(jobs) {
    const historyList = document.getElementById('historyList');
    const historyContainer = document.getElementById('historyContainer');
    
    if (jobs.length === 0) {
      historyList.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
      historyContainer.style.display = 'block';
      return;
    }
    
    let historyHtml = '';
    
    jobs.forEach(job => {
      const statusClass = getStatusClass(job.status);
      const statusText = getStatusText(job.status);
      const createdAt = job.created_at ? new Date(job.created_at * 1000).toLocaleString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      
      historyHtml += `
        <div class="history-item" style="border:1px solid #e0e0e0;border-radius:8px;padding:16px;margin:12px 0;background:#fafafa;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div>
              <strong>üìÅ ${job.filename || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong>
              <div style="font-size:12px;color:#666;margin-top:4px;">
                Job ID: ${job.job_id}<br>
                –Ø–∑—ã–∫: ${job.language || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                –°–æ–∑–¥–∞–Ω–æ: ${createdAt}
              </div>
            </div>
            <div style="text-align:right;">
              <span class="status-badge ${statusClass}">${statusText}</span>
              <div style="font-size:12px;color:#666;margin-top:4px;">
                ${job.has_transcript ? '‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç' : '‚ùå –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç'}<br>
                ${job.has_summary ? '‚úÖ –°–∞–º–º–∞—Ä–∏' : '‚ùå –°–∞–º–º–∞—Ä–∏'}
              </div>
            </div>
          </div>
          
          <div style="display:flex;gap:8px;justify-content:center;">
            <button onclick="viewJobDetails('${job.job_id}')" style="background:#2196F3;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
              üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å
            </button>
            <button onclick="downloadJobResult('${job.job_id}')" style="background:#4CAF50;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
              üì• –°–∫–∞—á–∞—Ç—å
            </button>
            <button onclick="deleteJob('${job.job_id}')" style="background:#f44336;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
              üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
            </button>
          </div>
        </div>
      `;
    });
    
    historyList.innerHTML = historyHtml;
    historyContainer.style.display = 'block';
  }
  
  // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è CSS –∫–ª–∞—Å—Å–∞ –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞
  function getStatusClass(status) {
    switch (status) {
      case 'done': return 'status-done';
      case 'transcribed_waiting_summary': return 'status-transcribing';
      case 'processing': return 'status-processing';
      default: return 'status-queued';
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ —Å—Ç–∞—Ç—É—Å–∞
  function getStatusText(status) {
    switch (status) {
      case 'done': return '–ì–æ—Ç–æ–≤–æ';
      case 'transcribed_waiting_summary': return '–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è';
      case 'processing': return '–û–±—Ä–∞–±–æ—Ç–∫–∞';
      default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }
  }
  
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
  window.viewJobDetails = async function(jobId) {
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      const apiKey = $('#apiKey').value;
      
      const response = await fetch(`${apiBase}/history/${jobId}`, {
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const jobData = await response.json();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª–∏ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
      showJobDetailsModal(jobData);
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏:', error);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π: ${error.message}`);
    }
  };
  
  window.downloadJobResult = async function(jobId) {
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      const apiKey = $('#apiKey').value;
      
      const response = await fetch(`${apiBase}/result/${jobId}`, {
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      
      // –°–∫–∞—á–∏–≤–∞–µ–º JSON —Ñ–∞–π–ª
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `job_${jobId}_result.json`;
      a.click();
      URL.revokeObjectURL(a.href);
      
      showNotification('üì• –†–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–¥–∞—á–∏ —Å–∫–∞—á–∞–Ω');
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:', error);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ${error.message}`);
    }
  };
  
  window.deleteJob = function(jobId) {
    if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É ${jobId}?`)) {
      showNotification('üóëÔ∏è –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á –ø–æ–∫–∞ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞');
      // TODO: –î–æ–±–∞–≤–∏—Ç—å API endpoint –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–¥–∞—á
    }
  };
  
  // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞–¥–∞—á–∏
  function showJobDetailsModal(jobData) {
    // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.style.cssText = `
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 90%;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
    `;
    
    let contentHtml = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;border-bottom:1px solid #e0e0e0;padding-bottom:16px;">
        <h2>üìã –î–µ—Ç–∞–ª–∏ –∑–∞–¥–∞—á–∏</h2>
        <button onclick="this.closest('.modal-overlay').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">&times;</button>
      </div>
      
      <div style="margin-bottom:16px;">
        <strong>üìÅ –§–∞–π–ª:</strong> ${jobData.filename || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
        <strong>üÜî Job ID:</strong> ${jobData.job_id}<br>
        <strong>üåê –Ø–∑—ã–∫:</strong> ${jobData.language || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
        <strong>üìä –°—Ç–∞—Ç—É—Å:</strong> <span class="status-badge ${getStatusClass(jobData.status)}">${getStatusText(jobData.status)}</span>
      </div>
    `;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç
    if (jobData.transcript) {
      contentHtml += `
        <div style="margin-bottom:20px;">
          <h3>üéØ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</h3>
          <div style="background:#f5f5f5;padding:12px;border-radius:6px;max-height:200px;overflow-y:auto;">
            <strong>–ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç:</strong><br>
            ${jobData.transcript.text || '–¢–µ–∫—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}
          </div>
          ${jobData.transcript.segments ? `
            <div style="margin-top:12px;">
              <strong>–°–µ–≥–º–µ–Ω—Ç—ã (${jobData.transcript.segments.length}):</strong>
              <div style="max-height:150px;overflow-y:auto;">
                ${jobData.transcript.segments.map(seg => `
                  <div style="background:#e0e0e0;padding:6px 10px;margin:4px 0;border-radius:4px;font-size:12px;">
                    <span style="color:#666;">${formatTime(seg.start)} - ${formatTime(seg.end)}</span><br>
                    ${seg.text}
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–∞–º–º–∞—Ä–∏
    if (jobData.summary) {
      contentHtml += `
        <div style="margin-bottom:20px;">
          <h3>üìù –°–∞–º–º–∞—Ä–∏</h3>
          ${jobData.summary.meeting_summary ? `
            <div style="background:#e8f5e8;padding:12px;border-radius:6px;margin-bottom:12px;">
              <strong>üìã –†–µ–∑—é–º–µ –≤—Å—Ç—Ä–µ—á–∏:</strong><br>
              ${jobData.summary.meeting_summary}
            </div>
          ` : ''}
          ${jobData.summary.key_points && jobData.summary.key_points.length > 0 ? `
            <div style="margin-top:12px;">
              <strong>üéØ –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:</strong>
              ${jobData.summary.key_points.map(point => `
                <div class="key-point">${point}</div>
              `).join('')}
            </div>
          ` : ''}
          ${jobData.summary.action_items && jobData.summary.action_items.length > 0 ? `
            <div style="margin-top:12px;">
              <strong>‚úÖ –ó–∞–¥–∞—á–∏ –∏ –¥–µ–π—Å—Ç–≤–∏—è:</strong>
              ${jobData.summary.action_items.map(item => `
                <div class="action-item">
                  <strong>${item.owner || '–ù–µ —É–∫–∞–∑–∞–Ω'}</strong>: ${item.task || '–ó–∞–¥–∞—á–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
                  ${item.due ? `<br><small>–°—Ä–æ–∫: ${item.due}</small>` : ''}
                </div>
              `).join('')}
            </div>
          ` : ''}
          ${jobData.summary.risks && jobData.summary.risks.length > 0 ? `
            <div style="margin-top:12px;">
              <strong>‚ö†Ô∏è –†–∏—Å–∫–∏:</strong>
              ${jobData.summary.risks.map(risk => `
                <div class="risk-item">${risk}</div>
              `).join('')}
            </div>
          ` : ''}
          ${jobData.summary.raw && !jobData.summary.meeting_summary ? `
            <div style="background:#f5f5f5;padding:12px;border-radius:6px;">
              <strong>üìÑ –°—ã—Ä–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:</strong><br>
              <pre style="white-space:pre-wrap;margin:8px 0;font-size:12px;">${jobData.summary.raw}</pre>
            </div>
          ` : ''}
        </div>
      `;
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
    contentHtml += `
      <div style="text-align:center;margin-top:20px;border-top:1px solid #e0e0e0;padding-top:16px;">
        <button onclick="downloadJobResult('${jobData.job_id}')" style="background:#4CAF50;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;margin-right:8px;">
          üì• –°–∫–∞—á–∞—Ç—å JSON
        </button>
        <button onclick="this.closest('.modal-overlay').remove()" style="background:#666;color:white;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;">
          –ó–∞–∫—Ä—ã—Ç—å
        </button>
      </div>
    `;
    
    modalContent.innerHTML = contentHtml;
    modal.appendChild(modalContent);
    modal.className = 'modal-overlay';
    
    document.body.appendChild(modal);
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.remove();
      }
    });
  }

  // ====== –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ò–°–¢–û–†–ò–ò ======
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
  $('#btnLoadHistory').onclick = async () => {
    if (!await checkAuth()) {
      showNotification('‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API –∫–ª—é—á –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é');
      return;
    }
    
    await loadHistory();
  };
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—á–∏—Å—Ç–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
  $('#btnClearHistory').onclick = () => {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é?')) {
      document.getElementById('historyList').innerHTML = '';
      document.getElementById('historyContainer').style.display = 'none';
      showNotification('üóëÔ∏è –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞');
    }
  };
  
  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏
  async function loadHistory() {
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      const apiKey = $('#apiKey').value;
      
      showNotification('üìö –ó–∞–≥—Ä—É–∂–∞—é –∏—Å—Ç–æ—Ä–∏—é...');
      
      const response = await fetch(`${apiBase}/history`, {
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const data = await response.json();
      displayHistory(data.jobs);
      
      showNotification(`üìö –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${data.jobs.length} –∑–∞–¥–∞—á`);
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}`);
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏
  function displayHistory(jobs) {
    const historyList = document.getElementById('historyList');
    const historyContainer = document.getElementById('historyContainer');
    
    if (jobs.length === 0) {
      historyList.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</div>';
      historyContainer.style.display = 'block';
      return;
    }
    
    let historyHtml = '';
    
    jobs.forEach(job => {
      const statusClass = getStatusClass(job.status);
      const statusText = getStatusText(job.status);
      const createdAt = job.created_at ? new Date(job.created_at * 1000).toLocaleString('ru-RU') : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
      
      historyHtml += `
        <div class="history-item" style="border:1px solid #e0e0e0;border-radius:8px;padding:16px;margin:12px 0;background:#fafafa;">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <div>
              <strong>üìÅ ${job.filename || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}</strong>
              <div style="font-size:12px;color:#666;margin-top:4px;">
                Job ID: ${job.job_id}<br>
                –Ø–∑—ã–∫: ${job.language || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                –°–æ–∑–¥–∞–Ω–æ: ${createdAt}
              </div>
            </div>
            <div style="text-align:right;">
              <span class="status-badge ${statusClass}">${statusText}</span>
              <div style="font-size:12px;color:#666;margin-top:4px;">
                ${job.has_transcript ? '‚úÖ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç' : '‚ùå –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç'}<br>
                ${job.has_summary ? '‚úÖ –°–∞–º–º–∞—Ä–∏' : '‚ùå –°–∞–º–º–∞—Ä–∏'}
              </div>
            </div>
          </div>
          
          <div style="display:flex;gap:8px;justify-content:center;">
            <button onclick="viewJobDetails('${job.job_id}')" style="background:#2196F3;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
              üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å
            </button>
            <button onclick="downloadJobResult('${job.job_id}')" style="background:#4CAF50;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
              üì• –°–∫–∞—á–∞—Ç—å
            </button>
            <button onclick="deleteJob('${job.job_id}')" style="background:#f44336;color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;">
              üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
            </button>
          </div>
        </div>
      `;
    });
    
    historyList.innerHTML = historyHtml;
    historyContainer.style.display = 'block';
  }
  
  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å–æ–≤
  function getStatusClass(status) {
    switch (status) {
      case 'done': return 'status-done';
      case 'transcribed_waiting_summary': return 'status-waiting';
      case 'processing': return 'status-processing';
      default: return 'status-unknown';
    }
  }
  
  function getStatusText(status) {
    switch (status) {
      case 'done': return '‚úÖ –ì–æ—Ç–æ–≤–æ';
      case 'transcribed_waiting_summary': return '‚è≥ –û–∂–∏–¥–∞–µ—Ç —Å–∞–º–º–∞—Ä–∏';
      case 'processing': return 'üîÑ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è';
      default: return '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
    }
  }
  
  // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∏—Å—Ç–æ—Ä–∏–∏
  window.viewJobDetails = async function(jobId) {
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      const apiKey = $('#apiKey').value;
      
      const response = await fetch(`${apiBase}/history/${jobId}`, {
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const jobData = await response.json();
      showJobDetailsModal(jobData);
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π –∑–∞–¥–∞—á–∏:', error);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π: ${error.message}`);
    }
  };
  
  window.downloadJobResult = async function(jobId) {
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      const apiKey = $('#apiKey').value;
      
      const response = await fetch(`${apiBase}/history/${jobId}`, {
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      const jobData = await response.json();
      
      // –°–æ–∑–¥–∞–µ–º –∏ —Å–∫–∞—á–∏–≤–∞–µ–º JSON —Ñ–∞–π–ª
      const blob = new Blob([JSON.stringify(jobData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `job_${jobId}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification('üì• –§–∞–π–ª —Å–∫–∞—á–∞–Ω');
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è:', error);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: ${error.message}`);
    }
  };
  
  window.deleteJob = async function(jobId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–¥–∞—á—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
      return;
    }
    
    try {
      const apiBase = apiBaseInput.value || `${location.protocol}//${location.host}`;
      const apiKey = $('#apiKey').value;
      
      const response = await fetch(`${apiBase}/history/${jobId}`, {
        method: 'DELETE',
        headers: {
          'Authorization': `Bearer ${apiKey}`
        }
      });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      
      showNotification('üóëÔ∏è –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
      await loadHistory();
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
      showNotification(`‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ${error.message}`);
    }
  };
})();
</script>
</body>
</html>
